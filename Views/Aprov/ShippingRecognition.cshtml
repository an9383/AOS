@using System.Data
@using HACCP.Libs.Views
@{
    Layout = null;
    ViewBag.Title = "ShippingRecognition";
}

@{
    var ShippingRecognitionData = @Html.Raw(Json.Encode(ViewBag.ShippingRecognitionData.Data));
    var ShippingRecognitionAuth = @Html.Raw(Json.Encode(ViewBag.ShippingRecognitionAuth.Data));

    var SR_itemCDJson = @Html.Raw(Json.Encode(ViewBag.SR_itemCD.Data));
}

@{
    var SR_SelectBox = new[] {
        new { keyfield = "Y", displayfield = "Y" },
        new { keyfield = "N", displayfield = "N" }
    };
}

<script type="text/javascript" id="ShippingRecognitionJs">

    // SP 구문, gubun 변수
    var SRLD_curdGubun = "";

    //출하승인 점검 Grid 변경 data
    var SRLD_checkList = new Array();

    // 메뉴 권한
    var _ShippingRecognitionAuth;
    // 전자 서명 구분 값
    var SRLD_signGubun = "";
    // 전자서명 임시 데이터
    var _shippingRecognitionSignData;

    $(function () {

        if (@ShippingRecognitionData !== "") {
            $("#ShippingRecognition_LeftUpGrid").dxDataGrid("instance").option("dataSource", JSON.parse(@ShippingRecognitionData));
            $("#ShippingRecognition_LeftUpGrid").dxDataGrid("instance").option("focusedRowEnabled", true);
            $("#ShippingRecognition_LeftUpGrid").dxDataGrid("instance").option("focusedRowIndex", 0);
        }

        // 수정중인지 체크
        ShippingRecognitionEditCheck(false);

        // 사용자 권한
        _ShippingRecognitionAuth = JSON.parse(@ShippingRecognitionAuth)[0];

        if (_ShippingRecognitionAuth.form_query != "Y") {
            $("#ShippingRecognitionSearch").remove();
        }

        setDatePicker("#ShippingRecognition .datepicker");

        /* (검색) 제품 팝업 */
        var SR_itemCDPopup_Data = @SR_itemCDJson;

        var columns1 = [
            { dataField: "item_cd", caption: "제품코드" },
            { dataField: "item_nm", caption: "제품명" }
        ];

        createPopup("SR_itemCD", "제품 조회", SR_itemCDPopup_Data, columns1, "item_cd");

    });

    function ShippingRecognitionEditCheck(nowEdit) {

        // 입력/수정중일 때
        if (nowEdit) {
            $("#ShippingRecognitionUndo").dxButton().parent().parent().removeClass("display-none");
            $("#ShippingRecognitionSearch").dxButton().parent().parent().addClass("display-none");
            $("#ShippingRecognitionSave").dxButton().parent().parent().removeClass("display-none");
            $("#ShippingRecognitionEdit").dxButton().parent().parent().addClass("display-none");
            $("#ShippingRecognitionExcel").dxButton().parent().parent().addClass("display-none");
            $("#ShippingRecognitionPrint").dxButton().parent().parent().addClass("display-none");
            $("#ShippingRecognitionPreview").dxButton().parent().parent().addClass("display-none");

            $("#ShippingRecognition_LeftUpGrid").dxDataGrid("option", "disabled", true);
            $("#ShippingRecognitionSignTable").dxDataGrid("option", "disabled", true);

            $("#ShippingRecognition_Form_RightUp :disabled").attr('disabled', false);
            $("#ShippingRecognition_Form_RightUp input[name=approval_date]").prop('readonly', false); // 승인일자
            $("#SRLD_check_All").attr('disabled', false);   //전체선택
        }
        if (!nowEdit) {
            $("#ShippingRecognitionUndo").dxButton().parent().parent().addClass("display-none");
            $("#ShippingRecognitionSearch").dxButton().parent().parent().removeClass("display-none");
            $("#ShippingRecognitionSave").dxButton().parent().parent().addClass("display-none");
            $("#ShippingRecognitionEdit").dxButton().parent().parent().removeClass("display-none");
            $("#ShippingRecognitionExcel").dxButton().parent().parent().removeClass("display-none");
            $("#ShippingRecognitionPrint").dxButton().parent().parent().removeClass("display-none");
            $("#ShippingRecognitionPreview").dxButton().parent().parent().removeClass("display-none");

            $("#ShippingRecognition_LeftUpGrid").dxDataGrid("option", "disabled", false);
            $("#ShippingRecognitionSignTable").dxDataGrid("option", "disabled", false);

            $("#ShippingRecognition_Form_RightUp :enabled").attr('disabled', true);
            $("#ShippingRecognition_Form_RightUp input[name=approval_date]").prop('readonly', true); // 승인일자
            $("#SRLD_check_All").attr('disabled', true);    //전체선택
        }
    }

    // 좌측 위 그리드 체인지
    function ShippingRecognition_UpGrid_changed() {

        // 오른쪽 아래 그리드 초기화        
        $("input[type=checkbox]").prop("checked", false);   //전체선택 체크박스 해제
        $("#ShippingRecognitionSignTable").dxDataGrid("instance").option("dataSource", []);
        $("#ShippingRecognition_Form_RightUp")[0].reset();

        // 검색 조회 할 때
        /*if (SRLD_curdGubun === "S") {

            SRLD_curdGubun = "";
            return;
        }*/

        SRLD_curdGubun = "";

        if ($("#ShippingRecognition_LeftUpGrid").dxDataGrid("instance").option("focusedRowIndex") < 0) {
            
            return;
        }

        var grid = $("#ShippingRecognition_LeftUpGrid").dxDataGrid("instance");
        var gridData = getGridRowByKey('ShippingRecognition_LeftUpGrid', grid.option("focusedRowKey"));

        /* 오른쪽 위 폼 데이터 셋팅 */

        $("#ShippingRecognition input[name=item_nm]").val(gridData.item_nm); // 제품명
        $("#ShippingRecognition input[name=lot_no]").val(gridData.lot_no); // 제조번호
        $("#ShippingRecognition input[name=lot_date]").val(gridData.lot_date); // 제조일자
        $("#ShippingRecognition input[name=item_validity_period]").val(gridData.item_validity_period); // 유통기한
        $("#ShippingRecognition input[name=pack_unit]").val(gridData.pack_unit); // 포장단위
        $("#ShippingRecognition input[name=request_qty_unit]").val(gridData.request_qty + ' ' + gridData.request_unit); // 의뢰수량
        $("#ShippingRecognition input[name=test_no]").val(gridData.test_no); // 시험번호
        $("#ShippingRecognition input[name=approval_date]").val(gridData.approval_date); // 승인일자

        SelectShippingItemImage(); //제품이미지 조회

        /* 오른쪽 아래 그리드 셋팅 */
        $.ajax({
            type: 'POST',
            url: '/Aprov/ShippingRecognition_SE_Grid',
            data: {
                shipping_cd: gridData.shipping_cd
            },
            success: function (result) {

                if (result.length <= 0) {
                    return;
                }

                var ArrayCheck = Array.isArray(result);

                if (!ArrayCheck && JSON.parse(result).sessionLoss) {
                    alert("세션이 만료되었습니다.");
                    sessionStorage.clear();
                    location.replace("/Comm/Login");
                }

                /* 아래 오른쪽 그리드 데이터 */
                if (result[0] != "") {
                    $("#ShippingRecognitionSignTable").dxDataGrid("instance").option("dataSource", JSON.parse(result));
                }

                /* 아래 왼쪽 그리드 데이터 */
                ShippingRecognitionSignTable_changed(gridData.shipping_cd);

            }
        });
    }

    /* 아래 왼쪽 그리드 데이터 */
    function ShippingRecognitionSignTable_changed(shipping_cd) {

        // 왼쪽 아래 그리드 초기화
        $("#ShippingRecognition_LeftDownGrid").dxDataGrid("instance").option("dataSource", []);

        $.ajax({
            type: 'POST',
            url: '/Aprov/ShippingRecognition_S2_Grid',
            data: {
                shipping_cd: shipping_cd
            },
            success: function (result) {

                if (result.length <= 0) {
                    return;
                }

                var ArrayCheck = Array.isArray(result);

                if (!ArrayCheck && JSON.parse(result).sessionLoss) {
                    alert("세션이 만료되었습니다.");
                    sessionStorage.clear();
                    location.replace("/Comm/Login");
                }

                /* 아래 오른쪽 그리드 데이터 */
                if (result[0] != "") {
                    $("#ShippingRecognition_LeftDownGrid").dxDataGrid("instance").option("dataSource", JSON.parse(result));
                }

            }
        });

    }

    /* CRUD 시작 */

    // 조회
    function ShippingRecognitionSearch() {

        SRLD_curdGubun = "S";

        // 초기화


        ShippingRecognitionEditCheck(false);

        $("#ShippingRecognition_LeftUpGrid").dxDataGrid("instance").option("dataSource", []);
        //$("#ShippingRecognition_LeftUpGrid").dxDataGrid("instance").option("focusedRowIndex", -1);

        var editing = {
            allowUpdating: false
        }

        $("#ShippingRecognition_LeftDownGrid").dxDataGrid("option", "editing", editing);

        // **********************************************************

        var formData = new FormData($("#ShippingRecognition_form")[0]);

        $.ajax({
            type: 'POST',
            url: '/Aprov/ShippingRecognition_Select_Grid',
            data: formData,
            contentType: false,
            processData: false,
            success: function (result) {

                // 검색 결과가 없을 경우
                if (result.length <= 0) {
                    $("#ShippingRecognition_LeftUpGrid").dxDataGrid("instance").option("dataSource", []);
                    //$("#ShippingRecognition_LeftUpGrid").dxDataGrid("instance").option("focusedRowIndex", -1);

                    $("#ShippingRecognitionSignTable").dxDataGrid("instance").option("dataSource", []);
                    $("#ShippingRecognition_LeftDownGrid").dxDataGrid("instance").option("dataSource", []);
                    $("#ShippingRecognition_Form_RightUp")[0].reset();
                    return;
                }

                var json = JSON.parse(result);

                if (json.hasOwnProperty('sessionLoss')) {
                    alert("세션이 만료되었습니다.");
                    sessionStorage.clear();
                    location.replace("/Comm/Login");
                }

                $("#ShippingRecognition_LeftUpGrid").dxDataGrid("instance").option("dataSource", JSON.parse(result));
                //$("#ShippingRecognition_LeftUpGrid").dxDataGrid("instance").option("focusedRowEnabled", true);
                //$("#ShippingRecognition_LeftUpGrid").dxDataGrid("instance").option("focusedRowIndex", 0);
                UtilView.setGridFocus("G", "ShippingRecognition_LeftUpGrid");

                //ShippingRecognition_UpGrid_changed();
            }
        });

    }

    // 취소
    function ShippingRecognitionUndo() {

        ShippingRecognitionEditCheck(false);
        SRLD_curdGubun = "";
        SRLD_checkList = new Array();

        $("#ShippingRecognition_Form_RightUp")[0].reset();
        $("#ShippingRecognition_LeftDownGrid").dxDataGrid("instance").option("dataSource", []);

        var editing = {
            allowUpdating: false
        }

        $("#ShippingRecognition_LeftDownGrid").dxDataGrid("option", "editing", editing);

        ShippingRecognitionSearch();
    }

    // 수정
    function ShippingRecognitionEdit() {

        var grid = $("#ShippingRecognition_LeftUpGrid").dxDataGrid("instance");

        if (grid.option("dataSource") == null || grid.option("dataSource").length === 0) {
            alert("제품을 선택해 주세요.");
            return;
        }

        var gridData = getGridRowByKey('ShippingRecognition_LeftUpGrid', grid.option("focusedRowKey"));

        if (gridData.shipping_status !== null && gridData.shipping_status === "2") {
            alert("이미 승인된 품목입니다.");
            return;
        }

        SRLD_curdGubun = "U";

        ShippingRecognitionEditCheck(true);

        var editing = {
            allowUpdating: true,
            mode: 'batch'
        }

        $("#ShippingRecognition_LeftDownGrid").dxDataGrid("option", "editing", editing);


    }

    // 저장
    function ShippingRecognitionSave() {
        var grid = $("#ShippingRecognition_LeftUpGrid").dxDataGrid("instance");
        var gridData = getGridRowByKey('ShippingRecognition_LeftUpGrid', grid.option("focusedRowKey"));

        var formData = new FormData($("#ShippingRecognition_Form_RightUp")[0]);
        formData.set("gubun", "U_date");
        formData.set("shipping_cd", gridData.shipping_cd);

        var approval_date = $("#ShippingRecognition input[name=approval_date]").val();
        if (approval_date == null || approval_date === "") {
            alert("승인일자를 선택해 주세요.");
            $("#ShippingRecognition input[name=approval_date]").focus();
            return;
        }        

        $.ajax({
            type: 'POST',
            url: '/Aprov/ShippingRecognition_TRX',
            data: formData,
            contentType: false,
            processData: false,            
            success: async function (result) {
                
                if (!$("#ShippingRecognition_LeftDownGrid").dxDataGrid("instance").hasEditData()) {
                    alert("저장되었습니다.");
                    ShippingRecognitionEditCheck(false);
                    ShippingRecognitionSearch();
                } else {    
                    await $("#ShippingRecognition_LeftDownGrid").dxDataGrid("instance").saveEditData();
                    ShippingRecognition_check();
                }
            }
        });

    }

    //점검표 저장
    function ShippingRecognition_check() {

        $.ajax({
            type: 'POST',
            url: '/Aprov/ShippingRecognition_batch',
            data: {
                model: JSON.stringify(SRLD_checkList)
            },
            async: false,
            success: function (result) {
                alert("저장되었습니다.");
                SRLD_curdGubun = "";
                SRLD_checkList = new Array();
                ShippingRecognitionEditCheck(false);

                //ShippingRecognitionSignTable_changed(_shipping_cd);
                ShippingRecognitionSearch();
            }
        }).fail(function (data) {
            alert("Failed: " + data.response);
        });

    }

    // 엑셀 다운로드
    function ShippingRecognitionExcel(gridName, ExcelName) {
        gridExportToExcel("ShippingRecognition_LeftUpGrid", "출하승인");
    }

    /* CRUD 종료 */

    /* 전자서명 */

    // 전자서명 테이블 클릭
    function ShippingRecognitionSign(e) {

        //var datagrid = $("#ShippingRecognition_LeftDownGrid").dxDataGrid("instance");
        //var gridData = datagrid.option("dataSource");

        //for (var i = 0; i < gridData.length; i++) {

        //    var data = gridData[i];

        //    if (data.check_yn !== "Y") {
        //        alert("체크리스트를 확인하세요.");
        //        return false;
        //    }

        //}

        //최종 서명자 일 경우, 최종 체크리스트 사항 저장해야함.
        var grid = $("#ShippingRecognitionSignTable").dxDataGrid("instance");
        var gridData = grid.option("dataSource");

        if (gridData.length == e.data.sign_set_dt_seq) {
            var approval_date = $("#ShippingRecognition input[name=approval_date]").val();

            if (approval_date == null || approval_date === "") {
                alert("수정버튼을 눌러 승인일자를 설정해주세요.");
                return;
            }
        }

        _shippingRecognitionSignData = e.data;

        if (e.columnIndex == 3) {
            SRLD_signGubun = "EI";

            if (e.data.prev_sign_yn == "0") {
                alert("먼저 앞 단계 승인이 필요합니다.");
                return;
            }

            if (e.data.sign_yn == "1") {
                if (confirm("이미 승인 되었습니다. 서명을 삭제하시겠습니까?")) {
                    SRLD_signGubun = "ED";
                } else {
                    return;
                }

                if (e.data.next_sign_yn == "1") {
                    alert("이미 다음 단계가 승인 되어 있습니다.\n먼저 다음 단계 승인을 삭제(취소)해주세요. ");
                    return;
                }
            }

            var popup = $("#ShippingRecognitionSignPopup").dxPopup("instance");
            popup.option("contentTemplate", $("#ShippingRecognitionTemplate"));
            popup.show();

        }
    }

    // 서명 권한 체크(id, pw)
    function ShippingRecognitionSubmit() {

        var data = new FormData($('#ShippingRecognitionSignForm')[0]);
        
        var grid = $("#ShippingRecognition_LeftUpGrid").dxDataGrid("instance");
        var gridData = getGridRowByKey('ShippingRecognition_LeftUpGrid', grid.option("focusedRowKey"));

        var _shipping_cd = gridData.shipping_cd;

        var datagrid = $("#ShippingRecognitionSignTable").dxDataGrid("instance");

        data.set("gubun", "S");

        $.ajax({
            type: 'POST',
            url: '/Comm/IDValidation',
            data: data,
            contentType: false,
            processData: false,
            success: function (result) {

                if (result.length <= 0) {

                    alert("권한이 없는 사용자이거나 잘못된 ID,PW 입니다.");
                    return;
                }

                $("#ShippingRecognitionSignPopup input[name='dept_nm']").val(JSON.parse(result)[0].dept_nm);
                $("#ShippingRecognitionSignPopup input[name='emp_nm']").val(JSON.parse(result)[0].emp_nm);

                var isOK = false;

                if (_shippingRecognitionSignData.responsible_emp_cd !== JSON.parse(result)[0].emp_cd) {

                    $.ajax({
                        type: 'GET',
                        url: '/Comm/DelegateCheck',
                        data: {
                            emp_cd: JSON.parse(result)[0].emp_cd,
                            sign_set_cd: "3001",
                            sign_set_seq: _shippingRecognitionSignData.sign_set_dt_seq
                        },
                        async: false,
                        success: function (result) {

                            if (result.length > 0) {
                                isOK = true;
                            } else {
                                isOK = false;
                            }
                        }
                    });
                } else {
                    isOK = true;
                }

                if (!isOK) {
                    alert("권한이 없는 사용자입니다.");
                    return;
                }

                if (isOK) {
                    setTimeout(function () {
                        $.ajax({
                            type: 'POST',
                            url: '/Aprov/SignCRUD',
                            async: false,
                            data: {
                                gubun: SRLD_signGubun,
                                shipping_cd: _shipping_cd,
                                emp_cd: JSON.parse(result)[0].emp_cd,
                                sign_set_dt_id: datagrid.getSelectedRowsData()[0].sign_set_dt_id,
                                representative_yn: "Y",
                                validation_type: "2"
                            },
                            success: function (result) {

                                if (SRLD_signGubun == "EI") {
                                    alert("전자서명 되었습니다.");
                                } else if (SRLD_signGubun == "ED") {
                                    alert("전자서명 삭제되었습니다.");
                                }
                                
                                ShippingRecognitionSearch();
                            }
                        });

                        SRLD_signGubun = "";

                        var popup = $("#ShippingRecognitionSignPopup").dxPopup("instance");
                        popup.hide();
                    }, 1000);
                }
            }
        });

    }


    // 서명 인풋 초기화
    function SR_ClearSignInput() {
        $('#ShippingRecognitionSignForm')[0].reset();
        $("#ShippingRecognitionSignPopup input[name='dept_nm']").val("");
        $("#ShippingRecognitionSignPopup input[name='emp_nm']").val("");
    }

    // 좌측 위 그리드 체인지
    function ShippingRecognition_sign_changed() {

        // 오른쪽 아래 그리드 초기화
        //$("#ShippingRecognitionSignTable").dxDataGrid("instance").option("dataSource", []);

        var grid = $("#ShippingRecognition_LeftUpGrid").dxDataGrid("instance");
        var gridData = getGridRowByKey('ShippingRecognition_LeftUpGrid', grid.option("focusedRowKey"));

        /* 오른쪽 아래 그리드 셋팅 */
        $.ajax({
            type: 'POST',
            url: '/Aprov/ShippingRecognition_SE_Grid',
            data: {
                shipping_cd: gridData.shipping_cd
            },
            success: function (result) {

                if (result.length <= 0) {
                    $("#ShippingRecognitionSignTable").dxDataGrid("instance").option("dataSource", []);
                    return;
                }

                var ArrayCheck = Array.isArray(result);

                if (!ArrayCheck && JSON.parse(result).sessionLoss) {
                    alert("세션이 만료되었습니다.");
                    sessionStorage.clear();
                    location.replace("/Comm/Login");
                }

                /* 아래 오른쪽 그리드 데이터 */
                $("#ShippingRecognitionSignTable").dxDataGrid("instance").option("dataSource", JSON.parse(result));


            }
        });
    }

    /* 전자서명 종료 */

    // (검색) 제품 팝업
    function SearchSR_itemCD() {

        var popup = $("#SR_itemCDPopup").dxPopup("instance");

        popup.show();
    }

    // (검색) 제품 더블클릭
    function SR_itemCDRowDblClick(selectedItems) {

        var data = selectedItems.data;

        $("#ShippingRecognition input[name=item_cd_S]").val(data.item_cd);
        $("#ShippingRecognition input[name=item_nm_S]").val(data.item_nm);

        var popup = $("#SR_itemCDPopup").dxPopup("instance");
        popup.hide();
    }

    // 클릭 이벤트 제한
    function SRLD_EditableColumn(cellElement, cellInfo) {

        if (cellElement.column.dataField === 'check_item_nm')
            cellElement.element.find('input').prop('readonly', true);
    }

    //저장 버튼 비활성화
    function SRLD_ToolbarEdit(e) {
        var toolbarItems = e.toolbarOptions.items;

        $.each(toolbarItems, function (_, item) {
            if (item.name == "saveButton") {
                item.visible = false;
            }
        })
    }

    //출하승인 점검 editing 모드 
    function ShippingRecognition_Update(info) {
        ShippingRecognitionEditCheck(true);
        var data = info.data;
    
        //var approval_date = $("#ShippingRecognition input[name=approval_date]").val();

        //data.approval_date = approval_date;
        data.gubun = SRLD_curdGubun;

        SRLD_checkList.push(data);
    }

    //출하승인 전체선택
    function SRLD_checkAll() {

        var grid = $("#ShippingRecognition_LeftDownGrid").dxDataGrid("instance");
        var gridData = grid.option("dataSource");

        if ($("#SRLD_check_All").prop("checked")) {
            for (var i = 0; i < gridData.length; i++) {
                grid.cellValue(i, "check_yn", "Y");
            }
        } else {
            for (var i = 0; i < gridData.length; i++) {
                grid.cellValue(i, "check_yn", "N");
            }
        }
    }

    // 프린트
    function ShippingRecognitionPrint() {

        var report = new ReportHelper($(event.target));

        if ($("#ShippingRecognition_LeftUpGrid").dxDataGrid("instance").option("focusedRowIndex") < 0) {
            alert("프린트 대상이 없습니다.");
            return;
        }

        var grid = $("#ShippingRecognition_LeftUpGrid").dxDataGrid("instance");
        var gridData = getGridRowByKey('ShippingRecognition_LeftUpGrid', grid.option("focusedRowKey"));

        var reportParam = "shipping_cd:" + gridData.shipping_cd;

        report.addParam({
            objFile: { path: "Aprov", RptFileName: "rptShippingRecognition" },
            objSp: { SpName: "SP_ShippingRecognition", gubun: "RS", reportParam: reportParam },
            objEtcInfo: { subParam: "", viewerName: "", nCopies: 1 }            
            //sub report필요시, 아래주석을 풀어서 사용한다.
            //objSub: { subRptName: "Process,FinishDate,OrderQty,OrderQty2,Receive,ReceiveEA,Real,RealEA,Rate,Rate2,Remark" },
        });

        report.testObj();
        report.run();
    }

    //출하승인 이미지 업로드

    function SelectShippingItemImage() {

        var grid = $("#ShippingRecognition_LeftUpGrid").dxDataGrid("instance");
        var gridData = getGridRowByKey('ShippingRecognition_LeftUpGrid', grid.option("focusedRowKey"));

        $.ajax({
            type: 'POST',
            url: '/Aprov/SelectShippingItemImage',
            data: {
                shipping_cd: gridData.shipping_cd
            },
            success: function (result) {

                try {

                    var jsonData = JSON.parse(result);

                    $("#ShippingItemImage").attr('src', jsonData[0].shipping_image);


                } catch (e) {

                    $("#ShippingItemImage").attr('src', '/Content/image/defaultImage.png');
                }


            }
        })
    }


    function UploadShippingImage(e) {
        var grid = $("#ShippingRecognition_LeftUpGrid").dxDataGrid("instance");
        var gridData = getGridRowByKey('ShippingRecognition_LeftUpGrid', grid.option("focusedRowKey"));

        var url = e.component.option("uploadUrl");
        url = updateQueryStringParameter(url, "shipping_cd", gridData.shipping_cd);

        e.component.option("uploadUrl", url);
    }

    $("#ShippingItemUploadBtn").click(function (event) {
        var fileUploader = $('#ShippingRecognition_ImageUploader').dxFileUploader('instance');

        fileUploader._isCustomClickEvent = true;
        fileUploader._$fileInput.click();
    });

    $("#ShippingItemDeleteBtn").click(function (event) {

        var isOK = confirm("제품 이미지를 삭제하시겠습니까?");

        if (!isOK) {
            return;
        }

        var grid = $("#ShippingRecognition_LeftUpGrid").dxDataGrid("instance");
        var gridData = getGridRowByKey('ShippingRecognition_LeftUpGrid', grid.option("focusedRowKey"));

        $.ajax({
            type: 'POST',
            url: '/Aprov/DeleteShippingItemImage',
            data: {
                shipping_cd: gridData.shipping_cd
            },
            success: function (result) {

                ShippingRecognitionSearch();
            }
        })

    });

</script>

<div id="ShippingRecognition" autoresize="Y">

    @* 팝업 *@
    <div id="SR_itemCDPopup"></div>

    @* === 전자 서명 팝업 === *@
    @(Html.DevExtreme().Popup()
        .ID("ShippingRecognitionSignPopup")
        .Width(500)
        .Height(420)
        .ShowTitle(true)
        .Title("작업자 인증")
        .OnHidden("SR_ClearSignInput")
        .Visible(false)
        .DragEnabled(true)
        .CloseOnOutsideClick(false)
    )

    @using (Html.DevExtreme().NamedTemplate("ShippingRecognitionTemplate"))
    {
        <h6>전자서명은 수기서명과 동일한 효력을 갖습니다.</h6>

        <form id="ShippingRecognitionSignForm">

            <div class="input-wrapper">
                <label class="col-3">아이디</label>
                <input type="text" class="col-8 form-control" name="txt_ID">

                <label class="col-3">비밀번호</label>
                <input type="password" class="col-8 form-control" name="txt_Pass">
            </div>

        </form>
        <div class="align-content-end">
            <button onclick="ShippingRecognitionSubmit()" style="float: right; margin-right: 8%;">확인</button>
        </div>

        <br />
        <hr />

        <label class="col-3">부서</label>
        <input type="text" class="col-8 form-control" name="dept_nm" readonly="readonly" />
        <label class="col-3">성명</label>
        <input type="text" class="col-8 form-control" name="emp_nm" readonly="readonly" />
    }

    @* === 전자 서명 팝업 종료 === *@

    <div class="mainTop row">

        <!-- $검색폼-->
        <div class="col-8">

            <form id="ShippingRecognition_form">

                <div class="input-wrapper">

                    <div class="col-5 input-group input-group-sm">
                        <div class="input-group-prepend">
                            <span class="input-group-text">기간</span>
                        </div>
                        <select class="form-control" name="date_type_s">
                            <option value="0" selected>의뢰일자</option>
                            <option value="1">승인일자</option>
                        </select>
                        <input type="text" class="form-control datepicker text-center" name="start_date_S" value="@DateTime.Today.AddDays(-90).ToShortDateString()">
                        <label class="p-1">~</label>
                        <input type="text" class="form-control input-sm datepicker text-center" name="end_date_S" value="@DateTime.Today.ToShortDateString()">

                    </div>

                    <div class="input-group input-group-sm col-3">
                        <div class="input-group-prepend">
                            <span class="input-group-text">제품</span>
                        </div>
                        <input type="text" class="form-control" name="item_nm_S" >
                        <div class="input-group-append">
                            <button class="btn btn-outline-secondary" type="button" onclick="SearchSR_itemCD()">찾기</button>
                        </div>
                        <input type="hidden" class="form-control" name="item_cd_S">
                    </div>

                    <div class="input-group input-group-sm col-2">
                        <div class="input-group-prepend">
                            <span class="input-group-text">상태</span>
                        </div>
                        <select class="form-control" name="status_S">
                            @foreach (DataRow row in ((DataTable)ViewBag.search_status).Rows)
                            {
                                <option value="@row["keyfield"]">@row["displayfield"]</option>
                            }
                        </select>
                    </div>

                </div>

            </form>

        </div>

        <!-- $CRUD버튼-->
        <div class="CRUD-btn col-4">
            @{Html.SetToolbar(0, true, "Search;Edit;Save;Undo;Excel;Print;Preview");}
        </div>

    </div>


    <div class="row">

        <!-- 좌측 위 그리드 -->
        <div class="col-7 pr-1 pb-1">

            <div class="box mb-0">

                @(Html.DevExtreme().DataGrid()
                    .ID("ShippingRecognition_LeftUpGrid")
                    .ShowBorders(true)
                    .SearchPanel(searchPanel => searchPanel.Visible(true))
                    .Selection(s => s.Mode(SelectionMode.Single))
                    .Scrolling(scrolling => scrolling.Mode(GridScrollingMode.Virtual).ShowScrollbar(ShowScrollbarMode.Always))
                    .ColumnAutoWidth(true)
                    .AllowColumnResizing(true)
                    .HoverStateEnabled(true)
                    .ShowColumnLines(true)
                    .Export(e => e.Enabled(true).AllowExportSelectedData(true))
                    .OnToolbarPreparing("HideToolbarButton")
                    .KeyExpr("shipping_cd")
                    .Height(500)
                    .Columns(c =>
                    {
                        c.Add().DataField("request_date").Caption("의뢰일자");
                        c.Add().DataField("item_nm").Caption("제품명");
                        c.Add().DataField("pack_unit").Caption("포장단위").Alignment(HorizontalAlignment.Center);
                        c.Add().DataField("lot_no").Caption("제조번호");
                        c.Add().DataField("test_no").Caption("시험번호");
                        c.Add().DataField("request_qty").Caption("의뢰수량").Format("#,##0").DataType(GridColumnDataType.Number);
                        c.Add().DataField("request_unit").Caption("단위").Alignment(HorizontalAlignment.Center);
                        c.Add().DataField("shipping_status_nm").Caption("상태").Alignment(HorizontalAlignment.Center);
                    })
                    .OnFocusedRowChanged("ShippingRecognition_UpGrid_changed")
                )
            </div>

        </div>

        <!-- 우측 위 그리드 -->
        <div class="col-5 pl-0 pb-1">

            <div class="box mb-0">

                <div class="divName">
                    <p>제품 정보</p>
                </div>

                <div class="menuDiv">

                    <form id="ShippingRecognition_Form_RightUp">

                        <div class="input-wrapper">
                            <label class="col-3">제품명</label>
                            <div class="input-group col-8">
                                <input type="text" class="form-control col-6" name="item_nm" readonly="readonly">
                            </div>
                        </div>

                        <div class="input-wrapper">
                            <label class="col-3">제조번호/제조일자</label>
                            <div class="input-group col-4">
                                <input type="text" class="form-control" name="lot_no" readonly="readonly">
                            </div>
                            <div class="input-group col-4">
                                <input type="text" class="form-control" name="lot_date" readonly="readonly">
                            </div>
                        </div>

                        <div class="input-wrapper">
                            <label class="col-3">유통기한</label>
                            <div class="input-group col-8">
                                <input type="text" class="form-control col-6" name="item_validity_period" readonly="readonly">
                            </div>
                        </div>

                        <div class="input-wrapper">
                            <label class="col-3">포장단위</label>
                            <div class="input-group col-8">
                                <input type="text" class="form-control col-6" name="pack_unit" readonly="readonly">
                            </div>
                        </div>

                        <div class="input-wrapper">
                            <label class="col-3">의뢰수량</label>
                            <div class="input-group col-8">
                                <input type="text" class="form-control col-6" name="request_qty_unit" readonly="readonly">
                            </div>
                        </div>

                        <div class="input-wrapper">
                            <label class="col-3">시험번호</label>
                            <div class="input-group col-8">
                                <input type="text" class="form-control col-6" name="test_no" readonly="readonly">
                            </div>
                        </div>

                        <div class="input-wrapper">
                            <label class="col-3">승인일자</label>
                            <div class="input-group col-8">
                                <input type="text" class="form-control col-6 required datepicker" name="approval_date" readonly="readonly">
                            </div>
                        </div>

                    </form>

                    <div class="input-wrapper">
                        <label class="col-2">출하제품이미지</label>
                        <div class="input-group col-7">
                            <img id="ShippingItemImage" src="" alt="" style="width:400px; height:230px;" />
                        </div>
                        <div class="input-group col-2">
                            <button id="ShippingItemUploadBtn" class="btn btn-sm btn-secondary pr-1" type="button">등록</button>
                            <button id="ShippingItemDeleteBtn" class="btn btn-sm btn-secondary pl-1" type="button">삭제</button>
                        </div>
                    </div>

                    @(Html.DevExtreme().FileUploader()
                                .Visible(false)
                                .ID("ShippingRecognition_ImageUploader")
                                .Name("shipping_image")
                                .Multiple(false)
                                .Accept("image/*")
                                .AllowedFileExtensions(new[] { ".jpg", ".jpeg", ".gif", ".png", ".bmp" })
                                .UploadUrl(Url.Action("UploadShippingImage", "Aprov"))
                                .UploadMode(FileUploadMode.Instantly)
                                .MaxFileSize(10000000)
                                .OnValueChanged("UploadShippingImage")
                            .OnUploaded("ShippingRecognitionSearch")
                            )

                </div>

            </div>



        </div>

    </div>


    <div class="row">

        <!-- 좌측 아래 그리드 -->
        <div class="col-7 pr-1">

            <div class="box mb-0">
                <div class="divName">
                    <p>출하승인 점검</p>
                </div>

                <div class="input-wrapper">

                    <label class="col-1">전체선택</label>
                    <label class="p-1"></label>
                    <input type="checkbox" id="SRLD_check_All" name="SRLD_check_All" onclick="SRLD_checkAll()" />
                    
                </div>

                @(Html.DevExtreme().DataGrid()
                    .ID("ShippingRecognition_LeftDownGrid")
                    .ShowBorders(true)
                    .Selection(s => s.Mode(SelectionMode.Single))
                    .Scrolling(scrolling => scrolling.Mode(GridScrollingMode.Virtual).ShowScrollbar(ShowScrollbarMode.Always))
                    .ColumnAutoWidth(true)
                    .AllowColumnResizing(true)
                    .ShowColumnLines(true)
                    .HoverStateEnabled(true)
                    .KeyExpr("check_no")
                    .Height(326)
                    .Editing(editing =>
                    {
                        editing.Mode(GridEditMode.Batch);
                        editing.AllowUpdating(false);
                    })
                    .OnRowUpdated("ShippingRecognition_Update")
                    .Columns(c =>
                    {
                        c.Add().DataField("check_item_nm").Caption("점검항목");
                        c.Add()
                            .DataField("check_yn")
                            .Lookup(lookup => lookup
                                .DataSource(SR_SelectBox)
                                .ValueExpr("keyfield")
                                .DisplayExpr("displayfield")
                            )
                            .Caption("확인").Width(50).Alignment(HorizontalAlignment.Center);
                        c.Add().DataField("check_opinion").Caption("검토의견");
                    })
                    .OnCellPrepared("SRLD_EditableColumn")
                    .OnToolbarPreparing("SRLD_ToolbarEdit")
                )
            </div>


        </div>

        <!-- 우측 아래 그리드 -->
        <div class="col-5 pl-0">

            <div class="box mb-0">

                <div class="divName">
                    <p>전자서명 정보 - 출하승인</p>
                </div>

                @(Html.DevExtreme().DataGrid()
                    .ID("ShippingRecognitionSignTable")
                    .ShowBorders(true)
                    .ShowColumnLines(true)
                    .ShowRowLines(true)
                    .ColumnAutoWidth(true)
                    .AllowColumnResizing(true)
                    .FocusedRowEnabled(true)
                    .FocusedRowIndex(0)
                    .KeyExpr("sign_set_dt_id")
                    .Height(326)
                    .OnCellClick("ShippingRecognitionSign")
                    .Selection(s => s.Mode(SelectionMode.Single))
                    .Scrolling(scrolling => scrolling.Mode(GridScrollingMode.Virtual).ShowScrollbar(ShowScrollbarMode.Always))
                    .Columns(columns =>
                    {
                        columns.Add()
                            .DataField("displayfield")
                            .Caption("구분").Alignment(HorizontalAlignment.Center);
                        columns.Add()
                            .DataField("sign_emp_nm")
                            .Caption("서명자");
                        columns.Add()
                            .DataField("sign_time")
                            .Width(185)
                            .Caption("서명일자");
                        columns.Add()
                            .AllowFiltering(false)
                            .AllowSorting(false)
                            .DataField("sign_image")
                            .Name("sign_image")
                            .Caption("서명")
                            .Width(100)
                            .CellTemplate(@<text>
                                <div>
                                    <img src="<%- value %>" alt="" style="width:80px; height:25px;"/>
                                </div>
                            </text>);
                    })
                )


            </div>

        </div>

    </div>

</div>