@using System.Data
@using HACCP.Libs
@using HACCP.Libs.Views

@{
    var pagePrefix = ViewContext.RouteData.Values["action"].ToString();
    var pageControllerNm = ViewContext.RouteData.Values["controller"].ToString();

    ViewBag.Title = pagePrefix;
    Layout = null;

    //var venderBuy = @Html.Raw(Json.Encode(ViewBag.venderBuy.Data));
    //var itemMaker = @Html.Raw(Json.Encode(ViewBag.itemMaker.Data));
}

@*시험성적서 확인*@

<script id="@(pagePrefix)Js">

    var _testCheckEIsEditing = false;
    var _testCheckESignCnt = 0;
    var _testCheckESignGubun = "";
    var _testCheckESignData = "";

    $(function () {

        /// 팝업설정
        // 필요시, 주석해지
        @*var TestCheckEPopupColumns = {
            "testItem": [{ dataField: "item_cd", caption: "품목코드" }
                , { dataField: "item_nm", caption: "품목명" }
                , { dataField: "process_nm", caption: "공정" }
                , { dataField: "test_type_nm", caption: "시험종류" }
                , { dataField: "test_standard_nm", caption: "규격" }
                , { dataField: "item_form_nm", caption: "제형" }],
            "venderBuy": [{ dataField: "vender_cd", caption: "구입업체코드" }
                , { dataField: "vender_nm", caption: "구입업체명" }],
            "itemMaker": [{ dataField: "vender_cd", caption: "원자재공급처코드" }
                , { dataField: "vender_nm", caption: "원자재공급처명" }]
        };

        createPopup("TestCheckEItem", "시험품목 조회", [], TestCheckEPopupColumns.testItem);
        createPopup("TestCheckEVender", "구입업체 조회", @venderBuy, TestCheckEPopupColumns.venderBuy);
        createPopup("TestCheckEMaker", "원자재공급처 조회", @itemMaker, TestCheckEPopupColumns.itemMaker);*@

        // 시험종류 셀렉트 박스 값에 따라 의뢰품목 팝업 그리드 데이터 변경
        //$("#TestCheckEItemPopup").dxPopup({
        //    onShown: function (e) {

        //        var test_type = $("#testCheckEWriteForm select[name=test_type]").val();

        //        $.ajax({
        //            type: 'GET',
        //            url: '/TestReq/TestCheckESelectTestItemPopup',
        //            data: {
        //                test_type: test_type
        //            },
        //            dataType: "json",
        //            async: false,
        //            success: function (result) {

        //                try {
        //                    var jsonData = JSON.parse(result);
        //                    $("#TestCheckEItem_gridContainer").dxDataGrid("option", "dataSource", jsonData);
        //                }
        //                catch (e) {
        //                    $("#TestCheckEItem_gridContainer").dxDataGrid("option", "dataSource", []);
        //                }

        //            }
        //        })
        //    }
        //});

        //$('input[name=item_cd]+div>button'
        //    + ', input[name=cust_cd]+div>button'
        //    + ', input[name=material_maker_cd]+div>button'
        //    , $('#' + "testCheckEWriteForm")).click(function (event) {
        //    testCheckEPopUpSearch(event);
        //});

        // 탭메뉴
        // 필요시 주석해지
        //menutab('TestCheckETab', 'TestCheckETabContent', 1);

        $('#TestCheckE .datepicker').datepicker({
            format: "yyyy-mm-dd",	//데이터 포맷 형식(yyyy : 년 mm : 월 dd : 일 )
            clearBtn: false, //날짜 선택한 값 초기화 해주는 버튼 보여주는 옵션 기본값 false 보여주려면 true
            autoclose: true,
            templates: {
                leftArrow: '&laquo;',
                rightArrow: '&raquo;'
            }, //다음달 이전달로 넘어가는 화살표 모양 커스텀 마이징
            todayHighlight: true,	//오늘 날짜에 하이라이팅 기능 기본값 :false
            toggleActive: false,	//이미 선택된 날짜 선택하면 기본값 : false인경우 그대로 유지 true인 경우 날짜 삭제
            weekStart: 0,//달력 시작 요일 선택하는 것 기본값은 0인 일요일
            language: "ko",	//달력의 언어 선택, 그에 맞는 js로 교체해줘야한다.
            enableOnReadonly: true
        });

        TestCheckEEditCheck(true, 'N');

        $($("#TestCheckEUploadFileBtn")).click(function (event) {
            TestCheckEUploadFileBtn(event);
        });

        $($("#TestCheckEDownloadFileBtn")).click(function (event) {
            TestCheckEDownloadFileBtn(event);
        });

        $($("#TestCheckEDeleteFileBtn")).click(function (event) {
            TestCheckEDeleteFileBtn(event);
        });


        $("#TestCheckESearchForm input[name=de_SDate]").datepicker("update", '@DateTime.Now.AddMonths(-1).ToShortDateString()');
        $("#TestCheckESearchForm input[name=de_EDate]").datepicker("update", '@DateTime.Now.ToShortDateString()');

        // 프로그램별 함수 정의
        $('button#sb_retest').click(function () {
            TestCheckESbReTest();
        });

        TestCheckESearch();

    });

    // 수정중인지 체크
    function TestCheckEEditCheck(nowEdit, status) {

        //UtilView.setActiveElement(nowEdit
        //    , status
        //    , "TestCheckEToolbar"
        //    , "TestCheckEGrid"
        //    , "TestCheckEWriteForm"
        //    , ""
        //);

        UtilView.setActiveElementFormId(nowEdit, status, "TestCheckEWriteForm", "")

        _testCheckEIsEditing = nowEdit;

        $("#TestCheckEWriteForm input[name=gubun]").val(status);
    }

    // 시험성적서확인 그리드 포커스 변경
    function TestCheckEFocusChanged() {
        // 그리드 초기화
        $("#TestCheckESignTable").dxDataGrid("option", "dataSource", []);
        $("#TestCheckEDetailGrid").dxDataGrid("option", "dataSource", []);
        $("#TestCheckEFileGrid").dxDataGrid("option", "dataSource", []);

        // 그리드 폼binding
        UtilView.setDataGridFormBind("TestCheckEGrid", "TestCheckEWriteForm");

        var grid = $("#TestCheckEGrid").dxDataGrid("instance");
        var gridData = getGridRowByKey("TestCheckEGrid", grid.option("focusedRowKey"));

        if (!gridData.test_result_yn_c) {
            $("#TestCheckEWriteForm input[name=test_result_yn_c]").prop("checked", false);
        }

        _testCheckESignCnt = 0;

        $("#TestCheckE_rg_YorN1").prop("disabled", false);

        $.ajax({
            type: 'GET',
            url: '/QualityControl/testCheckESelectDetail',
            dataType: "json",
            data: {
                dto: JSON.stringify({ testcontrol_id: gridData.testcontrol_id, test_type: gridData.test_type }),
                process_kind: '1'
            },
            async: false,
            success: function (result) {
                try {
                    var jsonData = JSON.parse(result[0]);
                    $("#TestCheckEDetailGrid").dxDataGrid("option", "dataSource", jsonData);

                    for (var i = 0; i < jsonData.length; i++) {
                        if (jsonData[i].testitem_result_yn === "N") {
                            $("#TestCheckE_rg_YorN1").prop("disabled", true);
                        }
                    }

                }
                catch (e) {
                    $("#TestCheckEDetailGrid").dxDataGrid("option", "dataSource", []);
                }

                try {
                    var jsonData = JSON.parse(result[1]);
                    $("#TestCheckESignTable").dxDataGrid("option", "dataSource", jsonData);

                    for (var i = 0; i < jsonData.length; i++) {
                        _testCheckESignCnt += parseInt(jsonData[i].sign_yn);
                    }

                    if (_testCheckESignCnt > 0) {
                        $("#TestCheckEWriteForm input[name=test_result_yn_c]").on("click", function () {
                            return false;
                        });
                    } else {
                        $("#TestCheckEWriteForm input[name=test_result_yn_c]").off("click");
                    }

                }
                catch (e) {
                    $("#TestCheckESignTable").dxDataGrid("option", "dataSource", []);
                }

                //try {
                //    var jsonData = JSON.parse(result[1]);
                //    $("#TestCheckEFileGrid").dxDataGrid("option", "dataSource", jsonData);
                //}
                //catch (e) {
                //    $("#TestCheckEFileGrid").dxDataGrid("option", "dataSource", []);
                //}
            }
        })
    }

    // detail 그리드 row 포커스 변경
    function TestCheckEDetailFocusChanged() {
       //UtilView.setDataGridFormBind("TestCheckEGrid", "TestCheckEWriteForm");

        TestCheckESelectFileList();
    }

    // 시험의뢰 그리드 로우 하이라이트
    function TestCheckEHighlightRow(e) {

        if (e.rowType === "data" && e.data.hb_ck === "Y") {             // 허벌라이프 전용원료
            e.rowElement[0].style.backgroundColor = 'greenyellow';
        }
        else if (e.rowType === "data" && e.data.test_status === "14") { // 미생물시험완료
            e.rowElement[0].style.backgroundColor = 'orangered';
        }
    }

    // 시험의뢰 그리드 셀 하이라이트
    function TestCheckEHighlightCell(cellInfo) {

        if (cellInfo.rowType == "data" && cellInfo.column.dataField === 'test_type_nm') {

            if (cellInfo.data.test_type === '1') {          // 원료시험
                cellInfo.cellElement[0].style.backgroundColor = 'lightcyan';
            } else if (cellInfo.data.test_type === '2') {   // 자재
                cellInfo.cellElement[0].style.backgroundColor = 'khaki';
            } else if (cellInfo.data.test_type === '3') {   // 반제품
                cellInfo.cellElement[0].style.backgroundColor = 'palegreen';
            } else if (cellInfo.data.test_type === '4') {   // 용출시험
                cellInfo.cellElement[0].style.backgroundColor = 'lightsalmon';
            } else if (cellInfo.data.test_type === '5') {   // 재포장
                cellInfo.cellElement[0].style.backgroundColor = 'lightgoldenrodyellow';
            } else if (cellInfo.data.test_type === '6') {   // 포장
                cellInfo.cellElement[0].style.backgroundColor = 'navajowhite';
            } else if (cellInfo.data.test_type === '7') {   // 출하
                cellInfo.cellElement[0].style.backgroundColor = 'gray';
            } else if (cellInfo.data.test_type === '8') {   // 정제수
                cellInfo.cellElement[0].style.backgroundColor = 'darkcyan';
            } else if (cellInfo.data.test_type === '9') {   // 청정도
                cellInfo.cellElement[0].style.backgroundColor = 'skyblue';
            }
        }
        else if (cellInfo.rowType == "data" && cellInfo.column.dataField === 'test_status_nm') {

            //console.log(cellInfo.data);

            if (cellInfo.data.test_status_cd === '0') {            // ___
                //cellInfo.cellElement[0].style.backgroundColor = 'lightblue';
            } else if (cellInfo.data.test_status_cd === '1') {     // 의뢰
                cellInfo.cellElement[0].style.backgroundColor = 'silver';
            } else if (cellInfo.data.test_status_cd === '2') {     // 접수
                cellInfo.cellElement[0].style.backgroundColor = 'khaki';
            } else if (cellInfo.data.test_status_cd === '3') {     // 채취지시
                cellInfo.cellElement[0].style.backgroundColor = 'navajowhite';
            } else if (cellInfo.data.test_status_cd === '4') {     // 채취중
                cellInfo.cellElement[0].style.backgroundColor = 'gray';
            } else if (cellInfo.data.test_status_cd === '5') {     // 검체채취
                cellInfo.cellElement[0].style.backgroundColor = 'paleturquoise';
            } else if (cellInfo.data.test_status_cd === '6') {     // 시험중
                cellInfo.cellElement[0].style.backgroundColor = 'thistle';
            } else if (cellInfo.data.test_status_cd === '7') {     // 시험완료
                cellInfo.cellElement[0].style.backgroundColor = 'cornflowerblue';
            } else if (cellInfo.data.test_status_cd === '8') {     // 확인
                cellInfo.cellElement[0].style.backgroundColor = 'palegreen';
            } else if (cellInfo.data.test_status_cd === '9') {     // 승인

                if (cellInfo.data.test_result_yn_c === 'Y') {             // 적합 판정
                    cellInfo.cellElement[0].style.backgroundColor = 'limegreen';
                } else if (cellInfo.data.test_result_yn_c === 'N') {      // 부적합 판정
                    cellInfo.cellElement[0].style.backgroundColor = 'lightcoral';
                } else if (cellInfo.data.test_result_yn_c === 'C') {      // 조건부 적합
                    cellInfo.cellElement[0].style.backgroundColor = 'greenyellow';
                }

            } else if (cellInfo.data.test_status_cd === '10') {    // 통보
                cellInfo.cellElement[0].style.backgroundColor = 'tan';
            } else if (cellInfo.data.test_status_cd === '11') {    // 출하
                cellInfo.cellElement[0].style.backgroundColor = 'lightslategray';
            } else if (cellInfo.data.test_status_cd === '12') {    // 일정
                cellInfo.cellElement[0].style.backgroundColor = 'pink';
            } else if (cellInfo.data.test_status_cd === '13') {    // 의뢰취소
                cellInfo.cellElement[0].style.backgroundColor = 'silver';
                cellInfo.cellElement[0].style.fontColor = 'crimson';
            } else if (cellInfo.data.test_status_cd === '14') {    // 미생물시험완료
                cellInfo.cellElement[0].style.backgroundColor = 'goldenrod';
            }
        }
    }


    //#region 팝업 관련

    //var TestCheckEHelpPopUpCurInputName = "";

    //function TestCheckEPopUpSearch(e) {
    //    TestCheckEHelpPopUpCurInputName = UtilView.getParentAttrValByClass(e, ".input-group-append", ".form-control", "name");
    //    var popupId = "";

    //    switch (TestCheckEHelpPopUpCurInputName) {
    //        case "item_cd":
    //            popupId = "TestCheckEItem";
    //            break;
    //        case "cust_cd":
    //            popupId = "TestCheckEVender";
    //            break;
    //        case "material_maker_cd":
    //            popupId = "TestCheckEMaker";
    //            break;
    //        default:
    //            popupId = "";
    //            break;
    //    }

    //    if (popupId == "") {
    //        alert("(오류) popup ID 미설정 오류!");
    //    }
    //    $('#' + popupId + 'Popup').dxPopup("instance").show();
    //}

    //function TestCheckEItemRowDblClick(selectedItems) {
    //    var data = selectedItems.data;

    //    $("input[name=" + TestCheckEHelpPopUpCurInputName + "]", $('#' + "TestCheckEWriteForm")).val(data.item_cd);
    //    $("input[name=item_nm]", $('#' + "TestCheckEWriteForm")).val(data.item_nm);
    //    $("select[name=process_cd]", $('#' + "TestCheckEWriteForm")).val(data.process_cd);

    //    $("#TestCheckEItemPopup").dxPopup("instance").hide();
    //}

    //function TestCheckEVenderRowDblClick(selectedItems) {
    //    var data = selectedItems.data;

    //    $("input[name=" + TestCheckEHelpPopUpCurInputName + "]", $('#' + "TestCheckEWriteForm")).val(data.vender_cd);
    //    $("input[name=cust_nm]", $('#' + "TestCheckEWriteForm")).val(data.vender_nm);

    //    $("#TestCheckEVenderPopup").dxPopup("instance").hide();
    //}

    //function TestCheckEMakerRowDblClick(selectedItems) {
    //    var data = selectedItems.data;

    //    $("input[name=" + TestCheckEHelpPopUpCurInputName + "]", $('#' + "TestCheckEWriteForm")).val(data.vender_cd);
    //    $("input[name=material_maker_nm]", $('#' + "TestCheckEWriteForm")).val(data.vender_nm);

    //    $("#TestCheckEMakerPopup").dxPopup("instance").hide();
    //}

    //#endregion


    //#region 툴바 클릭 이벤트 관련

    // 조회
    function TestCheckESearch() {

        var form = $('#TestCheckESearchForm');

        $.ajax({
            type: 'GET',
            url: '/QualityControl/TestCheckESelect',
            data: form.serialize(),
            processData: true,
            contentType: 'application/x-www-form-urlencoded; charset=UTF-8',
            success: function (result) {

                try {

                    var jsonData = JSON.parse(result=="" ? null : result);
                    var grid = $("#TestCheckEGrid").dxDataGrid("instance");

                    return new Promise((resolve, reject) => {
                        grid.option("dataSource", jsonData);
                        resolve();
                    })
                    .then(() => {
                        TestCheckEFocusChanged();
                    }).catch(() => {

                    });

                } catch (e) {

                    $("#TestCheckEGrid").dxDataGrid("option", "dataSource", []);

                }
            }
        })

        //UtilView.dataGridSelect('TestCheckEGrid', 'TestCheckESearchForm');
    }

    // 입력
    function TestCheckEInput() {

        $("#TestCheckEWriteForm")[0].reset();
        $("#TestCheckESignTable").dxDataGrid("option", "dataSource", []);
        $("#TestCheckEFileGrid").dxDataGrid("option", "dataSource", []);

        TestCheckEEditCheck(true, 'I');

        $("#TestCheckEWriteForm input[name=gmo_yn][value='N']").prop("checked", true);
    }

    // 수정
    function TestCheckEEdit() {

        var grid = $("#TestCheckEGrid").dxDataGrid("instance");

        if (!grid.option("focusedRowKey")) {
            alert("수정할 사항이 없습니다.");
            return;
        }

        var gridData = getGridRowByKey("TestCheckEGrid", grid.option("focusedRowKey"));

        var test_status = gridData.test_status;

        if (test_status == "0" || test_status == "1") {

            if (_testCheckESignCnt > 0) {
                alert("이미 서명된 시험의뢰는 수정할 수 없습니다.");
                return;
            }
        }
        else if (test_status != "0" || test_status != "1") {
            alert("시험이 진행중이므로 수정할 수 없습니다.");
            return;
        }

        TestCheckEEditCheck(true, 'U');
    }

    // 삭제
    async function TestCheckEDelete() {
        var grid = $("#TestCheckEGrid").dxDataGrid("instance");

        if (!grid.option("focusedRowKey")) {
            alert("삭제할 내용이 없습니다.!");
            return;
        }
        var gridData = getGridRowByKey("TestCheckEGrid", grid.option("focusedRowKey"));

        var ck_test_result_yn = gridData.test_result_yn_c;

        if (ck_test_result_yn == "R" || ck_test_result_yn == "C") {
            if (!confirm("<조건부 적합> 판정을 취소하시겠습니까?")) return;
            var mesg = await TestCheckECancelCheckInfo(gridData.testcontrol_id, gridData.test_type, gridData.process_cd);
            if (UtilView.isEmpty(mesg)) {
                alert(mesg);
            }

            TestCheckESearch();
            return;
        }

        if (!TestCheckECheckTestStatus(gridData)) return;

        if (!confirm("시험성적확인을 취소하시겠습니까?")) return;

        if (_testCheckESignCnt < 1) {
            //정보 취소 후 전자서명 취소까지 하나의 세션에서 처리함.
            var objParam = { testcontrol_id: gridData.testcontrol_id, test_type : gridData.test_type};
            TestCheckECancelResult(objParam);
        }
        else {

            var objParam = { testcontrol_id: gridData.testcontrol_id, test_type: gridData.test_type };

            $("#TestCheckESignPopup").dxPopup("instance").show();

            // 작업자 서명 팝업 submit 버튼 클릭 이벤트 변경(마지막 작업자 확인)
            $("#TestCheckESignForm button").off("click");
            $("#TestCheckESignForm button").on("click", function () {
                TestCheckECheckLastSignEmp(objParam);
            });

        }
    }

    // 마지막 작업자 확인
    function TestCheckECheckLastSignEmp(param) {

        var data = new FormData($('#TestCheckESignForm')[0]);

        data.set("gubun", "S");

        // ID, PW 존재하는지 확인
        $.ajax({
            type: 'POST',
            url: '/Comm/IDValidation',
            data: data,
            contentType: false,
            processData: false,
            success: async function (result) {
                if (result.length <= 0) {

                    alert("잘못된 ID,PW 입니다.");
                    return;
                }

                var jsonData = JSON.parse(result)[0];

                // 마지막 서명자인지 확인
                $.ajax({
                    type: 'GET',
                    url: '/QualityControl/TestCheckECheckLastSignEmp',
                    dataType: "json",
                    data: {
                        testcontrol_id: param.testcontrol_id,
                        test_type: param.test_type,
                        process_kind: "1",
                        program_cd: "TestCheckE"
                    },
                    async: false,
                    success: function (result) {

                        if (jsonData.emp_cd != result.message) {
                            alert("마지막 서명자만 취소 할 수 있습니다.");
                            return;
                        }

                        // 시험 성적서 확인 정보 삭제(적/부 판정, 서명 정보)
                        TestCheckECancelResult(param);

                        $("#TestCheckESignPopup").dxPopup("instance").hide();

                    }
                });
            }
        });

    }

    // 시험 성적서 확인 정보 삭제(적/부 판정, 서명 정보)
    function TestCheckECancelResult(param) {
        $.ajax({
            type: 'POST',
            url: '/QualityControl/TestCheckECancelSign',
            dataType: "json",
            data: {
                dto: JSON.stringify(param)
            },
            async: false,
            success: function (result) {

                if (result.message != "Y") {
                    alert("삭제에 실패했습니다.");
                    return;
                }
                TestCheckESearch();
            }
        });
    }

    // 저장
    function TestCheckESave() {

        //var start_qty = $("#TestCheckEWriteForm input[name=start_qty]").val();

        //if (start_qty < 0) {
        //    alert("의뢰량이 마이너스입니다.");
        //    return;
        //}

        //var form = $('#TestCheckEWriteForm')[0];
        //var formData = new FormData(form);

        //if (!UtilView.checkValidForm("TestCheckEWriteForm")) {
        //    return;
        //}

        //UtilView.dataGridTRX(formData, () => TestCheckESearch());

        //TestCheckEEditCheck(false, 'N');
    }

    // 취소
    function TestCheckEUndo() {
        TestCheckEEditCheck(false, 'N');
        TestCheckEFocusChanged();
    }

    // 출력, 미리보기
    function TestCheckEPrint() {
        // <report pre check>
        var gridName = "TestCheckEGrid";
        var grid = $("#" + gridName).dxDataGrid("instance");
        var gridFocusRowKey = grid.option("focusedRowKey")
        if (!gridFocusRowKey) {
            alert("출력할 품목을 선택하세요!");
            return;
        }
        var gridData = getGridRowByKey(gridName, gridFocusRowKey);

        var testcontrol_id = gridData.testcontrol_id;
        var test_type = gridData.test_type;

        // 시험완료(7) 이전 상태인 ---(0), 의뢰(1), 접수(2), 검체채취(5), 시험중(6), 시험지시(12) 인 경우
        if (parseInt(gridData.test_status_cd) < 7 ||
            gridData.test_status_cd == "12") {
            alert("[확인] 이전 단계가 완료되지 않았거나, 시험성적 입력이 끝나지 않았습니다\n시험 성적서를 출력 할 수 없습니다");
            return;
        }
        // </report pre check>

        // report 출력 객체 생성
        var report = new ReportHelper($(event.target));
        //var report = new ReportHelper();

        report.addParam({
            objFile: { path: "QualityControl", RptFileName: "TestCertificateCR_GD" },
            objSp: { SpName: "SP_TestCertificateReport", gubun: "S", reportParam: "testcontrol_id:" + testcontrol_id },
            // objEtcInfo 속성정의
            //  - viewerNanme => report뷰어명, 기본값: ReportViewer, 별도의 viewer사용시적용(DayOrderWork.cshtml 참조)
            //  - nCopies     => 프린트할 수량,  기본값:1, 수량지정시 해당수량만큼 프린트함
            objEtcInfo: { subParam: "set_sign_yn=", viewerName: "", nCopies: 1 }
            // dataset(다중테이블)  사용시, 아래주석을 풀어서 사용한다.
            //objTblNm: { tblName: "Header,TotalRate" },
            //sub report필요시, 아래주석을 풀어서 사용한다.
            //objSub: { subRptName: "Process,FinishDate,OrderQty,OrderQty2,Receive,ReceiveEA,Real,RealEA,Rate,Rate2,Remark" },
        });

        // 레포트테스트(생성객체확인)
        //report.testObj();
        report.run();
    }

    // 엑셀 추출
    function TestCheckEExcel() {
        var m;
        try { m = UtilView.getCurMenuInfo('menuname'); } catch (e) { m = '이름없음' };
        m += "_" + '@DateTime.Now.ToShortDateString()';
        gridExportToExcel("TestCheckEGrid", m);
    }

    //#endregion


    //#region 전자서명 관련

    // 서명 그리드 셀 클릭
    async function TestCheckESign(e) {
        // <before> 프로그램별 user define 함수 호출
        if (!await TestCheckEsaveSignData()) {
            return;
        }

        // 이하, 공통 로직 정의 start
        if ($("#TestCheckEWriteForm input[name=gubun]").val() != "N") {
            return;
        }

        _testCheckESignData = e.data;

        if (e.columnIndex == 3) {

            _testCheckESignGubun = "EI";

            if (e.data.prev_sign_yn == "0") {
                alert("먼저 앞 단계 승인이 필요합니다.");
                return;
            }

            if (e.data.sign_yn == "1") {

                var gridName = "TestCheckEGrid";
                var grid = $("#" + gridName).dxDataGrid("instance");
                var gridFocusRowKey = grid.option("focusedRowKey");
                var gridData = getGridRowByKey(gridName, gridFocusRowKey);

                if (gridData.test_status_cd == "9") {
                    alert("이미 승인된 성적서 입니다.\n먼저 승인을 삭제(취소)해주세요. ");
                    return;
                }

                if (e.data.next_sign_yn == "1") {
                    alert("이미 다음 단계가 승인 되어 있습니다.\n먼저 다음 단계 승인을 삭제(취소)해주세요. ");
                    return;
                }

                if (confirm("이미 승인 되었습니다. 서명을 삭제하시겠습니까?")) {
                    _testCheckESignGubun = "SignCancel";
                } else {
                    return;
                }

            }

            $("#TestCheckESignPopup").dxPopup("instance").show();
            $("#TestCheckESignForm button").off("click");
            $("#TestCheckESignForm button").on("click", function () {
                TestCheckESignSubmit();
            });
        }
    }

    // 전자서명 입력
    function TestCheckESignSubmit() {

        var data = new FormData($('#TestCheckESignForm')[0]);

        data.set("gubun", "S");

        $.ajax({
            type: 'POST',
            url: '/Comm/IDValidation',
            data: data,
            contentType: false,
            processData: false,
            success: async function (result) {
                if (result.length <= 0) {

                    alert("잘못된 ID,PW 입니다.");
                    return;
                }

                var jsonData = JSON.parse(result)[0];

                var isOK = false;
                var fnChkYN = "";        // 함수check Y/N

                var grid = $("#TestCheckEGrid").dxDataGrid("instance");
                var gridData = getGridRowByKey("TestCheckEGrid", grid.option("focusedRowKey"));

                 // 전자서명은 필수가 아닌 경우를 확인
                if (_testCheckESignData.necessary_yn !== "Y") {
                    //부적합 선택시 시험완료 처리를 한다.
                    var TestCheckE_rg_YorN = $('input[name=test_result_yn_c]:checked', '#TestCheckEWriteForm').val();

                    if (TestCheckE_rg_YorN == "N") {
                        fnChkYN = await TestCheckESetStatusTestCompleteForReject(gridData.testcontrol_id);
                        if (fnChkYN == "N" ) {
                            alert("부적합으로 인한 상태변경 중 오류가 발생했습니다.");
                            return;
                        }
                    }

                    //전자서명 정보저장은 하지않고 상태만 다음상태로 변경.
                    fnChkYN = await TestCheckESetNextStatus(gridData.testcontrol_id, gridData.test_type, "1");
                    if (fnChkYN == "Y") {
                        fnChkYN = await TestCheckESaveTestJudgment();
                        if (fnChkYN == "N") {
                            alert("시험판정정보 저장 중 오류가 발생했습니다.");
                            return;
                        }
                        alert("정상적으로 처리되었습니다.!!!");
                        TestCheckESearch();
                        setTimeout(function () {
                            var popup = $("#TestCheckESignPopup").dxPopup("instance");
                            popup.hide();
                        }, 1000);
                    }
                    else {
                        alert("상태변경 중 오류가 발생했습니다.");
                        return;
                    }
                }
                // 전자서명 필수인 경우
                else {
                    //로그인 사용자와 동일한지 여부 체크
                    if (jsonData.emp_cd !== sessionStorage.getItem("loginCD")) {
                        alert("로그인 사용자와 서명자가 일치하지 않습니다.");
                        return;
                    }

                    var representative_yn = 'N';

                    //서명 책임자와 서명자가 일치하지 않으면 대리자 권한을 체크한다.
                    if (_testCheckESignData.responsible_emp_cd !== jsonData.emp_cd) {

                        $.ajax({
                            type: 'GET',
                            url: '/QualityControl/TestCheckESignDelegateCheck',
                            data: {
                                emp_cd: jsonData.emp_cd,
                                testcontrol_id: gridData.testcontrol_id,
                                process_kind: '1',
                                test_type: gridData.test_type,
                                sign_set_dt_id: _testCheckESignData.sign_set_dt_id
                            },
                            async: false,
                            success: function (result) {
                                if (result.length > 0) {
                                    representative_yn = 'Y';
                                    isOK = true;
                                } else {
                                    isOK = false;
                                }
                            }
                        });

                    } else {
                        isOK = true;
                    }

                    if (!isOK) {
                        alert("권한이 없는 사용자입니다.");
                        return;
                    }

                    //부적합 선택시 시험완료 처리를 한다.
                    var TestCheckE_rg_YorN = $('input[name=test_result_yn_c]:checked', '#TestCheckEWriteForm').val();
                    if (TestCheckE_rg_YorN == "N") {
                        fnChkYN = await TestCheckESetStatusTestCompleteForReject(gridData.testcontrol_id);
                        if (fnChkYN=="N") {
                            alert("부적합으로 인한 상태변경 중 오류가 발생했습니다.");
                            return;
                        }
                    }

                    //전자 서명 자료를 저장한다
                    var paramData = {
                        gubun: _testCheckESignGubun,
                        emp_cd: jsonData.emp_cd,
                        testcontrol_id: gridData.testcontrol_id,
                        process_kind: '1',
                        test_type: gridData.test_type,
                        sign_set_dt_id: _testCheckESignData.sign_set_dt_id,
                        validation_type: "2",
                        representative_yn: representative_yn
                    };

                    fnChkYN = await TestCheckESaveElectronicSignature(paramData);

                    if (fnChkYN == "Y") {
                        fnChkYN = await TestCheckESaveTestJudgment();
                        if (fnChkYN == "N") {
                            alert("시험판정정보 저장 중 오류가 발생했습니다");
                            return;
                        }
                    } else {
                        alert("전자서명 정보 저장 중 오류가 발생했습니다.");
                        return;
                    }

                    var popup = $("#TestCheckESignPopup").dxPopup("instance");
                    popup.hide();

                    alert("정상적으로 처리되었습니다.!!!");

                    TestCheckESearch();

                    _testCheckESignGubun = "";

                }
            }
        });
    }

    // 전자서명 인풋 초기화
    function ClearTestCheckESignInput() {
        $('#TestCheckESignForm')[0].reset();
        $("#TestCheckESignForm button").off("click");
        $("#TestCheckESignForm button").on("click", function () {
            TestCheckESignSubmit();
        });
    }

    //#endregion


    //#region 파일 관련

    // 파일목록만 조회
    function TestCheckESelectFileList() {
        var grid = $("#TestCheckEGrid").dxDataGrid("instance");
        var grid2 = $("#TestCheckEDetailGrid").dxDataGrid("instance");
        var gridData = getGridRowByKey("TestCheckEGrid", grid.option("focusedRowKey"));
        var gridData2 = getGridRowByKey("TestCheckEDetailGrid", grid2.option("focusedRowKey"));

        //var testcontrol_id = $("#TestCheckEWriteForm input[name=testcontrol_id]").val();

        $.ajax({
            type: 'GET',
            url: '/QualityControl/testCheckESelectFile',
            data: {
                testcontrol_id: gridData.testcontrol_id,
                teststandardmaster_id: gridData2.teststandardmaster_id
            },
            success: function (result) {

                try {
                    var json = JSON.parse(result);
                    $("#TestCheckEFileGrid").dxDataGrid("option", "dataSource", json);
                } catch (e) {
                    $("#TestCheckEFileGrid").dxDataGrid("option", "dataSource", []);
                }
            }
        });
    }

    // 파일 업로드 버튼
    function TestCheckEUploadFileBtn(event) {

        //if ($("#TestCheckEWriteForm input[name=gubun]").val() !== "U") {
        //    alert("수정중일때만 파일 첨부가 가능합니다.");
        //    return;
        //}
        var grid = $("#TestCheckEDetailGrid").dxDataGrid("instance");

        //console.log("filegrid rowkey :" + grid.option("focusedRowKey"));
        if (grid.option("focusedRowKey")) {

            var fileUploader = $('#TestCheckEFileUploader').dxFileUploader('instance');
            fileUploader._isCustomClickEvent = true;
            fileUploader._$fileInput.click();
        } else {
            alert("첨부할 시험항목을 선택하십시오!")
        }
    }

    // 파일 업로드
    function TestCheckEUploadFile(e) {
        var grid = $("#TestCheckEGrid").dxDataGrid("instance");
        var grid2 = $("#TestCheckEDetailGrid").dxDataGrid("instance");
        var gridData = getGridRowByKey("TestCheckEGrid", grid.option("focusedRowKey"));
        var gridData2 = getGridRowByKey("TestCheckEDetailGrid", grid2.option("focusedRowKey"));


        var name = e.component.option("name");
        var url = e.component.option("uploadUrl");
        url = updateQueryStringParameter(url, "testcontrol_id", gridData.testcontrol_id);
        url = updateQueryStringParameter(url, "teststandardmaster_id", gridData2.teststandardmaster_id);
        url = updateQueryStringParameter(url, "name", name);

        e.component.option("uploadUrl", url);
    }

    // 파일 다운로드
    function TestCheckEDownloadFileBtn(e) {

        var grid = $("#TestCheckEFileGrid").dxDataGrid("instance");
        var gridData = getGridRowByKey("TestCheckEFileGrid", grid.option("focusedRowKey"));

        var grid2 = $("#TestCheckEGrid").dxDataGrid("instance");
        var grid3 = $("#TestCheckEDetailGrid").dxDataGrid("instance");
        var gridData2 = getGridRowByKey("TestCheckEGrid", grid2.option("focusedRowKey"));
        var gridData3 = getGridRowByKey("TestCheckEDetailGrid", grid3.option("focusedRowKey"));

        var fileId = gridData.test_back_data_id;

        if (fileId != "") {
            var url = "";
            url = updateQueryStringParameter(url, "testcontrol_id", gridData2.testcontrol_id);
            url = updateQueryStringParameter(url, "teststandardmaster_id", gridData3.teststandardmaster_id);
            url = updateQueryStringParameter(url, "file_id", fileId);

            document.location.assign('/QualityControl/TestCheckEDownloadFile'+url);
        }
    }

    // 파일 삭제
    function TestCheckEDeleteFileBtn() {

        if (!confirm("선택한 문서를 삭제하시겠습니까?")) {
            return;
        }

        var grid = $("#TestCheckEFileGrid").dxDataGrid("instance");
        var gridData = getGridRowByKey("TestCheckEFileGrid", grid.option("focusedRowKey"));

        var grid2 = $("#TestCheckEGrid").dxDataGrid("instance");
        var grid3 = $("#TestCheckEDetailGrid").dxDataGrid("instance");
        var gridData2 = getGridRowByKey("TestCheckEGrid", grid2.option("focusedRowKey"));
        var gridData3 = getGridRowByKey("TestCheckEDetailGrid", grid3.option("focusedRowKey"));

        $.ajax({
            type: 'POST',
            url: '/QualityControl/TestCheckEDeleteFile',
            data: {
                testcontrol_id: gridData2.testcontrol_id,
                teststandardmaster_id: gridData3.teststandardmaster_id,
                file_id: gridData.test_back_data_id
            },
            success: function (result) {

                alertWarning(result);

                TestCheckESelectFileList();
            }
        });
    }

    //#endregion


    //#region 프로그램별 함수
    async function TestCheckEsaveSignData() {
        var grid = $("#TestCheckEGrid").dxDataGrid("instance");
        if (!grid.option("focusedRowKey")) {
            return false;
        }
        var gridData = getGridRowByKey("TestCheckEGrid", grid.option("focusedRowKey"));

        var test_type = gridData.test_type;
        var testcontrol_id = gridData.testcontrol_id;

        //사용기한, 재시험 여부 체크
        if (test_type != "10") {
            if (!validationElementCk('TestCheckEWriteForm', 'retest_yn', true, '사용기한 정보가 없습니다.!!!')) return false;
        }

        //사용기한 일자 체크
        if (test_type != "10") {
            if (!validationElementCk('TestCheckEWriteForm', 'valid_period', false, '')) {
                if (test_type != "2") {
                    alert('사용일자가 없습니다.!!!');
                    return false;
                }
            }
        }

        //프로그램 특성상 추가된 코드
        if (!validationElementCk('TestCheckEWriteForm', 'test_result_yn_c', true, '적합/ 부적합 판정에 체크되어 있지 않습니다')) return false;

        //적합인 경우는 모든 시험이 완료되어야 합니다.
        //적합을 선택한 경우, 시험항목을 체크해서 부적합이 있으면 에러 메시지를 준다.

        var check = true;
        var test_result_yn_c = $('input[name=test_result_yn_c]:checked', $('#TestCheckEWriteForm')).val();
        if (test_result_yn_c == "Y") {
            //항목 시험 완료 여부 체크
            var item_cd = gridData.item_cd;
            if (await TestCheckECheckTestStandard(testcontrol_id,item_cd) == false) {
                alert("시험이 모두 완료되지 않았습니다");
                return false;
            }

            //첨부 데이터 확인 여부 체크
            if (await TestCheckEDataCheckYN(testcontrol_id) == "N") {
                alert("첨부 자료의 확인을 완료한 후 서명할 수 있습니다.");
                return false;
            }

            var grid2 = $("#TestCheckEDetailGrid").dxDataGrid("instance");
            var objRows = grid2.getVisibleRows();
            for (var index in objRows) {
                //참고시험이 아닌경우에만 해당
                if (grid2.cellValue(index, "reference_test_yn") != "Y" && grid2.cellValue(index, "testitem_result_yn") == "N" && grid2.cellValue(index, "retest_check") != "ReTest") {
                    check = false;
                    break;
                }
            }

            if (check == false) {
                alert("시험항목중 부적합 된 항목이 존재하는 경우 적합 판정을 할 수 없습니다.");
                return false;
            }

            var test_date = gridData.test_date;
            if (await TestCheckECheckTestDate(testcontrol_id, test_date) == "N") {
                alert("승인일자는 시험일자 이후여야 합니다.");
                return false;
            }

        }

        //var start_qty = $("#TestCheckEWriteForm input[name=start_qty]").val();

        //if (start_qty < 0) {
        //    alert("의뢰량이 마이너스입니다.");
        //    return;
        //}

        //var form = $('#TestCheckEWriteForm')[0];
        //var formData = new FormData(form);

        //if (!UtilView.checkValidForm("TestCheckEWriteForm")) {
        //    return;
        //}

        //UtilView.dataGridTRX(formData, () => TestCheckESearch());

        return true;
    }

    async function TestCheckECheckTestStandard(testcontrol_id, item_cd) {
        var objParam = { testcontrol_id: testcontrol_id, item_cd: item_cd };
        const result = await $.ajax({
            type: 'POST',
            url: '/QualityControl/TestCheckECheckTestStandard',
            data: {
                dto: JSON.stringify(objParam)
            }
        });
        return result;
    }

    async function TestCheckEDataCheckYN(testcontrol_id) {
        var objParam = { testcontrol_id: testcontrol_id };
        const result = await $.ajax({
            type: 'POST',
            url: '/QualityControl/TestCheckEDataCheckYN',
            data: {
                dto: JSON.stringify(objParam)
            }
        });
        return result;
    }

    async function TestCheckECheckTestDate(testcontrol_id, test_date) {
        var objParam = { testcontrol_id: testcontrol_id, test_date:test_date };
        const result = await $.ajax({
            type: 'POST',
            url: '/QualityControl/TestCheckECheckTestDate',
            data: {
                dto: JSON.stringify(objParam)
            }
        });
        return result;
    }

    async function TestCheckESetStatusTestCompleteForReject(testcontrol_id) {
        var objParam = { testcontrol_id: testcontrol_id };
        const result = await $.ajax({
            type: 'POST',
            url: '/QualityControl/TestCheckESetStatusTestCompleteForReject',
            data: {
                dto: objParam
            }
        });
        return result;
    }

    async function TestCheckESaveElectronicSignature(paramData) {
        //var objParam = { testcontrol_id: testcontrol_id };
        //var objParam = paramData;
        const result = await $.ajax({
            type: 'POST',
            url: '/QualityControl/TestCheckESaveElectronicSignature',
            data: paramData
        });
        return result;
    }

    async function TestCheckESaveTestJudgment() {
        var writeForm = $('#TestCheckEWriteForm');

        var extend_yn = UtilView.isEmpty($('input[name=extend_yn]:checked', writeForm).val()) ? "N" : "Y";

        var objParam = {
            testcontrol_id : $('input[name=testcontrol_id]', writeForm).val(),
            test_result_yn_c: $('input[name=test_result_yn_c]:checked', writeForm).val(),
            test_inform_remark: $('input[name=test_inform_remark]', writeForm).val(),
            valid_period: $('input[name=valid_period]', writeForm).val(),
            retest_yn: $('input[name=retest_yn]:checked', writeForm).val(),
            test_result_value: $('input[name=test_result_value]', writeForm).val(),
            qc_valid_period: $('input[name=qc_valid_period]', writeForm).val(),
            extend_yn: extend_yn,
            test_result_value0: $('input[name=test_result_value0]', writeForm).val(),
            test_result_pollination: $('input[name=test_result_pollination]', writeForm).val(),
            test_result_solvent: $('input[name=test_result_solvent]', writeForm).val()
        }

        const result = await $.ajax({
            type: 'POST',
            url: '/QualityControl/TestCheckESaveTestJudgment',
            data: {
                dto: JSON.stringify(objParam)
            }
        });
        return result;
    }

    async function TestCheckESetNextStatus(testcontrol_id, test_type, process_kind) {
        var objParam = { testcontrol_id: testcontrol_id, test_type: test_type, process_kind: process_kind };
        const result = await $.ajax({
            type: 'POST',
            url: '/QualityControl/TestCheckESetNextStatus',
            data: objParam
        });
        return result;
    }

    async function TestCheckECancelCheckInfo(testcontrol_id, test_type, process_cd) {
        var objParam = { testcontrol_id: testcontrol_id, test_type: test_type, process_cd: process_cd };
        const result = await $.ajax({
            type: 'POST',
            url: '/QualityControl/TestCheckECancelCheckInfo',
            data: {
                dto: JSON.stringify(objParam)
            }
        });
        return result;
    }

    function TestCheckECheckTestStatus(gridData) {
        var test_status_cd = gridData.test_status_cd;
        var test_judge_no = gridData.test_judge_no;

        var checkStatus = false;

        console.log(gridData);

        // 지시(12) 상태거나, // 확인 이전상태인 경우
        if ((test_status_cd == "12" || parseInt(test_status_cd) < 7) && !gridData.test_result_yn_c)
        {
            alert("[불가] 이전 단계가 완료되지 않거나, 시험 확인 결과가 입력되지 않았습니다.\n성적 확인 결과를 취소 할 수 없습니다.");
            checkStatus = false;
        } else if ((test_status_cd == "7" || test_status_cd == "8") && !test_judge_no && gridData.test_result_yn_c) {
            checkStatus = true;
        } else if (parseInt(test_status_cd) > 8) // 확인 다음상태인 경우
        {
            alert("[불가]승인된 정보는 취소할 수 없습니다.");
            checkStatus = false;
        }

        return checkStatus;
    }

    async function TestCheckESbReTest()
    {
        var gridDetail = $("#TestCheckEDetailGrid").dxDataGrid("instance");
        var gridSign = $("#TestCheckESignTable").dxDataGrid("instance");

        if (!gridDetail.option("focusedRowKey")) {
            return;
        }
        var gridDetailData = getGridRowByKey("TestCheckEDetailGrid", gridDetail.option("focusedRowKey"));
        var teststandardmaster_id = gridDetailData.teststandardmaster_id;
        var testcontrol_id = $('input[name=testcontrol_id]', $('#TestCheckEWriteForm')).val();

        if (_testCheckESignCnt > 0) {
            alert("이미 서명되었습니다.!");
            return;
        }

        var retest_check = gridDetail.retest_check;
        if (retest_check == "Y") {
            alert("[확인] 이미 재시험을 지시한 항목입니다.");
            return;
        }

        if (!confirm("[주의] 재시험 지시 하시겠습니까?")) {
            return;
        }

        var objParam = { testcontrol_id: testcontrol_id, teststandardmaster_id: teststandardmaster_id };
        const result = await $.ajax({
            type: 'POST',
            url: '/QualityControl/TestcheckEReTest',
            data: objParam
        });

        //detail 재조회
        TestCheckEFocusChanged();
    }
    //#endregion 프로그램별 함수
</script>

<style>

    /* 포커스된 시험의뢰 그리드 로우의 글자색 검정색으로(하이라이트 된 로우와 셀의 글자 잘 보기 위함) */
    #TestCheckEGrid .dx-datagrid-rowsview .dx-row-focused.dx-data-row .dx-command-edit .dx-link
    , #TestCheckEGrid .dx-datagrid-rowsview .dx-row-focused.dx-data-row > td:not(.dx-focused)
    , #TestCheckEGrid .dx-datagrid-rowsview .dx-row-focused.dx-data-row > tr > td:not(.dx-focused) {
        color: #242424;
    }

</style>


<div id="@(pagePrefix)" page-ctrl-name="@(pageControllerNm)" autoresize="N">

    <div id="TestCheckEItemPopup"></div>
    <div id="TestCheckEVenderPopup"></div>
    <div id="TestCheckEMakerPopup"></div>

    <div>
        @(Html.DevExtreme().Popup()
            .ID("TestCheckESignPopup")
            .Width(400)
            .Height(200)
            .ShowTitle(true)
            .Title("작업자 인증")
            .OnHidden("ClearTestCheckESignInput")
            .Visible(false)
            .DragEnabled(true)
            .CloseOnOutsideClick(false)
            .ContentTemplate(new JS("TestCheckESignPopupTemplate"))
        )
    </div>

    @using (Html.DevExtreme().NamedTemplate("TestCheckESignPopupTemplate"))
    {
        <h6>전자서명은 수기서명과 동일한 효력을 갖습니다.</h6>

        <form id="TestCheckESignForm" class="mb-1">

            <div class="input-wrapper mb-1">
                <label class="col-3">아이디</label>
                <input type="text" class="col-8 form-control" name="txt_ID">
            </div>
            <div class="input-wrapper">
                <label class="col-3">비밀번호</label>
                <input type="password" class="col-8 form-control" name="txt_Pass">
            </div>

            <div class="align-end-only">
                <button type="button" class="btn btn-secondary">확인</button>
            </div>

        </form>
    }

    <div class="mainTop row">

        <div class="col-8">

            <form id="@(pagePrefix)SearchForm">

                <div class="input-wrapper">

                    <div class="col-3 input-group input-group-sm">
                        <div class="input-group-prepend">
                            <span class="input-group-text">구분</span>
                        </div>
                        <label class="p-1"></label>

                        <div class="input-group-prepend">
                            <input class="input-group-append" type="radio" value="1" name="rg_ReqorRec" id="@(pagePrefix)selectdate1" checked />
                        </div>
                        <span class="form-control-sm"><label for="@(pagePrefix)selectdate1">의뢰</label></span>

                        <div class="input-group-prepend">
                            <input class="input-group-append" type="radio" value="2" id="@(pagePrefix)selectdate2" name="rg_ReqorRec" />

                        </div>
                        <span class="form-control-sm"><label for="@(pagePrefix)selectdate2">접수</label></span>
                        <div class="input-group-prepend">
                            <input class="input-group-append" type="radio" value="3" id="@(pagePrefix)selectdate3" name="rg_ReqorRec" />

                        </div>
                        <span class="form-control-sm"><label for="@(pagePrefix)selectdate3">승인</label></span>
                    </div>

                    <div class="input-group input-group-sm col-2">
                        <div class="input-group-prepend">
                            <span class="input-group-text">시험종류</span>
                        </div>
                        <select class="form-control" name="le_testitem_nm">
                            @foreach (DataRow row in ((DataTable)Public_Function.GetMaster("공통코드", "S", "QC004")).Rows)
                            {
                                <option value="@row["keyfield"]">@row["displayfield"]</option>
                            }
                        </select>
                    </div>

                    <div class="input-group input-group-sm col-2">
                        <div class="input-group-prepend">
                            <span class="input-group-text">진행상태</span>
                        </div>
                        <select class="form-control" name="rg_status">
                            <option value="%">전체</option>
                            <option value="1">대상</option>
                            <option value="2">완료</option>
                        </select>
                    </div>
                </div>
                <div class="input-wrapper">

                    <div class="col-3 input-group input-group-sm">
                        <div class="input-group-prepend">
                            <span class="input-group-text">기간</span>
                        </div>
                        <input type="text" class="form-control datepicker text-center" name="de_SDate" autocomplete="off">
                        <label class="col-1 form-text"> ~ </label>
                        <input type="text" class="form-control input-sm datepicker text-center" name="de_EDate" autocomplete="off">
                    </div>

                    <div class="input-group input-group-sm col-2">
                        <div class="input-group-prepend">
                            <span class="input-group-text">제형</span>
                        </div>
                        <select class="form-control" name="le_item_form_cd">
                            @foreach (DataRow row in ((DataTable)Public_Function.GetMaster("공통코드", "S", "CM065")).Rows)
                            {
                                <option value="@row["keyfield"]">@row["displayfield"]</option>
                            }
                        </select>
                    </div>

                    <div class="input-group input-group-sm col-4">
                        <div class="input-group-prepend">
                            <span class="input-group-text">검색어</span>
                        </div>
                        <select class="form-control" name="ce_gubun_number">
                            <option value="0">의뢰품목</option>
                            <option value="1">의뢰번호</option>
                            <option value="2">제조(관리)번호</option>
                        </select>
                        <input type="text" class="form-control input-sm text-center" name="te_number">
                    </div>

                </div>

            </form>

        </div>
        <!-- $CRUD버튼-->
        <div class="CRUD-btn col-4">
            @* === CRUD 버튼 === *@
            @{Html.SetToolbar(0, true, "Search;Delete;Print;Preview");}
        </div>
    </div>

    <div class="row mb-0">

        <div class="col-9 pr-1">
            <div class="box mb-0">

                @(Html.DevExtreme().DataGrid()
                    .ID("TestCheckEGrid")
                    .KeyExpr("testcontrol_id")
                    .Scrolling(scrolling => scrolling.Mode(GridScrollingMode.Virtual).ShowScrollbar(ShowScrollbarMode.Always))
                    .Height(580)
                    .ShowBorders(true)
                    .FocusedRowEnabled(true)
                    .FocusedRowIndex(0)
                    .SearchPanel(searchPanel => searchPanel.Visible(true))
                    .Export(e => e.Enabled(true).AllowExportSelectedData(true))
                    .ShowColumnLines(true)
                    .HoverStateEnabled(true)
                    .ColumnAutoWidth(true)
                    .AllowColumnResizing(true)
                    .Columns(c =>
                    {                       
                        
                        c.Add().DataField("test_type_nm").Caption("시험종류");
                        
                        c.Add().DataField("item_cd").Caption("품목코드");
                        c.Add().DataField("item_nm").Caption("품목");
                        c.Add().DataField("start_no").Caption("제조번호");
                        c.Add().DataField("test_no").Caption("시험번호");
                        c.Add().DataField("test_standard_nm_1").Caption("규격");
                        c.Add().DataField("process_nm").Caption("구분");
                        c.Add().DataField("test_result_yn").Caption("판정");
                        c.Add().DataField("test_status_nm").Caption("진행상태");
                        c.Add().DataField("request_date").Caption("의뢰일자");
                        c.Add().DataField("receive_date").Caption("접수일자");
                        c.Add().DataField("instruction_date").Caption("지시일자");
                        c.Add().DataField("test_date").Caption("승인일자");
                    })
                    .OnFocusedRowChanged("TestCheckEFocusChanged")
                    .OnRowPrepared("TestCheckEHighlightRow")
                    .OnCellPrepared("TestCheckEHighlightCell")
                    .OnToolbarPreparing("HideToolbarButton")
                )

            </div>
        </div>

        <div class="col-3 pl-0">

            <div class="box mb-0 flex-box-div">

                <div class="divName mb-1">
                    <p>성적서확인 정보</p>
                </div>

                <form id="TestCheckEWriteForm" class="mb-1">

                    <input name="gubun" hidden="hidden" />
                    <input name="testcontrol_id" hidden="hidden" />
                    <input type="hidden" name="test_result_value0" />

                    <div class="input-wrapper">
                        <label class="col-2 pr-0">적부판정</label>
                        <div class="input-group col-7">
                            <input type="radio" class="radio" id="TestCheckE_rg_YorN1" name="test_result_yn_c" value="Y" />
                            <label for="TestCheckE_rg_YorN1">적합</label>
                            <label class="p-2"></label>
                            <input type="radio" class="radio" id="TestCheckE_rg_YorN2" name="test_result_yn_c" value="N" />
                            <label for="TestCheckE_rg_YorN2">부적합</label>
                            <label class="p-2"></label>
                            <input type="radio" class="radio" id="TestCheckE_rg_YorN3" name="test_result_yn_c" value="C" />
                            <label for="TestCheckE_rg_YorN3">조건부적합</label>
                        </div>
                    </div>
                    <div class="input-wrapper">
                        <label class="col-2 pr-0">역가</label>
                        <div class="input-group col-2">
                            <input type="number" class="form-control" name="test_result_value" />
                        </div>
                        <label class="col-2 pr-0">수분함량</label>
                        <div class="input-group col-2">
                            <input type="number" class="form-control" name="test_result_pollination" />
                        </div>
                        <label class="col-1 pr-0 pl-0">용매</label>
                        <div class="input-group col-2">
                            <input type="number" class="form-control" name="test_result_solvent" />
                        </div>
                    </div>
                    <div class="input-wrapper">
                        <label class="col-2">비고</label>
                        <div class="input-group col-9">
                            <input type="text" class="form-control" name="test_inform_remark" />
                        </div>
                    </div>
                    <div class="input-wrapper">
                        <label class="col-2 pr-0">사용기한</label>
                        <div class="input-group col-5">
                            <input type="radio" class="radio" id="tc_rg_retest_yn1" name="retest_yn" value="Y" />
                            <label for="tc_rg_retest_yn1">재시험일자</label>
                            <label class="p-2"></label>
                            <input type="radio" class="radio" id="tc_rg_retest_yn2" name="retest_yn" value="N" />
                            <label for="tc_rg_retest_yn2">유통기한</label>
                        </div>
                        <div class="input-group col-3">
                            <input type="text" class="form-control datepicker align-center" name="valid_period" autocomplete="off"/>
                        </div>
                    </div>
                    <div class="input-wrapper">
                        <label class="col-3 pr-0">(QC)유통기한</label>
                        <div class="input-group col-3">
                            <input type="text" class="form-control datepicker" name="qc_valid_period" autocomplete="off"/>
                        </div>
                        <div class="input-group-append col-5">
                            <input type="checkbox" class="form-check" id="ck_extend_yn1" name="extend_yn" value="Y" />
                            부형제 기한연장
                        </div>
                    </div>
                </form>

                <div class="divName mb-1">
                    <p>전자서명 정보</p>
                </div>
                <div id="TestCheckETabContent_1" class="height-inherit">
                    @(Html.DevExtreme().DataGrid()
                    .ID("TestCheckESignTable")
                    .ShowBorders(true)
                    .ShowColumnLines(true)
                    .ShowRowLines(true)
                    .FocusedRowEnabled(true)
                    .FocusedRowIndex(0)
                    .KeyExpr("sign_set_dt_id")
                    .OnCellClick("TestCheckESign")
                    .Height(300)
                    .Selection(s => s.Mode(SelectionMode.Single))
                    .ColumnAutoWidth(true)
                    .AllowColumnResizing(true)
                    .ColumnResizingMode(ColumnResizingMode.Widget)
                    .ColumnChooser(cc => cc.Enabled(true))
                    .AllowColumnReordering(true)
                    .Columns(columns =>
                    {
                        columns.Add()
                            .DataField("displayfield")
                            //.Width("15%")
                            .Caption("구분");
                        columns.Add()
                            .DataField("sign_emp_nm")
                            //.Width("20%")
                            .Caption("서명자");
                        columns.Add()
                            .DataField("sign_time")
                            .Caption("서명일자");
                        columns.Add()
                            .AllowFiltering(false)
                            .AllowSorting(false)
                            .DataField("sign_image")
                            .Name("sign_image")
                            .Caption("서명")
                            //.Width("25%")
                            .CellTemplate(@<text>
                                    <div>
                                        <img src="<%- value %>" alt="" style="width:80px; height:25px;"/>
                                    </div>
                                </text>);
                        })
                    )

                </div>
                <!-- 탭버튼 controll 탭버튼 : 필요시 사용 -->
                @*<ul class="nav nav-tabs" id="TestCheckETab">
                    <li class="nav-item">
                        <a class="nav-link active" onclick="menutab('TestCheckETab', 'TestCheckETabContent', 1);">전자서명 정보</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" onclick="menutab('TestCheckETab', 'TestCheckETabContent', 2);">첨부파일</a>
                    </li>
                </ul>*@

                <!-- 탭 content : 필요시 사용 -->
                @*<div id="TestCheckETabContent" class="flex-grow-1">

                    <!-- 탭1: 전자서명 content-->
                    <div id="TestCheckETabContent_1" class="height-inherit">

                        @(Html.DevExtreme().DataGrid()
                                .ID("TestCheckESignTable")
                                .ShowBorders(true)
                                .ShowColumnLines(true)
                                .ShowRowLines(true)
                                .FocusedRowEnabled(true)
                                .FocusedRowIndex(0)
                                .KeyExpr("sign_set_dt_id")
                                .OnCellClick("TestCheckESign")
                                .Height(100)
                                .Selection(s => s.Mode(SelectionMode.Single))
                                .Columns(columns =>
                                {
                                    columns.Add()
                                        .DataField("displayfield")
                                        .Width("15%")
                                        .Caption("구분");
                                    columns.Add()
                                        .DataField("sign_emp_nm")
                                        .Width("20%")
                                        .Caption("서명자");
                                    columns.Add()
                                        .DataField("sign_time")
                                        .Caption("서명일자");
                                    columns.Add()
                                        .AllowFiltering(false)
                                        .AllowSorting(false)
                                        .DataField("sign_image")
                                        .Name("sign_image")
                                        .Caption("서명")
                                        .Width("25%")
                                        .CellTemplate(@<text>
                                            <div>
                                                <img src="<%- value %>" alt="" style="width:80px; height:25px;"/>
                                            </div>
                                        </text>);
                                })
                            )

                    </div>

                    <!-- 탭2: 파일관리 content-->
                    <div id="TestCheckETabContent_2" class="height-inherit">

                        <div class="align-end-only">
                            <button class="btn btn-secondary" id="TestCheckEUploadFileBtn">등록</button>
                            <button class="btn btn-secondary" id="TestCheckEDownloadFileBtn">다운로드</button>
                            <button class="btn btn-secondary" id="TestCheckEDeleteFileBtn">삭제</button>
                        </div>

                        @(Html.DevExtreme().FileUploader()
                                .Visible(false)
                                .ID("TestCheckEFileUploader")
                                .Name("TestCheckEAttatchedFile")
                                .Multiple(false)
                                .AllowedFileExtensions(new[] { ".hwp", ".doc", ".docx", ".dot", ".pdf", ".rtf"})
                                .UploadUrl(Url.Action("TestCheckEUploadFile", "TestReq"))
                                .UploadMode(FileUploadMode.Instantly)
                                .MaxFileSize(int.MaxValue)
                                .OnValueChanged("TestCheckEUploadFile")
                                .OnUploaded("TestCheckESelectFileList")
                            )
                        @(Html.DevExtreme().DataGrid()
                                .ID("TestCheckEFileGrid")
                                .ShowBorders(true)
                                .ShowColumnLines(true)
                                .ShowRowLines(true)
                                .FocusedRowEnabled(true)
                                .FocusedRowIndex(0)
                                .KeyExpr("testcontrol_id")
                                .Height(211)
                                .Selection(s => s.Mode(SelectionMode.Single))
                                .Columns(columns =>
                                {
                                    columns.Add()
                                        .DataField("doc_file_name")
                                        .Caption("파일명");
                                })
                            )

                    </div>

                </div> *@

            </div>

        </div>

    </div>
    <div class="row ml-0 mt-1 mb-1">
        <button type="button" class="btn btn-sm btn-dark pb-0 pt-0" id="sb_retest">재시험 지시</button>
    </div>
    <div class="row mb-0">
        <div class="col-10 pr-1">
            <div class="box mb-0">
                @(Html.DevExtreme().DataGrid()
                    .ID("TestCheckEDetailGrid")
                    .KeyExpr("teststandardmaster_id")
                    .Scrolling(scrolling => scrolling.Mode(GridScrollingMode.Virtual).ShowScrollbar(ShowScrollbarMode.Always))
                    .Height(220)
                    .ShowBorders(true)
                    .FocusedRowEnabled(true)
                    .FocusedRowIndex(0)
                    //.SearchPanel(searchPanel => searchPanel.Visible(false))
                    //.Export(e => e.Enabled(true).AllowExportSelectedData(true))
                    .ShowColumnLines(true)
                    .HoverStateEnabled(true)
                    .ColumnAutoWidth(true)
                    .AllowColumnResizing(true)
                    .Columns(c =>
                    {
                        c.Add().DataField("testitem_nm").Caption("시험항목");
                        c.Add().DataField("teststandard_nm").Caption("시험기준");
                        c.Add().DataField("reference_test_yn").Caption("참고시험");
                        c.Add().DataField("content_check").Caption("함량");
                        c.Add().DataField("testitem_result").Caption("시험결과");
                        c.Add().DataField("result_yn").Caption("판정");
                        c.Add().DataField("judge_date").Caption("시험일");
                        c.Add().DataField("testitem_emp_nm").Caption("시험자");
                        c.Add().DataField("testitem_result_remark").Caption("비고");
                        c.Add().DataField("backdata_yn").Caption("자료");
                        c.Add().DataField("data_check_yn").Caption("확인");
                        c.Add().DataField("retest_check").Caption("재시험");
                    })
                    .OnFocusedRowChanged("TestCheckEDetailFocusChanged")
                    //.OnRowPrepared("TestCheckEHighlightRow")
                    .OnCellPrepared("TestCheckEHighlightCell")
                    .OnToolbarPreparing("HideToolbarButton")
                )
            </div>
        </div>
        <div class="col-2 pl-0">
            <div class="box mb-0">
                <div class="align-end-only p-1">
                    <span class="align-center pr-3">첨부자료</span>
                    @*<button class="btn btn-secondary" id="TestCheckEUploadFileBtn">등록</button>*@
                    <button class="btn btn-secondary" id="TestCheckEDownloadFileBtn">다운로드</button>
                    @*<button class="btn btn-secondary" id="TestCheckEDeleteFileBtn">삭제</button>*@
                </div>

                @(Html.DevExtreme().FileUploader()
                    .Visible(false)
                    .ID("TestCheckEFileUploader")
                    .Name("TestCheckEAttatchedFile")
                    .Multiple(false)
                    .AllowedFileExtensions(new[] { ".hwp", ".doc", ".docx", ".dot", ".pdf", ".rtf"})
                    .UploadUrl(Url.Action("TestCheckEUploadFile", "QualityControl"))
                    .UploadMode(FileUploadMode.Instantly)
                    .MaxFileSize(int.MaxValue)
                    .OnValueChanged("TestCheckEUploadFile")
                    .OnUploaded("TestCheckESelectFileList")
                )
                @(Html.DevExtreme().DataGrid()
                    .ID("TestCheckEFileGrid")
                    .ShowBorders(true)
                    .ShowColumnLines(true)
                    .ShowRowLines(true)
                    .FocusedRowEnabled(true)
                    .FocusedRowIndex(0)
                    .KeyExpr("test_back_data_id")
                    .Height(190)
                    .Selection(s => s.Mode(SelectionMode.Single))
                    .Columns(columns =>
                    {
                        columns.Add()
                            .DataField("doc_file_name")
                            .Caption("파일명");
                    })
                )
            </div>
        </div>
    </div>

</div>