@*제조관리 / 제조 마스터 / 포장표준서 마스터 관리*@
@using System.Data
@using HACCP.Libs
@using HACCP.Libs.Views

@{
    //*********************************************************
    // ▣ 페이지 공통 정의
    //*********************************************************

    //1. 페이지 접두어 지정
    var pagePrefix = ViewContext.RouteData.Values["action"].ToString();
    var pageControllerNm = ViewContext.RouteData.Values["controller"].ToString();

    ViewBag.Title = pagePrefix;
    Layout = null;
}

@{
    //*********************************************************
    // ▣ 페이지별 설정
    //*********************************************************

    var PackingItems = Html.Raw(Json.Encode(ViewBag.PackingItems.Data));
    var Employees = Html.Raw(Json.Encode(ViewBag.Employees.Data));
    var Workrooms = Html.Raw(Json.Encode(ViewBag.Workrooms.Data));
    var WorkroomHardwares = Html.Raw(Json.Encode(ViewBag.WorkroomHardwares.Data));
    var Items = Html.Raw(Json.Encode(ViewBag.Items.Data));
    var Equipments = Html.Raw(Json.Encode(ViewBag.Equipments.Data));
    var Processes = Html.Raw(Json.Encode(ViewBag.Processes.Data));
    var CommonCodes = Html.Raw(Json.Encode(ViewBag.CommonCodes.Data));
    var ItemProcess = Html.Raw(Json.Encode(ViewBag.ItemProcess.Data));
    var ItemProcessDetail = Html.Raw(Json.Encode(ViewBag.ItemProcessDetail.Data));
    var Packingmaterial = Html.Raw(Json.Encode(ViewBag.Packingmaterial.Data));
    var ccp = Html.Raw(Json.Encode(ViewBag.ccp.Data));

}

<script id="@(pagePrefix)Js">

    var PagePrefix        = "@(pagePrefix)";                //js사용, 페이지접두어
    var PageControllerNm  = "@(pageControllerNm)";          //js사용, 페이지컨트롤러명
    var FormNmSearch      = PagePrefix + "SearchForm";      // 폼명-검색용
    var FormNmWrite       = PagePrefix + "WriteForm";       // 폼명-등록용

    var _itemGuide2PackingItemInfo;
    var _itemGuide2SignCnt = 0;
    var _itemGuide2RevisionNo = "";
    var _itemGuide2SignGubun = "";
    var _itemGuide2IsEditing = false;
    var _itemGuide2CellClickEvent;
    var _itemGuide2Changes = new Array();
    var _itemGuide2SignData;

    UtilView.m_controller = PageControllerNm;
    UtilView.m_actionPrefix = PagePrefix;

    $(function () {
        ItemGudie2_ContentResize();

        ItemGuide2_TreeListTransferChagne();


        var popupColumns = {
            "packingItem": [{ dataField: "item_cd", caption: "제품코드", width:"35%" }, { dataField: "item_nm", caption: "제품명" }]
            , "employee":  [{ dataField: "emp_cd", caption: "사원코드" }, { dataField: "emp_nm", caption: "사원명" }, { dataField: "dept_cd", caption: "부서코드" }, { dataField: "dept_nm", caption: "부서명" }]
            , "workroom": [{ dataField: "workroom_cd", caption: "작업실코드", width: "25%" }, { dataField: "workroom_nm", caption: "작업실명", width: "45%"}, { dataField: "common_part_nm", caption: "팀구분" }]
            , "material": [{ dataField: "item_cd", caption: "품목코드" }, { dataField: "item_nm", caption: "품목명" }]
            , "equipment": [{ dataField: "equip_cd", caption: "설비코드" }, { dataField: "equip_nm", caption: "설비명" }]
            , "ccp": [{ dataField: "ccp_cd", caption: "ccp코드" }, { dataField: "ccp_nm", caption: "ccp명" }, { dataField: "ccp_description", caption: "ccp종류" }]
        };

        createPopup(PagePrefix + "PackingItem", "제품 조회", @PackingItems, popupColumns.packingItem);
        createPopup(PagePrefix + "PackingItem2", "제품 조회", @PackingItems, popupColumns.packingItem);
        createPopup(PagePrefix + "PackingItem3", "제품 조회", @PackingItems, popupColumns.packingItem);
        createPopup(PagePrefix + "PackingItem4", "제품 조회", @PackingItems, popupColumns.packingItem);

        createPopup(PagePrefix + "Emp", "사원 조회", @Employees, popupColumns.employee);

        createPopup(PagePrefix + "Workroom1", "작업실조회 조회", @Workrooms, popupColumns.workroom);
        createPopup(PagePrefix + "Workroom2", "작업실조회 조회", @WorkroomHardwares, popupColumns.workroom);

        createPopup(PagePrefix + "ItemGuideMaterial", "원료조회", @Packingmaterial, popupColumns.material);

        createPopup(PagePrefix + "Equipment", "설비조회", @Equipments, popupColumns.equipment);
        createPopup(PagePrefix + "Ccp", "ccp조회", @ccp, popupColumns.ccp);

        $("#ItemGuide2StandardProcessGrid").dxDataGrid("option", "dataSource", JSON.parse(@ItemProcess));

        $("#ItemGuide2DetailProcessGrid").dxDataGrid("option", "dataSource", JSON.parse(@ItemProcessDetail));

        $("#ItemGuide2ProcessDiv").addClass("col-12");

        ItemGuide2EditCheck(false);

    });



    // 수정중인지 체크
    function ItemGuide2EditCheck(nowEdit) {

        var item_cd = $("#ItemGuide2SearchForm input[name=item_cd]").val();
        var revision_no = $("#ItemGuide2SearchForm select[name=revision_no]").val();

        _itemGuide2IsEditing = nowEdit;

        if (nowEdit) {
            // 툴바 활성/비활성
            $('#ItemGuide2Save, #ItemGuide2Undo').dxButton().parent().parent().removeClass("display-none");
            $('#ItemGuide2Search, #ItemGuide2Input,#ItemGuide2Edit,#ItemGuide2Delete').dxButton().parent().parent().addClass("display-none");

            $("#" + PagePrefix + "ProcessDiv div.align-end-only button").prop("disabled", true);

            //그리드 및 폼 활성/비활성
            $('input', $('#ItemGuide2WriteForm')).attr("disabled", false);
            $('textarea', $('#ItemGuide2WriteForm')).attr("disabled", false);

            $('#ItemGuide2WriteForm' + ' .datepicker').datepicker({
                format: "yyyy-mm-dd",	//데이터 포맷 형식(yyyy : 년 mm : 월 dd : 일 )
                autoclose: true,	//사용자가 날짜를 클릭하면 자동 캘린더가 닫히는 옵션
                templates: {
                    leftArrow: '&laquo;',
                    rightArrow: '&raquo;'
                }, //다음달 이전달로 넘어가는 화살표 모양 커스텀 마이징
                todayHighlight: true,	//오늘 날짜에 하이라이팅 기능 기본값 :false
                toggleActive: false,	//이미 선택된 날짜 선택하면 기본값 : false인경우 그대로 유지 true인 경우 날짜 삭제
                weekStart: 0,//달력 시작 요일 선택하는 것 기본값은 0인 일요일
                language: "ko"	//달력의 언어 선택, 그에 맞는 js로 교체해줘야한다.
            });

            var editing = {
                allowUpdating: true,
                selectTextOnEditStart: true,
                mode: 'batch'
            }

            $("#ItemGuide2itemProcessExamDataGrid").dxDataGrid("option", "editing", editing);

            editing = {
                allowUpdating: true,
                allowAdding: true,
                allowDeleting: true,
                mode: 'batch'
            }

            $("#ItemGuide2itemWorkGuideDataGrid").dxDataGrid("option", "editing", editing);

        }
        else {
            // 툴바 활성/비활성
            $('#ItemGuide2Save, #ItemGuide2Undo').dxButton().parent().parent().addClass("display-none");
            $('#ItemGuide2Search, #ItemGuide2Input,#ItemGuide2Delete').dxButton().parent().parent().removeClass("display-none");

            $("#" + PagePrefix + "ProcessDiv div.align-end-only button").prop("disabled", false);

            if (item_cd && revision_no) {
                $('#ItemGuide2Edit').dxButton().parent().parent().removeClass("display-none");
            } else {
                $('#ItemGuide2Edit').dxButton().parent().parent().addClass("display-none");
            }

            //그리드 및 폼 활성/비활성
            $("input", $('#ItemGuide2WriteForm')).attr("disabled", true);
            $("textarea", $('#ItemGuide2WriteForm')).attr("disabled", true);
            _itemGuide2RevisionNo = "";

            $('#ItemGuide2WriteForm' + ' .datepicker').datepicker('destroy');

            var editing = {
                allowUpdating: false,
                selectTextOnEditStart: false,
                mode: 'batch'
            }

            $("#ItemGuide2itemProcessExamDataGrid").dxDataGrid("option", "editing", editing);

            editing = {
                allowUpdating: false,
                allowAdding: false,
                allowDeleting: false,
                mode: 'batch'
            }

            $("#ItemGuide2itemWorkGuideDataGrid").dxDataGrid("option", "editing", editing);
        }

    }

    // 검색용 제품 팝업
    function ItemGuide2SearchPackingItem() {
        $("#ItemGuide2PackingItemPopup").dxPopup("instance").show();
    }

    // 제품 팝업2
    function ItemGuide2SearchItem2() {

        var popup = $("#ItemGuide2PackingItem2Popup").dxPopup("instance");

        popup.show();
    }

    // 제품 팝업3
    function ItemGuide2SearchItem3() {

        var popup = $("#ItemGuide2PackingItem3Popup").dxPopup("instance");

        popup.show();
    }

    // 제품 팝업4
    function ItemGuide2SearchItem4() {

        var popup = $("#ItemGuide2PackingItem4Popup").dxPopup("instance");

        popup.show();

    }


    // 제조 공정도 팝업
    function ItemGuide2_ProcessInfomationPopup() {
        var data = {
            item_cd: $("#ItemGuide2 #ItemGuide2SearchForm input[name='item_cd']").val(),
            revision_no: $("#ItemGuide2 #ItemGuide2SearchForm select[name='revision_no'] option:selected").val(),
            order_type: 'P'
        }


        $.ajax({
            type: "POST",
            url: '/ProductionMaster/ProcInfoPopupView',
            data: data,
            success: function (result) {
                if (result[0] != null) {
                    var jsonData = new Array();
                    for (let i = 0; i < result.length; i++) {

                        if (result[i] != "" && result[i] != null) {
                            jsonData[i] = JSON.parse(result[i]);
                        }
                        else {
                            jsonData[i] = result[i];
                        }

                    }


                    var popup = $("#ItemGuide2_ProcessInfomationPopup").dxPopup('instance');
                    popup.option("contentTemplate", $("#ItemGuide2_ProcessInfomationPopupTemplate"));
                    popup.show();

                    var itemsWidth = 1.2;
                    var maxItmesLength = 0;

                    $("#ItemGuide2_ProcInfoDiagram").dxDiagram({
                        nodes: {
                            dataSource: new DevExpress.data.ArrayStore({
                                key: "this",
                                data: ItemGuide2_ProcInfoReplace(jsonData[0])
                            }),
                            keyExpr: "item_cd",
                            textExpr: "item_text",
                            typeExpr: "item_type",
                            heightExpr: function () { return 0.8 },
                            widthExpr: function (e) {
                                var length = e.item_text.length;

                                if (length > maxItmesLength) {
                                    maxItmesLength = length
                                }

                                if (maxItmesLength >= 13) {
                                    itemsWidth = 1.8;
                                } else {
                                    itemsWidth = 1.2;
                                }

                                return itemsWidth;
                            }
                        },
                        edges: {
                            dataSource: new DevExpress.data.ArrayStore({
                                key: "this",
                                data: jsonData[1]
                            }),
                            keyExpr: "item_cd",
                            fromExpr: "item_from",
                            toExpr: "item_to"
                        },
                    });

                } else {
                    alert("공정정보가 없습니다.");

                    return;
                }
            }
        })
    }

    function ItemGuide2_ProcInfoReplace(arry) {

        for (var i in arry) {

            if ((arry[i].item_text).indexOf("\\n") != -1) {
                arry[i].item_text = arry[i].item_text.replace("\\n", "\n");
            }
        }

        return arry;
    }


    // 검색용 제품 팝업 선택
    function ItemGuide2PackingItemRowDblClick(selectedItems) {

        var data = selectedItems.data;

        $('input[name=item_cd]', $('#ItemGuide2SearchForm')).val(data.item_cd);
        $('input[name=item_nm]', $('#ItemGuide2SearchForm')).val(data.item_nm);

        $.ajax({
            type: 'POST',
            url: '/Comm/GetSelectBoxOption',
            async: false,
            data: {
                pGb: "포장개정번호",
                pDiv: "S",
                pItemCd: data.item_cd,
                pTableName: "ItemGuideRevisionNo"
            },
            success: function (result) {

                $("#ItemGuide2SearchForm select").empty();
                $("#ItemGuide2SearchForm select").append(result);

                if ($("#ItemGuide2SearchForm select option").length > 1) {

                    if (data.revision_no) {
                        $("#ItemGuide2SearchForm select").val(data.revision_no).prop("selected", true);
                    } else {
                        $("#ItemGuide2SearchForm select option:eq(1)").prop("selected", true);
                    }

                } else {
                    $("#ItemGuide2SearchForm select option:eq(0)").prop("selected", true);
                }

                ItemGuide2GetItemDetail();

            }

        });

        $("#ItemGuide2PackingItemPopup").dxPopup("instance").hide();
    }

    // 제품 팝업2 데이터로우 더블클릭
    function ItemGuide2PackingItem2RowDblClick(selectedItems) {

        $("#ItemGuideItemCode2").val(selectedItems.values[0]);
        $("#ItemGuideItemName2").val(selectedItems.values[1]);

        $.ajax({
            type: 'POST',
            url: '/Comm/GetSelectBoxOption',
            data: {
                pGb: "배치사이즈3",
                pDiv: "D",
                pItemCd: selectedItems.values[0],
                pTableName: "ItemGuideQuantity"
            },
            success: function (result) {

                $("#ItemGuideQuantity2").empty();
                $("#ItemGuideQuantity2").append(result);

                if ($("#ItemGuideQuantity2 option").length > 1) {
                    $("#ItemGuideQuantity2 option:eq(1)").prop("selected", true);
                } else {
                    $("#ItemGuideQuantity2 option:eq(0)").prop("selected", true);
                }

                GetRevisionNumber2();
            }
        });

        var popup = $("#ItemGuideItem2Popup").dxPopup("instance");

        popup.hide();
    }

    // 제품 팝업3 데이터로우 더블클릭
    function ItemGuide2PackingItem3RowDblClick(selectedItems) {

        var popup = $("#ItemGuideItem3Popup").dxPopup("instance");
        popup.hide();
    }

    // 제품 팝업4 데이터로우 더블클릭
    function ItemGuide2PackingItem4RowDblClick(selectedItems) {

        var data = selectedItems.data;

        $("#ItemGuide2ProcessDetailCopyDiv input[name=item_cd]").val(data.item_cd);
        $("#ItemGuide2ProcessDetailCopyDiv input[name=item_nm]").val(data.item_nm);

        $.ajax({
            type: 'POST',
            url: '/Comm/GetSelectBoxOption',
            data: {
                pGb: "포장개정번호2",
                pDiv: "S",
                pItemCd: data.item_cd,
                pTableName: "ItemGuide2Revision"
            },
            success: function (result) {

                $("#ItemGuide2ProcessDetailCopyDiv select[name = Revision_no]").empty();
                $("#ItemGuide2ProcessDetailCopyDiv select[name = Revision_no]").append(result);

                if ($("#ItemGuide2ProcessDetailCopyDiv select[name = Revision_no] option").length > 1) {
                    $("#ItemGuide2ProcessDetailCopyDiv select[name = Revision_no] option:eq(1)").prop("selected", true);
                } else {
                    $("#ItemGuide2ProcessDetailCopyDiv select[name = Revision_no] option:eq(0)").prop("selected", true);
                }
            }
        });

        var popup = $("#ItemGuide2PackingItem4Popup").dxPopup("instance");
        popup.hide();
    }

    // 타품목에서 복사
    function ItemGuide2CopyProcess() {

        var treeList = $("#ItemGuide2ProcessTreeList").dxTreeList("instance");

        if (treeList.option("dataSource").length > 0) {
            alert("복사하기 전 현재 공정을 삭제해주세요.");

            return;
        }

        if ($("#ItemGuide2SearchForm select[name=revision_no]").val() === "NEW") {
            alert("수정할 수 없습니다. 개정순번을 선택하세요.");
            return;
        }

        //if (!$("#ItemGuide2ProcessDetailCopyDiv select[name = Revision_no]").val()) {
        //    alert("개정번호를 입력해주세요");
        //    return;
        //}

        //if ($("#ItemGuide2SearchForm input[name=item_cd]").val() == "" || $("#ItemGuide2SearchForm input[name=item_nm]").val() === "" || $("#ItemGuide2SearchForm select[name=revision_no]").val() === "NEW") {
        //    alert("데이터를 복사할 대상품목을 입력해 주십시오.");
        //    return;
        //}

        //if ($("#ItemGuide2ProcessDetailCopyDiv input[name=item_cd]").val() == "" || $("#ItemGuide2ProcessDetailCopyDiv input[name=item_nm]").val() === "" || $("#ItemGuide2ProcessDetailCopyDiv select[name=revision_no]").val() === "") {
        //    alert("데이터를 복사할 원본품목을 입력해 주십시오.");
        //    return;
        //}

        $.ajax({
            type: 'POST',
            url: '/ProductionMaster/ItemGuide2CopyProcess',
            data: {
                gubun: "C2",
                item_cd: $("#ItemGuide2SearchForm input[name=item_cd]").val(),
                t_item_cd: $("#ItemGuide2ProcessDetailCopyDiv input[name=item_cd]").val(),
                new_revision_no: $("#ItemGuide2SearchForm select[name=revision_no]").val(),
                revision_no: $("#ItemGuide2ProcessDetailCopyDiv select[name = Revision_no]").val(),
            },
            success: function (result) {

                ItemGuide2getProcessInfo();

            }
        });
    }

    // 조회
    function ItemGuide2GetItemDetail() {

        _itemGuide2PackingItemInfo = "";

        var item_cd = $("#ItemGuide2SearchForm input[name=item_cd]").val();
        var revision_no =$("#ItemGuide2SearchForm select[name=revision_no]").val();

        if (!_itemGuide2IsEditing) {
            revision_no = $("#ItemGuide2SearchForm select[name=revision_no]").val();

            if (item_cd && revision_no) {
                $('#ItemGuide2Edit').dxButton().parent().parent().removeClass("display-none");
            } else {
                $('#ItemGuide2Edit').dxButton().parent().parent().addClass("display-none");
            }
        }

        if (revision_no === "NEW") {

            $("#ItemGuide2WriteForm")[0].reset();
            $("#ItemGuide2WriteForm" + " textarea").text("");

            $("#ItemGuide2SignTable").dxDataGrid("option", "dataSource", []);
            $("#ItemGuide2SignTable").dxDataGrid("option", "focusedRowKey", "");

            $("#ItemGuide2ProcessTreeList").dxTreeList("option", "dataSource", []);
            $("#ItemGuide2ProcessTreeList").dxTreeList("option", "focusedRowKey", "");

            $("#ItemGuide2BomGrid").dxDataGrid("option", "dataSource", []);
            $("#ItemGuide2BomGrid").dxDataGrid("option", "focusedRowKey", "");

            return;
        }

        $.ajax({
            type: 'GET',
            url: '/ProductionMaster/ItemGuide2GetItemInfo',
            data: {
                item_cd: item_cd,
                revision_no: revision_no
            },
            async: false,
            success: function (result) {

                var jsonData = new Array();

                for (var i = 0; i < result.length; i++) {

                    if (result[i] != "" && result[i] != null) {
                        jsonData[i] = JSON.parse(result[i]);
                    }
                    else {
                        jsonData[i] = result[i];
                    }
                }

                _packingItemInfo = jsonData[0];
                if (jsonData[0].length <= 0) {
                    return;
                }

                if (!_itemGuide2IsEditing) {

                    $("#ItemGuide2WriteForm" + " input[name=revision_num]").val(jsonData[0][0].revision_num);
                    $("#ItemGuide2WriteForm" + " input[name=revision_use_date]").val(jsonData[0][0].revision_use_date);
                    $("#ItemGuide2WriteForm" + " input[name=revision_special_mention]").val(jsonData[0][0].revision_special_mention);
                    $("#ItemGuide2WriteForm" + " textarea[name=revision_remark]").text(jsonData[0][0].revision_remark);

                    if (jsonData[0][0].revision_current_ck === "Y") {
                        $("#ItemGuide2 input[name=revision_current_ck]").prop("checked", true);
                    } else {
                        $("#ItemGuide2 input[name=revision_current_ck]").prop("checked", false);
                    }

                    if (jsonData[0][0].revision_sign_end_ck === "Y") {
                        $("#ItemGuide2 input[name=revision_sign_end_ck]").prop("checked", true);
                    } else {
                        $("#ItemGuide2 input[name=revision_sign_end_ck]").prop("checked", false);
                    }

                    _itemGuide2SignCnt = 0;
                }

                $.each(jsonData[1], function () {
                    _itemGuide2SignCnt += Number(this.sign_yn);
                });

                $("#ItemGuide2SignTable").dxDataGrid("option", "dataSource", jsonData[1]);

                if (jsonData[2].length < 1) {
                    $("#ItemGuide2ProcessTreeList").dxTreeList("option", "dataSource", []);
                    $("#ItemGuide2ProcessTreeList").dxTreeList("option", "focusedRowKey", "");
                } else {

                    $("#ItemGuide2ProcessTreeList").dxTreeList("option", "dataSource", jsonData[2]);
                    //$("#ItemGuide2ProcessTreeList").dxTreeList("option", "focusedRowKey", jsonData[2][0].mykey);
                    $("#ItemGuide2ProcessTreeList").dxTreeList("option", "focusedRowIndex", -1);
                }

                ItemGuide2TreeListAllExpand();

                if (jsonData[3].length < 1) {
                    $("#ItemGuide2BomGrid").dxDataGrid("option", "dataSource", []);
                    $("#ItemGuide2BomGrid").dxDataGrid("option", "focusedRowKey", "");

                } else {
                    $("#ItemGuide2BomGrid").dxDataGrid("option", "dataSource", jsonData[3]);
                }
            }
        });
    }


    function ItemGuide2TreeListAllExpand() {
        var treeList = $("#ItemGuide2ProcessTreeList").dxTreeList("instance");
        var data = treeList.option("dataSource");

        for (var i = 0; i < data.length; i++) {
            if (data[i].level == "1") {
                treeList.expandRow(data[i].mykey);
            }
        }
    }

    // 제/개정 정보 버튼 클릭
    function ItemGuide2RevisionInfoToggle() {

        var isVisible = $("#ItemGuide2RevisionInfoDiv").hasClass("display-none");

        if (isVisible) {
            $("#ItemGuide2RevisionInfoDiv").removeClass("display-none");
        } else {
            $("#ItemGuide2RevisionInfoDiv").addClass("display-none");
        }

        ItemGudie2_ContentResize();
    }

    // 공정정보 버튼 클릭
    function ItemGuide2ProcessToggle() {

        var isCollapsed = $("#ItemGuide2ProcessDiv").hasClass("col-3");

        $("#ItemGuide2BomToggle").prop("checked", false);
        $("#ItemGuide2itemProcessExamToggle").prop("checked", false);
        $("#ItemGuide2itemWorkGuideToggle").prop("checked", false);


        if (isCollapsed) {

            if ($("#ItemGuide2ProcessDetailDiv").hasClass("display-none")) {

                $("#ItemGuide2ProcessDetailDiv").removeClass("display-none");

                $("#ItemGuide2BomDiv").addClass("display-none");
                $("#ItemGuide2itemProcExamDiv").addClass("display-none");
                $("#ItemGuide2itemWorkGuideDiv").addClass("display-none");

                return;
            }

            ItemGuide2ProcessTreelistColapse(true);

            $("#ItemGuide2ProcessDetailDiv").addClass("display-none");

            $("#ItemGuide2BomDiv").addClass("display-none");
            $("#ItemGuide2itemProcExamDiv").addClass("display-none");
            $("#ItemGuide2itemWorkGuideDiv").addClass("display-none");


        } else {

            ItemGuide2ProcessTreelistColapse(false);

            $("#ItemGuide2DetailProcessGrid").dxDataGrid("option", "dataSource", JSON.parse(@ItemProcessDetail));

            $("#ItemGuide2ProcessDetailDiv").removeClass("display-none");

            $("#ItemGuide2BomDiv").addClass("display-none");
            $("#ItemGuide2itemProcExamDiv").addClass("display-none");
            $("#ItemGuide2itemWorkGuideDiv").addClass("display-none");
        }
    }

    // 사용자재 정보 버튼 클릭
    function ItemGuide2BomToggle() {
        var isCollapsed = $("#ItemGuide2ProcessDiv").hasClass("col-3");

        $("#ItemGuide2ProcessToggle").prop("checked", false);
        $("#ItemGuide2itemProcessExamToggle").prop("checked", false);
        $("#ItemGuide2itemWorkGuideToggle").prop("checked", false);

        if (isCollapsed) {

            if ($("#ItemGuide2BomDiv").hasClass("display-none")) {

                $("#ItemGuide2BomDiv").removeClass("display-none");

                $("#ItemGuide2ProcessDetailDiv").addClass("display-none");
                $("#ItemGuide2itemProcExamDiv").addClass("display-none");
                $("#ItemGuide2itemWorkGuideDiv").addClass("display-none");

                return;
            }

            ItemGuide2ProcessTreelistColapse(true);

            $("#ItemGuide2BomDiv").addClass("display-none");

            $("#ItemGuide2ProcessDetailDiv").addClass("display-none");
            $("#ItemGuide2itemProcExamDiv").addClass("display-none");
            $("#ItemGuide2itemWorkGuideDiv").addClass("display-none");

        } else {

            ItemGuide2ProcessTreelistColapse(false);

            $("#ItemGuide2BomDiv").removeClass("display-none");

            $("#ItemGuide2ProcessDetailDiv").addClass("display-none");
            $("#ItemGuide2itemProcExamDiv").addClass("display-none");
            $("#ItemGuide2itemWorkGuideDiv").addClass("display-none");

        }
    }

    // 공정검사 설정 버튼
    function ItemGuide2itemProcessExamToggle() {
        var isCollapsed = $("#ItemGuide2ProcessDiv").hasClass("col-3");

        $("#ItemGuide2ProcessToggle").prop("checked", false);
        $("#ItemGuide2BomToggle").prop("checked", false);
        $("#ItemGuide2itemWorkGuideToggle").prop("checked", false);

        var processCd = "";

        if ($("#ItemGuide2ProcessTreeList").dxTreeList("instance").option("focusedRowIndex") >= 0) {
            processCd = $("#ItemGuide2ProcessTreeList").dxTreeList("instance").getNodeByKey($("#ItemGuide2ProcessTreeList").dxTreeList("option", "focusedRowKey")).data.process_cd;
        }

        if (isCollapsed) {

            if ($("#ItemGuide2itemProcExamDiv").hasClass("display-none")) {

                $("#ItemGuide2itemProcExamDiv").removeClass("display-none");
                if ($("#ItemGuide2ProcessTreeList").dxTreeList("instance").getDataSource() != null) {
                    ItemGuide2getProcExam(processCd);
                }

                $("#ItemGuide2ProcessDetailDiv").addClass("display-none");
                $("#ItemGuide2BomDiv").addClass("display-none");
                $("#ItemGuide2itemWorkGuideDiv").addClass("display-none");

                return;
            }

            ItemGuide2ProcessTreelistColapse(true);

            $("#ItemGuide2itemProcExamDiv").addClass("display-none");

            $("#ItemGuide2ProcessDetailDiv").addClass("display-none");
            $("#ItemGuide2BomDiv").addClass("display-none");
            $("#ItemGuide2itemWorkGuideDiv").addClass("display-none");

        } else {

            ItemGuide2ProcessTreelistColapse(false);

            $("#ItemGuide2itemProcExamDiv").removeClass("display-none");
            if ($("#ItemGuide2ProcessTreeList").dxTreeList("instance").getDataSource() != null) {
                ItemGuide2getProcExam(processCd);
            }

            $("#ItemGuide2ProcessDetailDiv").addClass("display-none");
            $("#ItemGuide2BomDiv").addClass("display-none");
            $("#ItemGuide2itemWorkGuideDiv").addClass("display-none");
        }
    }

    // 작업방법 설정 버튼
    function ItemGuide2itemWorkGuideToggle() {

        var isCollapsed = $("#ItemGuide2ProcessDiv").hasClass("col-3");

        $("#ItemGuide2ProcessToggle").prop("checked", false);
        $("#ItemGuide2BomToggle").prop("checked", false);
        $("#ItemGuide2itemProcessExamToggle").prop("checked", false);

        var processCd = "";

        if ($("#ItemGuide2ProcessTreeList").dxTreeList("instance").option("focusedRowIndex") >= 0) {

            processCd = $("#ItemGuide2ProcessTreeList").dxTreeList("instance").getNodeByKey($("#ItemGuide2ProcessTreeList").dxTreeList("option", "focusedRowKey")).data.process_cd;
        }

        if (isCollapsed) {

            if ($("#ItemGuide2itemWorkGuideDiv").hasClass("display-none")) {

                $("#ItemGuide2itemWorkGuideDiv").removeClass("display-none");
                if ($("#ItemGuide2ProcessTreeList").dxTreeList("instance").getDataSource() != null) {
                    ItemGuide2getWorkGuide(processCd);
                }

                $("#ItemGuide2ProcessDetailDiv").addClass("display-none");
                $("#ItemGuide2BomDiv").addClass("display-none");
                $("#ItemGuide2itemProcExamDiv").addClass("display-none");

                return;
            }

            ItemGuide2ProcessTreelistColapse(true);

            $("#ItemGuide2itemWorkGuideDiv").addClass("display-none");

            $("#ItemGuide2ProcessDetailDiv").addClass("display-none");
            $("#ItemGuide2BomDiv").addClass("display-none");
            $("#ItemGuide2itemProcExamDiv").addClass("display-none");

        } else {

            ItemGuide2ProcessTreelistColapse(false);

            $("#ItemGuide2itemWorkGuideDiv").removeClass("display-none");
            if ($("#ItemGuide2ProcessTreeList").dxTreeList("instance").getDataSource() != null) {
                ItemGuide2getWorkGuide(processCd);
            }

            $("#ItemGuide2ProcessDetailDiv").addClass("display-none");
            $("#ItemGuide2BomDiv").addClass("display-none");
            $("#ItemGuide2itemProcExamDiv").addClass("display-none");
        }
    }

    function ItemGuide2ProcessTreelistColapse(isOk) {

        if (isOk) {

            $("#ItemGuide2ProcessTreeList").dxTreeList("columnOption", "next_process_nm", "visible", true);
            $("#ItemGuide2ProcessTreeList").dxTreeList("columnOption", "item_proc_qc_ck", "visible", true);
            $("#ItemGuide2ProcessTreeList").dxTreeList("columnOption", "item_proc_transfer_ck", "visible", true);
            $("#ItemGuide2ProcessTreeList").dxTreeList("columnOption", "workroom_nm", "visible", true);
            $("#ItemGuide2ProcessTreeList").dxTreeList("columnOption", "standard_proc_time", "visible", true);
            $("#ItemGuide2ProcessTreeList").dxTreeList("columnOption", "item_proc_warehouse", "visible", true);
            $("#ItemGuide2ProcessTreeList").dxTreeList("columnOption", "item_proc_warehouse_nm", "visible", true);
            $("#ItemGuide2ProcessTreeList").dxTreeList("columnOption", "item_proc_standard_weight_qty", "visible", true);
            $("#ItemGuide2ProcessTreeList").dxTreeList("columnOption", "item_proc_standard_weight_unit", "visible", true);
            $("#ItemGuide2ProcessTreeList").dxTreeList("columnOption", "item_proc_content", "visible", true);
            $("#ItemGuide2ProcessTreeList").dxTreeList("columnOption", "item_proc_manage_rate_min", "visible", true);
            $("#ItemGuide2ProcessTreeList").dxTreeList("columnOption", "item_proc_manage_rate_max", "visible", true);

            $("#ItemGuide2ProcessDiv").removeClass("col-3");
            $("#ItemGuide2ProcessDiv").removeClass("pr-0");
            $("#ItemGuide2ProcessDiv").addClass("col-12");

            ItemGuide2_TreeListTransferChagne();

        } else {

            $("#ItemGuide2ProcessTreeList").dxTreeList("columnOption", "next_process_nm", "visible", false);
            $("#ItemGuide2ProcessTreeList").dxTreeList("columnOption", "item_proc_qc_ck", "visible", false);
            $("#ItemGuide2ProcessTreeList").dxTreeList("columnOption", "item_proc_transfer_ck", "visible", false);
            $("#ItemGuide2ProcessTreeList").dxTreeList("columnOption", "workroom_nm", "visible", false);
            $("#ItemGuide2ProcessTreeList").dxTreeList("columnOption", "standard_proc_time", "visible", false);
            $("#ItemGuide2ProcessTreeList").dxTreeList("columnOption", "item_proc_warehouse", "visible", false);
            $("#ItemGuide2ProcessTreeList").dxTreeList("columnOption", "item_proc_warehouse_nm", "visible", false);
            $("#ItemGuide2ProcessTreeList").dxTreeList("columnOption", "item_proc_standard_weight_qty", "visible", false);
            $("#ItemGuide2ProcessTreeList").dxTreeList("columnOption", "item_proc_standard_weight_unit", "visible", false);
            $("#ItemGuide2ProcessTreeList").dxTreeList("columnOption", "item_proc_content", "visible", false);
            $("#ItemGuide2ProcessTreeList").dxTreeList("columnOption", "item_proc_manage_rate_min", "visible", false);
            $("#ItemGuide2ProcessTreeList").dxTreeList("columnOption", "item_proc_manage_rate_max", "visible", false);

            $("#ItemGuide2ProcessDiv").removeClass("col-12");
            $("#ItemGuide2ProcessDiv").addClass("col-3");
            $("#ItemGuide2ProcessDiv").addClass("pr-0");
        }
    }

    // 포커스된 공정의 세부공정 필터
    function ItemGuide2GetItemProcess() {

        if (arguments[0].rowIndex >= 0) {
            $("#" + PagePrefix + "DetailProcessGrid").dxDataGrid("instance").clearSelection();

            if ($("#" + PagePrefix + "ProcessTreeList").dxTreeList("instance").getDataSource()) {
                if ($("#" + PagePrefix + "ProcessDiv").hasClass("col-3")) {

                    var standardProcessCd = arguments[0].row.node.data.standard_process_cd;

                    //$("#" + PagePrefix + "DetailProcessGrid").dxDataGrid("option", "focusedRowIndex", 0);
                    $("#" + PagePrefix + "DetailProcessGrid").dxDataGrid("instance").filter([
                        ["process_cd", "startswith", standardProcessCd.substring(0, 2)]
                    ]);
                }
            }
        }
    }


    // 조건별 조회
    function ItemGuide2SelectWithCondition() {

        var popup = $("#ItemGuide2RevisionPopup").dxPopup("instance");
        popup.option("contentTemplate", $("#ItemGuide2RevisionPopupTemplate"));
        popup.show();

        $("#latestRevisionCk").prop("checked", false);
        $("#revisionSignEndCk").prop("checked", false);
        $("#revisionCurrentCk").prop("checked", false);

        SetItemGuide2RevisionDataSource();

    }

    // 개정조회 팝업 데이터 소스
    function SetItemGuide2RevisionDataSource() {

        if ($("#revisionCurrentCk2").prop("checked")) {
            $("#revisionSignEndCk2").prop("checked", true);
        }

        var ck1 = $("#latestRevisionCk2").prop("checked");
        var ck2 = $("#revisionSignEndCk2").prop("checked");
        var ck3 = $("#revisionCurrentCk2").prop("checked");

        $.ajax({
            type: 'GET',
            url: '/ProductionMaster/GetItemGuide2RevisionData',
            data: {
                latestRevisionCk: ck1,
                revisionSignEndCk: ck2,
                revisionCurrentCk: ck3
            },
            success: function (result) {

                $("#ItemGuide2RevisionGrid").dxDataGrid("option", "dataSource", JSON.parse(result));
            }
        });

    }

    // 개정조회 팝업 선택
    function ItemGuide2RevisionSelect(selectedItems) {
        ItemGuide2Undo();
        ItemGuide2PackingItemRowDblClick(selectedItems);

        var popup = $("#ItemGuide2RevisionPopup").dxPopup("instance");

        popup.hide();
    }

    // 공정 타품목 복사 메뉴  버튼 클릭
    function ItemGuide2ProcessDetailCopyToggle() {

        var condition = $("#ItemGuide2ProcessDetailCopyToggle").prop("checked");

        if (!condition) {
            $("#ItemGuide2StandardProcessDiv").removeClass("display-none");
            $("#ItemGuide2DetailProcessDiv").removeClass("display-none");
            $("#ItemGuide2ProcessDetailCopyDiv").addClass("display-none");
        } else {
            $("#ItemGuide2StandardProcessDiv").addClass("display-none");
            $("#ItemGuide2DetailProcessDiv").addClass("display-none");
            $("#ItemGuide2ProcessDetailCopyDiv").removeClass("display-none");
        }

    }


    function ItemGuide2_DbClickProcessInsert(e) {
        var grid = $("#ItemGuide2ProcessTreeList").dxTreeList("instance");
        if (grid.totalCount() < 0) {
            return;
        }

        if (e.data.process_type == "ZZ") {
            ItemGuide2AddProcess("Standard");
        } else {
            ItemGuide2AddProcess("Detail");
        }
    }


    // 대표공정 추가
    function ItemGuide2AddProcess(type) {

        if (!_itemGuide2IsEditing) {
            alert("수정중일때만 변경가능합니다.")
            return;
        }

        var startingKey;
        var processCd;

        var pGubun;

        if (type === "Standard") {
            pGubun = "MC1";

            var datagrid = $("#ItemGuide2StandardProcessGrid").dxDataGrid("instance");
            var datagrid2 = $("#ItemGuide2ProcessTreeList").dxTreeList("instance");

            if (datagrid.option("focusedRowIndex") >= 0) {
                startingKey = getGridRowByKey("ItemGuide2StandardProcessGrid", datagrid.option("focusedRowKey")).process_cd;
            } else {
                alert("선택된 대표공정이 없습니다.");

                return;
            }


            if (datagrid2.getSelectedRowsData().length > 0) {
                processCd = datagrid2.getSelectedRowsData();
                processCd = processCd[0].process_cd;
                processCd = processCd.substring(0, processCd.length - 1);
                processCd += "0";


            }

        }
        else if (type === "Detail") {
            pGubun = "MC4";

            var datagrid = $("#ItemGuide2DetailProcessGrid").dxDataGrid("instance");
            var datagrid2 = $("#ItemGuide2ProcessTreeList").dxTreeList("instance");

            startingKey = getGridRowByKey("ItemGuide2DetailProcessGrid", datagrid.option("focusedRowKey")).process_cd;
            processCd = datagrid2.getNodeByKey(datagrid2.option("focusedRowKey")).data.standard_process_cd;
        }

        var data = {
            gubun: pGubun,
            item_cd: $("#ItemGuide2SearchForm input[name=item_cd]").val(),
            revision_no: _itemGuide2RevisionNo,
            process_cd: processCd,
            startingkey: startingKey
        };

        data = "[" + JSON.stringify(data) + "]";

        $.ajax({
            type: 'POST',
            url: '/ProductionMaster/ItemGuide2ProcessTRX',
            data: {
                processsData: data
            },
            dataType: 'json',
            success: function (result) {


            }
        });

        ItemGuide2getProcessInfo();
        ItemGuide2TreeListAllExpand();
    }

    // 공정 삭제
    function ItemGuide2DeleteProcess(type) {

        if (_itemGuide2SignCnt > 0) {
            alert("승인이 시작된 자료는 수정할 수 없습니다.");
            return;
        }


        if ($("#" + PagePrefix + "SearchForm select[name='revision_no']").val() == null) {
            alert("삭제할 수 없습니다. 품목을 선택하세요.");

            return;
        }

        if ($("#ItemGuide2 input[name=revision_current_ck]").prop("checked")) {
            alert("현개정은 삭제할 수 없습니다.");
            return;
        }

        if (type === 0) {

            var datagrid = $("#ItemGuide2ProcessTreeList").dxTreeList("instance");

            if (datagrid.option("selectedRowKeys").length <= 0) {
                alert("선택된 공정이 없습니다.");

                return;
            }

            var gridData = datagrid.getNodeByKey(datagrid.option("focusedRowKey")).data;

            var data = {
                gubun: "D",
                item_cd: $("#ItemGuide2SearchForm input[name=item_cd]").val(),
                revision_no: $("#ItemGuide2SearchForm select[name=revision_no]").val(),
                process_cd: gridData.process_cd
            };

            data = "[" + JSON.stringify(data) + "]";

            $.ajax({
                type: 'POST',
                url: '/ProductionMaster/ItemGuide2ProcessTRX',
                data: {
                    processsData: data
                },
                dataType: 'json',
                success: function (result) {

                }
            });
            ItemGuide2GetItemDetail();

        } else if (type === 1) {

            if (!confirm("모든 공정을 삭제하시겠습니까?")) {
                return;
            }

            var datagrid = $("#ItemGuide2ProcessTreeList").dxTreeList("instance");
            var data = datagrid.option("dataSource");

            data.forEach(function (element) {

                if (element.level == 1) {

                    var pData = {
                        gubun: "D",
                        item_cd: $("#ItemGuide2SearchForm input[name=item_cd]").val(),
                        revision_no: $("#ItemGuide2SearchForm select[name=revision_no]").val(),
                        process_cd: element.process_cd
                    };

                    pData = "[" + JSON.stringify(pData) + "]";

                    $.ajax({
                        type: 'POST',
                        url: '/ProductionMaster/ItemGuide2ProcessTRX',
                        data: {
                            processsData: pData
                        },
                        dataType: 'json',
                        async: false,
                        success: function (result) {

                        }
                    });
                }
            });

            ItemGuide2GetItemDetail();
        }
    }

    // 공정 위치 조정
    function ItemGuide2MoveProcess(type, method) {
        var _focusIndexTemp = 0;
        if (!_itemGuide2IsEditing) {
            alert("수정중일때만 변경가능합니다.")
            return;
        }

        var datagrid = $("#ItemGuide2ProcessTreeList").dxTreeList("instance");
        if (datagrid.option("focusedRowIndex") >= 0) {
            data = treeListGetFocusedRowData("ItemGuide2ProcessTreeList");
            _focusIndexTemp = datagrid.option("focusedRowIndex");
        } else {
            alert("선택된 공정이 없습니다.");

            return;
        }

        var processCd = data.process_cd;


        var ds = datagrid.getDataSource()._items;
        var length1 = 0;
        var length2 = 0;

        for (var i = 0; i < ds.length; i++) {
            if (ds[i].data.level === "1") {

                length1++;

                if (data.standard_process_cd === ds[i].data.process_cd) {
                    length2 = ds[i].children.length;
                }
            }
        }


        var pGubun;

        if (type === "Standard") {

            if (data.level != "1") {
                alert("대표공정을 선택해주세요.");
                return;
            }

            if (method === "UP") {

                if (data.seq <= 1) {
                    alert("첫번째 공정입니다.");
                    return;
                }

                _focusIndexTemp++;

                pGubun = "U4";
            } else if (method === "DOWN") {

                if (data.seq >= length1) {

                    alert("마지막 공정입니다.");
                    return;
                }

                _focusIndexTemp--;

                pGubun = "U5";
            }

        } else if (type === "Detail") {

            if (data.level != "2") {
                alert("세부공정을 선택해주세요.");
                return;
            }

            if (method === "UP") {

                if (data.seq <= 1) {
                    alert("첫번째 공정입니다.");
                    return;
                }

                _focusIndexTemp++;

                pGubun = "U8";
            } else if (method === "DOWN") {

                if (data.seq >= length2) {
                    alert("마지막 공정입니다.");
                    return;
                }

                _focusIndexTemp--;

                pGubun = "U9";
            }

        }

        var pData = {
            gubun: pGubun,
            item_cd: $("#ItemGuide2SearchForm input[name=item_cd]").val(),
            revision_no: $("#ItemGuide2SearchForm select[name=revision_no]").val(),
            process_cd: processCd,
            process_seq: data.seq,
            standard_process_cd: processCd.substring(0, processCd.length - 1) + "0",
            type: type
        };

        $.ajax({
            type: 'POST',
            url: '/ProductionMaster/ItemGuide2MoveProcess',
            data: pData,
            success: function (result) {
                ItemGuide2getProcessInfo(_focusIndexTemp);
            }
        });

    }


    // 공정정보 얻어오기
    function ItemGuide2getProcessInfo() {
        $.ajax({
            type: 'POST',
            url: '/ProductionMaster/GetProcessInfo2',
            data: {
                pGubun: "S2",
                item_cd: $("#ItemGuide2ItemCode").val(),
                revision_no: $("#" + PagePrefix + "SearchForm #revision_no").val()
            },
            success: function (result) {

                if (result <= 0) return;

                var _focusIndexTemp = -1;
                if (arguments.length > 0) {
                    _focusIndexTemp = arguments[0];
                }

                $("#" + PagePrefix + "ProcessTreeList").dxTreeList("option", "dataSource", []);
                $("#" + PagePrefix + "ProcessTreeList").dxTreeList("option", "dataSource", JSON.parse(result));
                $("#" + PagePrefix + "ProcessTreeList").dxTreeList("option", "focusedRowEnabled", true);
                $("#" + PagePrefix + "ProcessTreeList").dxTreeList("option", "focusedRowIndex", _focusIndexTemp);
            }

        });
    }


    // 전자서명
    function ItemGuide2Sign(e) {

        if (e.columnIndex == 3) {
            _itemGuide2SignGubun = "U";

            _itemGuide2SignData = e.data;

            if (e.data.prev_sign_yn == "0") {
                alert("먼저 앞 단계 승인이 필요합니다.");
                return;
            }

            if (e.data.sign_yn == "1") {

                if (ItemGuide2CheckWorkOrder()) { //포장 대장이 있을 경우
                    alert("해당 개정에 대한 포장지시가 존재합니다. 서명을 취소할 수 없습니다. 개정을 새로 작성하세요.");
                    return;
                }

                if (confirm("이미 승인 되었습니다. 서명을 삭제하시겠습니까?")) {
                    _itemGuide2SignGubun = "U3";
                } else {
                    return;
                }

                if (e.data.next_sign_yn == "1") {
                    alert("이미 다음 단계가 승인 되어 있습니다.\n먼저 다음 단계 승인을 삭제(취소)해주세요. ");
                    return;
                }
            }

            var popup = $("#ItemGuide2SignPopup").dxPopup("instance");
            popup.option("contentTemplate", $("#ItemGuide2SignPopupTemplate"));
            popup.show();

        }

    }

    // 서명 권한 체크(id, pw)
    function itemGuide2SignSubmit() {

        var data = new FormData($('#ItemGuide2SignForm')[0]);

        var datagrid = $("#ItemGuide2SignTable").dxDataGrid("instance");

        data.set("gubun", "S");

        $.ajax({
            type: 'POST',
            url: '/Comm/IDValidation',
            data: data,
            contentType: false,
            processData: false,
            success: function (result) {

                if (result.length <= 0) {
                    alert("잘못된 ID,PW 입니다.");
                    return;
                }

                var isOK = false;

                if (_itemGuide2SignData.responsible_emp_cd !== JSON.parse(result)[0].emp_cd) {

                    $.ajax({
                        type: 'GET',
                        url: '/Comm/DelegateCheck',
                        data: {
                            emp_cd: JSON.parse(result)[0].emp_cd,
                            sign_set_cd: "2004",
                            sign_set_seq: _itemGuide2SignData.sign_set_dt_seq
                        },
                        async: false,
                        success: function (result) {

                            if (result.length > 0) {
                                isOK = true;
                            } else {
                                isOK = false;
                            }
                        }
                    });
                } else {
                    isOK = true;
                }

                if (!isOK) {
                    alert("권한이 없는 사용자입니다.");
                    return;
                }

                $("input[name='dept_nm']").val(JSON.parse(result)[0].dept_nm);
                $("input[name='emp_nm']").val(JSON.parse(result)[0].emp_nm);

                var last_seq = false;
                if (datagrid.option("dataSource").length == getGridRowByKey("ItemGuide2SignTable", datagrid.option("focusedRowKey")).sign_set_dt_seq) {
                    last_seq = true;
                }

                setTimeout(function () {

                    $.ajax({
                        type: 'POST',
                        url: '/ProductionMaster/ItemGuide2SignCRUD',
                        data: {
                            gubun: _itemGuide2SignGubun,
                            c_seq: getGridRowByKey("ItemGuide2SignTable", datagrid.option("focusedRowKey")).sign_set_dt_seq,
                            emp_cd: JSON.parse(result)[0].emp_cd,
                            item_cd: $("#ItemGuide2SearchForm input[name=item_cd]").val(),
                            revision_no: $("#ItemGuide2SearchForm select[name=revision_no]").val(),
                            validation_type: "2",
                            signLength: datagrid.option("dataSource").length,
                            current_ck: $("#ItemGuide22Form2 input[name=revision_current_ck]").prop("checked"),
                            last_seq: last_seq
                        },
                        success: function (result) {


                        }
                    });

                    _itemGuide2SignGubun = "";
                    ItemGuide2GetItemDetail();

                    var popup = $("#ItemGuide2SignPopup").dxPopup("instance");
                    popup.hide();
                }, 1000);

            }
        });

    }

    // 서명 인풋 초기화
    function clearSignInput() {
        $('#ItemGuide2SignForm')[0].reset();
        $("#ItemGuide2SignForm input[name='dept_nm']").val("");
        $("#ItemGuide2SignForm input[name='emp_nm']").val("");
    }


    // 조회
    function ItemGuide2Search() {
        $("#ItemGuide2BomGrid").dxDataGrid("instance").clearSorting();
        ItemGuide2GetItemDetail();
    }


    // 입력
    function ItemGuide2Input() {

        var item_cd = $("#ItemGuide2SearchForm input[name=item_cd]").val();

        if (!item_cd){
            alert("품목을 선택해야 합니다.");
            return;
        }

        var popup = $("#ItemGuide2AddPopup").dxPopup("instance");
        popup.option("contentTemplate", $("#itemguide2AddPopupTemplate"));

        popup.show();

        $("#ItemGuide2InputForm input[name=item_cd]").val($("#ItemGuide2SearchForm input[name=item_cd]").val());
        $("#ItemGuide2InputForm input[name=item_nm]").val($("#ItemGuide2SearchForm input[name=item_nm]").val());


        $("#ItemGuide2WriteForm")[0].reset();
        $("#ItemGuide2ProcessTreeList").dxTreeList("option", "dataSource", []);
        $("#ItemGuide2ProcessTreeList").dxTreeList("option", "focusedRowKey", "");
        $("#ItemGuide2SignTable").dxDataGrid("option", "dataSource", []);

        $('#itemguide2DatePicker').datepicker({
            format: "yyyy-mm-dd",	//데이터 포맷 형식(yyyy : 년 mm : 월 dd : 일 )
            autoclose: true,	//사용자가 날짜를 클릭하면 자동 캘린더가 닫히는 옵션
            templates: {
                leftArrow: '&laquo;',
                rightArrow: '&raquo;'
            }, //다음달 이전달로 넘어가는 화살표 모양 커스텀 마이징
            todayHighlight: true,	//오늘 날짜에 하이라이팅 기능 기본값 :false
            toggleActive: false,	//이미 선택된 날짜 선택하면 기본값 : false인경우 그대로 유지 true인 경우 날짜 삭제
            weekStart: 0,//달력 시작 요일 선택하는 것 기본값은 0인 일요일
            language: "ko"	//달력의 언어 선택, 그에 맞는 js로 교체해줘야한다.

        });//datepicker end

        //$.ajax({
        //    type: 'POST',
        //    url: '/ProductionMaster/ItemGuide2RevisionTRX',
        //    data: {
        //        gubun: "C",
        //        item_cd: $("#ItemGuide2SearchForm input[name=item_cd]").val()
        //    },
        //    success: function (result) {
        //        _itemGuide2RevisionNo = result;

        //    }
        //});
    }

    // 수정
    function ItemGuide2Edit() {
        _itemGuide2RevisionNo = $("#ItemGuide2SearchForm select[name=revision_no]").val();

        if (_itemGuide2RevisionNo == null) {
            alert("수정할 수 없습니다. 품목을 선택하세요.");

            return;
        }

        if (_itemGuide2RevisionNo === "NEW") {
            alert("수정할 수 없습니다. 개정번호을 선택하세요.");
            return;
        }

        if (_itemGuide2SignCnt > 0) {
            alert("승인이 시작된 자료는 수정할 수 없습니다.");
            return;
        }

        var editing = {
            allowUpdating: true,
            selectTextOnEditStart: true,
            mode: 'batch'
        }

        $("#ItemGuide2ProcessTreeList").dxTreeList("option", "editing", editing);

        ItemGuide2EditCheck(true);

    }

    // 삭제
    function ItemGuide2Delete() {
        _itemGuide2RevisionNo = $("#ItemGuide2SearchForm select[name=revision_no]").val();
        var isChecked = $("#ItemGuide22Form2 input[name=revision_current_ck]").prop("checked");

        if (_itemGuide2RevisionNo == null) {
            alert("삭제할 수 없습니다. 품목을 선택하세요.");

            return;
        }

        if (isChecked) {
            alert("현개정은 삭제할 수 없습니다.");
            return;
        }

        if (_itemGuide2SignCnt > 0) {
            alert("이미 승인이 시작된 자료는 삭제할 수 없습니다.");
            return;
        }

        var treeList = $("#ItemGuide2ProcessTreeList").dxTreeList("instance");

        if (treeList.option("dataSource").length > 0) {

            if (confirm("선택된 공정정보를 삭제하시겠습니까?")) {
                ItemGuide2DeleteProcess(0);
            }
        } else {
            if (_itemGuide2RevisionNo === "NEW") {
                alert("삭제할 수 없습니다. 개정번호을 선택하세요.");
                return;
            }


            if (confirm("선택된 개정정보를 삭제하시겠습니까?")) {

                var formData = new FormData($('#ItemGuide2SearchForm')[0]);

                formData.set("gubun", "Delete_All");

                $.ajax({
                    type: 'POST',
                    url: '/ProductionMaster/ItemGuide2RevisionTRX',
                    data: formData,
                    contentType: false,
                    processData: false,
                    async: false,
                    success: function (result) {

                        $.ajax({
                            type: 'POST',
                            url: '/Comm/GetSelectBoxOption',
                            async: false,
                            data: {
                                pGb: "포장개정번호",
                                pDiv: "S",
                                pItemCd: $('input[name=item_cd]', $('#ItemGuide2SearchForm')).val(),
                                pTableName: "ItemGuideRevisionNo"
                            },
                            success: function (result) {

                                $("#ItemGuide2SearchForm select").empty();
                                $("#ItemGuide2SearchForm select").append(result);

                                $("#ItemGuide2SearchForm select option:eq(0)").prop("selected", true);

                                ItemGuide2GetItemDetail();

                            }
                        });

                    }
                });
            }
        }
    }


    // 저장
    async function ItemGuide2Save() {

        if (confirm("저장하시겠습니까?")) {

            var treeList = $("#ItemGuide2ProcessTreeList").dxTreeList("instance");
            var formData = new FormData($('#ItemGuide2WriteForm')[0]);

            formData.set("gubun", "U0");
            formData.set("item_cd", $('#ItemGuide2SearchForm' + " input[name=item_cd]").val());
            formData.set("revision_no", _itemGuide2RevisionNo);

            $.ajax({
                type: 'POST',
                url: '/ProductionMaster/ItemGuide2RevisionTRX',
                data: formData,
                contentType: false,
                processData: false,
                async: false,
                success: function (result) {

                }
            });


            var editing = {
                allowUpdating: false,
                selectTextOnEditStart: false,
            }

            //if ($("#ItemGuide2ProcessDiv").hasClass("col-12")) {
                if (! await ItemGuide2_WorkroomCheck()) {
                    alert("작업실을 선택하세요.");
                    return;
                }
            //}

            await ItemGuide2_PrevProcessInsert();
            await ItemGuide2_ProcessGroupInsert();
            await treeList.saveEditData();
            treeList.option("editing", editing);

            editing = {
                allowUpdating: false,
                allowAdding: false,
                allowDeleting: false,
                mode: 'row'
            }



            // 작업방법 정보 저장
            if ($("#ItemGuide2itemWorkGuideToggle").prop("checked")) {
                if (treeList.option("focusedRowIndex") < 0) {
                    alert("공정을 선택해야 작업방법을 입력 할 수 있습니다");

                    return;
                }

            }

            await $("#ItemGuide2itemWorkGuideDataGrid").dxDataGrid("instance").saveEditData();
            $("#ItemGuide2itemWorkGuideDataGrid").dxDataGrid("option", "editing", editing);


            // CCP코드가 등록되지 않은 공정은 공정검사를 사용할 수 없도록
            var data = treeListGetFocusedRowData("ItemGuide2ProcessTreeList");
            if (data.ccp_cd != null && data.ccp_cd.length > 0) {

                var examGrid = $("#ItemGuide2itemProcessExamDataGrid").dxDataGrid("instance");
                var examData = examGrid.getVisibleRows();
                var count = 0;

                for (var i = 0; i < examData.length; i++) {

                    if (examData[i].data.application_ck == true || examData[i].data.application_ck == "Y") {
                        count++;

                        continue;
                    }
                }

                if (count <= 0 && examData.length > 0) {
                    alert("설정된 공정검사가 없습니다.\nCCP코드를 제거하거나 공정검사를 설정해주세요.");

                    return;
                }
            }

            await $("#ItemGuide2itemProcessExamDataGrid").dxDataGrid("instance").saveEditData();
            $("#ItemGuide2itemProcessExamDataGrid").dxDataGrid("option", "editing", editing);



            $.ajax({
                type: 'POST',
                url: '/ProductionMaster/ItemGuide2ProcessTRX',
                data: {
                    processsData: JSON.stringify(_itemGuide2Changes)
                },
                dataType: 'json',
                success: function (result) {
                    ItemGuide2GetItemDetail();
                }
            });

            $.ajax({
                type: 'POST',
                url: '/Comm/GetSelectBoxOption',
                async: false,
                data: {
                    pGb: "포장개정번호",
                    pDiv: "S",
                    pItemCd: $('input[name=item_cd]', $('#ItemGuide2SearchForm')).val(),
                    pTableName: "ItemGuideRevisionNo"
                },
                success: function (result) {

                    $("#ItemGuide2SearchForm select").empty();
                    $("#ItemGuide2SearchForm select").append(result);

                    $("#ItemGuide2SearchForm select").val(_itemGuide2RevisionNo).prop("selected", true);

                    ItemGuide2GetItemDetail();

                }
            });



            ItemGuide2EditCheck(false);
            ItemGuide2GetItemDetail();
            _itemGuide2Changes = new Array();
        }

    }


    // 개정 저장
    function ItemGuide2Add() {
        if (!UtilView.checkValidForm("ItemGuide2InputForm")) {
            return;
        }
        var formData = new FormData($('#ItemGuide2InputForm')[0]);
        formData.set("gubun", "C");

        $.ajax({
            type: 'POST',
            url: '/ProductionMaster/ItemGuide2RevisionTRX',
            data: formData,
            contentType: false,
            processData: false,
            async: false,
            success: function (result) {
                if (result == 0) {

                    ItemGuide2LoadInfo();

                } else if (result == 1) {
                    alert("동일한 개정번호가 있습니다. 확인해주세요.");

                } else if (result == 2) {
                    alert("개정생성에 실패했습니다.");

                }
            }
        });
    }


    // 개정 생성 후 재조회
    async function ItemGuide2LoadInfo() {
        var item_cd = $("#ItemGuide2ItemCode3").val();

        var popup = $("#ItemGuide2AddPopup").dxPopup("instance");
        popup.hide();

        $.ajax({
            type: 'POST',
            url: '/Comm/GetSelectBoxOption',
            async: false,
            data: {
                pGb: "포장개정번호",
                pDiv: "S",
                pItemCd: item_cd,
                pTableName: "ItemGuideRevisionNo"
            },
            success: function (result) {

                $("#ItemGuide2SearchForm select").empty();
                $("#ItemGuide2SearchForm select").append(result);
                $("#ItemGuide2SearchForm select option:last").prop("selected", true);

                ItemGuide2GetItemDetail();
            }

        });
    }


    // 다음공정 자동 입력
    function ItemGuide2_PrevProcessInsert() {
        var treeList = $("#ItemGuide2ProcessTreeList").dxTreeList("instance");
        if (treeList.getDataSource().totalCount() > 0) {
            var treeData = treeList.getDataSource()._items;

            for (var i = 0; i < treeData.length; i++) {
                if (i == treeData.length - 1) {
                    return;
                }

                // 다음공정이 빈값일 경우에만 자동으로 다음공정을 입력
                //if (treeData[i].data.level != "1" && treeList.cellValue(i, "next_process_cd") == null) {
                //    if (treeData[i + 1].data.level != "1") {
                //        treeList.cellValue(i, "next_process_cd", treeData[i + 1].data.process_cd);
                //        treeList.cellValue(i, "next_process_nm", treeData[i + 1].data.fieldname);
                //    } else {
                //        treeList.cellValue(i, "next_process_cd", treeData[i + 2].data.process_cd);
                //        treeList.cellValue(i, "next_process_nm", treeData[i + 2].data.fieldname);
                //    }
                //}

                if (treeData[i + 1].data.level != "1") {
                    treeList.cellValue(i, "next_process_cd", treeData[i + 1].data.process_cd);
                    treeList.cellValue(i, "next_process_nm", treeData[i + 1].data.fieldname);
                } else {
                    treeList.cellValue(i, "next_process_cd", treeData[i + 2].data.process_cd);
                    treeList.cellValue(i, "next_process_nm", treeData[i + 2].data.fieldname);
                }
            }
        }
    }


    function ItemGuide2_ProcessGroupInsert() {
        var treeList = $("#ItemGuide2ProcessTreeList").dxTreeList("instance");

        if (treeList.getDataSource().totalCount() > 0) {
            var treeData = treeList.getDataSource()._items;
            for (var i = 0; i < treeData.length; i++) {
                if (treeData[i].data.level == "1" && (treeList.cellValue(i, "grouping_cd") == null || treeList.cellValue(i, "grouping_cd").length <= 0)) {

                    treeList.cellValue(i, "grouping_cd", "1");
                }
            }
        }
    }


    // 취소
    function ItemGuide2Undo() {

        var editing = {
            allowUpdating: false,
            selectTextOnEditStart: false,
        }

        $("#ItemGuide2ProcessTreeList").dxTreeList("option", "editing", editing);
        ItemGuide2EditCheck(false);
        _itemGuide2Changes = new Array();

    }

    // 공정 트리리스트 cell 클릭 이벤트
    function ItemGuide2GridPopup(e) {

        if (!$("#ItemGuide2itemProcExamDiv").hasClass("display-none")) {
            ItemGuide2getProcExam(e.data.process_cd);
        }

        if (!$("#ItemGuide2itemWorkGuideDiv").hasClass("display-none")) {
            ItemGuide2getWorkGuide(e.data.process_cd);
        }

        if (!_itemGuide2IsEditing) {
            return;
        }

        _itemGuide2CellClickEvent = e;        

        if (e.row.data.level != "1") {
            switch (e.column.dataField) {
                case "next_process_nm":
                    ItemGuide2_getProcPopup();
                    break;
                case "workroom_nm":
                    var workroomPopup1 = $("#ItemGuide2Workroom1Popup").dxPopup("instance");
                    workroomPopup1.show();
                    break;
                case "item_proc_warehouse_nm":
                    var workroomPopup2 = $("#ItemGuide2Workroom2Popup").dxPopup("instance");
                    workroomPopup2.show();
                    break;
                case "ccp_nm":
                    var ccpPopup = $("#ItemGuide2CcpPopup").dxPopup("instance");
                    ccpPopup.show();
                    break;
            }
        }
    }


    // 다음공정 팝업
    function ItemGuide2_getProcPopup() {
        var treeList = $("#ItemGuide2ProcessTreeList").dxTreeList("instance");
        var treeData = treeList.getVisibleRows();
        var processArry = new Array();

        for (var i = 0; i < treeData.length; i++) {
            if (treeData[i].data.level == "1") {

                continue;

            } else {

                var _data = {
                    process_cd: treeData[i].data.process_cd,
                    process_nm: treeData[i].data.fieldname
                }

                processArry.push(_data);
            }
        }

        var columns = [
            { dataField: "process_cd", caption: "공정코드" },
            { dataField: "process_nm", caption: "공정명" }
        ];

        createPopup(PagePrefix + "Process", "공정조회", JSON.stringify(processArry), columns);

        var processPopup = $("#ItemGuide2ProcessPopup").dxPopup("instance");
        processPopup.show();
    }


    // 공정 조회 팝업 더블클릭
    function ItemGuide2ProcessRowDblClick(selectedItems) {

        var data = selectedItems.data;

        var dataGrid = $("#ItemGuide2ProcessTreeList").dxTreeList("instance");
        dataGrid.cellValue(_itemGuide2CellClickEvent.rowIndex, "next_process_cd", data.process_cd);
        dataGrid.cellValue(_itemGuide2CellClickEvent.rowIndex, "next_process_nm", data.process_nm);

        var popup = $("#ItemGuide2ProcessPopup").dxPopup("instance");

        popup.hide();
    }

    // 작업실 조회 팝업1 더블클릭
    function ItemGuide2Workroom1RowDblClick(selectedItems) {

        var data = selectedItems.data;

        var dataGrid = $("#ItemGuide2ProcessTreeList").dxTreeList("instance");
        dataGrid.cellValue(_itemGuide2CellClickEvent.rowIndex, "workroom_nm", data.workroom_nm);
        dataGrid.cellValue(_itemGuide2CellClickEvent.rowIndex, "workroom_cd", data.workroom_cd);

        var popup = $("#ItemGuide2Workroom1Popup").dxPopup("instance");

        popup.hide();
    }

    // 작업실 조회 팝업2 더블클릭
    function ItemGuide2Workroom2RowDblClick(selectedItems) {

        var data = selectedItems.data;

        var dataGrid = $("#ItemGuide2ProcessTreeList").dxTreeList("instance");
        dataGrid.cellValue(_itemGuide2CellClickEvent.rowIndex, "item_proc_warehouse", data.workroom_cd);
        dataGrid.cellValue(_itemGuide2CellClickEvent.rowIndex, "item_proc_warehouse_nm", data.workroom_nm);

        var popup = $("#ItemGuide2Workroom2Popup").dxPopup("instance");

        popup.hide();
    }


    // ccp코드 팝업 더블 클릭
    function ItemGuide2CcpRowDblClick(selectedItems) {
        var data = selectedItems.data;
        var dataGrid = $("#ItemGuide2ProcessTreeList").dxTreeList("instance");

        dataGrid.cellValue(_itemGuide2CellClickEvent.rowIndex, "ccp_cd", data.ccp_cd);
        dataGrid.cellValue(_itemGuide2CellClickEvent.rowIndex, "ccp_nm", data.ccp_nm);

        var ccpPopup = $("#ItemGuide2CcpPopup").dxPopup("instance");
        ccpPopup.hide();
    }


    // 공정 트리리스트 컬럼 클릭 이벤트 제한
    function ItemGuide2ProcessEditableColumn(cellElement, cellInfo) {

        if (cellElement.rowType != "data" || !cellElement.isEditing)
            return;



        if (cellElement.column.dataField === 'fieldname' && !cellElement.row.inserted)
            cellElement.element.find('input').prop('disabled', true);
        if (cellElement.row.data.level === '1' && !cellElement.row.inserted)
            cellElement.element.find('input').prop('disabled', true);

        if (cellElement.row.data.level === "1" && cellElement.column.dataField == "grouping_cd") {

            cellElement.element.find('input').prop('disabled', false);
        }


        return;


        //if (cellElement.row.data.level === '1' && !cellElement.row.inserted)
        //    cellElement.element.find('input').prop('disabled', true);

        if (cellElement.row.data.level === '1' && cellElement.column.dataField == "grouping_cd") {
            cellElement.element.find('input').prop('disabled', false);
        }

        if (cellElement.columnIndex === 0 )
            cellElement.element.find('input').prop('disabled', true);
        if (cellElement.columnIndex === 1 )
            cellElement.element.find('input').prop('disabled', true);
        if (cellElement.columnIndex === 6 )
            cellElement.element.find('input').prop('disabled', true);
        if (cellElement.columnIndex === 9 )
            cellElement.element.find('input').prop('disabled', true);
        if (cellElement.columnIndex === 10 )
            cellElement.element.find('input').prop('disabled', true);

        if (cellElement.columnIndex === 7 && cellElement.isEditing) {

            var input = cellElement.cellElement[0];
        }

    }

    // 공정 트리리스트 부모노드 셀 데이터 감춤
    function ItemGuide2HideCheckbox(e) {

        if (e.parentType === "dataRow") {

            if (e.row.node.level === 0 && e.dataField !== "ord1" && e.dataField !== "보관소코드") {
                e.editorOptions.visible = true;
            }
        }
    }


    function ItemGuide2SelectBoxOnChanged(options) {

        if (options.parentType == 'dataRow' && options.dataField == 'ccp_cd') {
            options.editorElement.dxSelectBox('instance').option('onValueChanged', function (e) {
                var treeList = $("#ItemGuide2ProcessTreeList").dxTreeList("instance");
                treeList.cellValue(options.row.rowIndex, "ccp_cd", e.value);
                treeList.cellValue(options.row.rowIndex, "ccpChanged", true);
            });
        }
    }

    // 버튼 컬럼
    function ItemGuide2CellWithButton(container, cellInfo) {

        if (cellInfo.row.data.level == "1") {
            return;
        }

        if (_itemGuide2IsEditing == false) {
            $("<div>").html(cellInfo.value)
                .appendTo(container);
            return;
        }

        $("<div>").html("<div style='float:left; line-height: 2;'>" + (cellInfo.value ? cellInfo.value : "") + "</div><div style='float:right;' class='icon-plus'></div>")
            .appendTo(container);


        $(".icon-plus").dxButton({
            icon: "search",
            onClick: function (e) {

            }
        });
    }

    // 그리드 저장 취소 버튼 숨김
    function ItemGuide2HideSaveButton(e) {
        e.toolbarOptions.visible = false;
    }

    // 공정 트리리스트 수정
    function ItemGuide2ProcessUpdate(info) {

        var data = info.data;

        var pData = {
            gubun: "U",
            item_cd: $("#ItemGuide2SearchForm input[name=item_cd]").val(),
            revision_no: _itemGuide2RevisionNo,
            process_cd: data.process_cd,
            item_proc_seq: data.seq ,
            item_proc_qc_ck: data.item_proc_qc_ck ,
            test_type: data.test_type ,
            item_proc_transfer_ck: data.item_proc_transfer_ck ,
            item_proc_worker1: data.worker1 ,
            item_proc_worker2: data.worker2 ,
            item_proc_inspector: data.inspector ,
            item_proc_warehouse: data.item_proc_warehouse ,
            remark: data.remark ,
            item_proc_content: data.item_proc_content ,
            item_proc_standard_rate: data.item_proc_standard_rate ,
            item_proc_manage_rate: data.item_proc_manage_rate ,
            standard_proc_time: data.standard_proc_time ,
            workroom_cd: data.workroom_cd ,
            item_proc_manage_rate_max: data.item_proc_manage_rate_max ,
            item_proc_manage_rate_mIN: data.item_proc_manage_rate_min ,
            next_process_cd: data.next_process_cd ,
            item_proc_standard_weight_qty: data.item_proc_standard_weight_qty ,
            item_proc_standard_weight_unit: data.item_proc_standard_weight_unit ,
            ccp_cd: data.ccp_cd ,
            ccpChanged: data.ccpChanged,
            grouping_cd: data.grouping_cd
        }

        _itemGuide2Changes.push(pData);
    }

    // 사용자재 조정 팝업
    function ItemGuide2BomSearch() {

        var item_cd = $("#ItemGuide2SearchForm input[name=item_cd]").val();

        if (!item_cd) {
            alert("제품을 선택해야 합니다.");
            return;
        }

        var requestData = {
            item_cd: item_cd,
            item_bom_no: $("#ItemGuide2SearchForm select[name=revision_no]").val(),
            sign_cnt: _itemGuide2SignCnt,
            revision_no: $("#ItemGuide2SearchForm select[name=revision_no]").val()
        }

        $.ajax({
            type: "GET",
            url: '/ProductionMaster/BomPopupView',
            traditional: true,
            data: requestData
        }).done(function (response) {

            var popup = $("#ItemGuide2BomPopup").dxPopup('instance');

            popup.option("contentTemplate", function (content) {
                content.append(response);
            });

            popup.show();

        }).fail(function (data) {
            alert("Failed: " + data.response);
        });

    }

    // 사용확인
    function ItemGuide2UseCheck() {

        if (!$("#ItemGuide2 input[name=revision_sign_end_ck]").prop("checked")) {
            alert("최종 승인 후 사용확인 체크할 수 있습니다.");
            return;
        }

        var revision_no = $("#ItemGuide2SearchForm select[name=revision_no]").val();

        $.ajax({
            type: 'POST',
            url: '/ProductionMaster/ItemGuide2UseChk',
            data: {
                item_cd: $("#ItemGuide2SearchForm input[name=item_cd]").val(),
                revision_no: $("#ItemGuide2SearchForm select[name=revision_no]").val()
            },
            success: function (result) {

                $.ajax({
                    type: 'POST',
                    url: '/Comm/GetSelectBoxOption',
                    async: false,
                    data: {
                        pGb: "포장개정번호",
                        pDiv: "S",
                        pItemCd: $('input[name=item_cd]', $('#ItemGuide2SearchForm')).val(),
                        pTableName: "ItemGuideRevisionNo"
                    },
                    success: function (result) {

                        $("#ItemGuide2SearchForm select").empty();
                        $("#ItemGuide2SearchForm select").append(result);

                        $("#ItemGuide2SearchForm select").val(revision_no).prop("selected", true);

                        ItemGuide2GetItemDetail();

                    }
                });
            }
        });

    }

    // 공정검사 조회 : 공정검사설정 버튼 및 좌측 제품공정의 클릭 시 선택된 공정값을 파라미터로 받아 조회한다.
    function ItemGuide2getProcExam(processCd) {

        var revision = $("#ItemGuide2SearchForm select[name=revision_no]").val();
        $("#ItemGuide2itemProcessExamDataGrid").dxDataGrid("option", "dataSource", []);
        $("#ItemGuide2itemProcessExamDataGrid").dxDataGrid("instance").cancelEditData();


        $.ajax({
            type: 'POST',
            url: '/ProductionMaster/ItemGuide2GetProcExam',
            data: {
                pGubun: "SX",
                item_cd: $("#ItemGuide2SearchForm input[name=item_cd]").val(),
                revision_no: $("#ItemGuide2SearchForm select[name=revision_no]").val(),
                batch_size: "",
                process_cd: processCd
            },
            success: function (result) {

                if (result.length > 0) {
                    $("#ItemGuide2itemProcessExamDataGrid").dxDataGrid("option", "dataSource", JSON.parse(result));
                } else {
                    $("#ItemGuide2itemProcessExamDataGrid").dxDataGrid("option", "dataSource", []);
                }

            }
        });
    }

    // 공정검사 수정
    function ItemGuide2ProcExamUpdate(info) {

        var data = info.data;

        data.pGubun = "UX";

        data.mp_ck = "P";       //제조 포장 구분 : M 제조, P 포장
        data.revision_no = $("#ItemGuide2SearchForm select[name=revision_no]").val();
        data.process_cd = "";

        if ($("#ItemGuide2ProcessTreeList").dxTreeList("instance").getNodeByKey($("#ItemGuide2ProcessTreeList").dxTreeList("option", "focusedRowKey")) != null) {

            data.process_cd = $("#ItemGuide2ProcessTreeList").dxTreeList("instance").getNodeByKey($("#ItemGuide2ProcessTreeList").dxTreeList("option", "focusedRowKey")).data.process_cd;
        }

        if (data.o_application_ck == "N" && data.application_ck == true) {
            data.pGubun = "IX";
        } else if (data.o_application_ck == "Y" && data.application_ck == false) {
            data.pGubun = "DX";
        }

        $.ajax({
            type: 'POST',
            url: '/ProductionMaster/ItemGuide2ProcExamCRUD',
            data: data,
            success: function (result) {

            }
        });
    }

    // 작업방법 조회 : 작업방법 정보 버튼 및 좌측 제품공정의 클릭 시 선택된 공정값을 파라미터로 받아 조회한다.
    function ItemGuide2getWorkGuide(processCd) {
        $.ajax({
            type: 'POST',
            url: '/ProductionMaster/ItemGuide2GetWorkGuide',
            data: {
                pGubun: "S",
                item_cd: $("#ItemGuide2SearchForm input[name=item_cd]").val(),
                revision_no: $("#ItemGuide2SearchForm select[name=revision_no]").val(),
                batch_size: "",
                process_cd: processCd
            },
            success: function (result) {

                try {
                    var jsonData = JSON.parse(result);
                    $("#ItemGuide2itemWorkGuideDataGrid").dxDataGrid("option", "dataSource", jsonData);
                } catch (e) {
                    $("#ItemGuide2itemWorkGuideDataGrid").dxDataGrid("option", "dataSource", []);
                }
            }
        });
    }

    // 작업방법 수정
    function ItemGuide2ItemWorkGuideInsert(info) {
        ItemGuide2ItemWorkGuideCRUD("I", info);
    }

    function ItemGuide2ItemWorkGuideUpdate(info) {
        ItemGuide2ItemWorkGuideCRUD("U", info);
    }

    function ItemGuide2ItemWorkGuideDelete(info) {
        ItemGuide2ItemWorkGuideCRUD("D", info);
    }

    function ItemGuide2ItemWorkGuideCRUD(pGubun, info) {
        var data = info.data;
        data.pGubun = pGubun;
        data.item_cd = $("#ItemGuide2SearchForm input[name=item_cd]").val();
        data.revision_no = $("#ItemGuide2SearchForm select[name=revision_no]").val();
        data.batch_size = "";
        data.process_cd = "";


        // proc_rep_yn값이 없을 경우 false값을 입력
        if (typeof data.check_proc == "undefined") {
            data.check_proc = "false";
        }


        if ($("#ItemGuide2ProcessTreeList").dxTreeList("instance").getNodeByKey($("#ItemGuide2ProcessTreeList").dxTreeList("option", "focusedRowKey")) != null) {

            data.process_cd = $("#ItemGuide2ProcessTreeList").dxTreeList("instance").getNodeByKey($("#ItemGuide2ProcessTreeList").dxTreeList("option", "focusedRowKey")).data.process_cd;
        }

        if (pGubun == "I") {
            data.workguide_id = "";
        }

        $.ajax({
            type: 'POST',
            url: '/ProductionMaster/ItemGuide2ItemWorkGuideCRUD',
            data: data,
            success: function (result) {
                ItemGuide2getWorkGuide(data.process_cd);
            }
        });
    }

    // 작업방법 그리드 클릭 시 하단 정보 변경 및 isEditing 상태 시 컬럼 확인 하여 팝업 호출
    function ItemGuide2ItemWorkGuideInfo(info) {
        if (!info.rowType == "data" || typeof info.rowType == "undefined") return;

        var data = info.data;

        if (data.workguide_es_yn == "Y") {
            $('input:checkbox[name="ItemGuide2workguide_es_yn"]').prop("checked", true);
        } else {
            $('input:checkbox[name="ItemGuide2workguide_es_yn"]').prop("checked", false);
        }

        if (data.workguide_unnecessary_yn == "Y") {
            $('input:checkbox[name="ItemGuide2workguide_unnecessary_yn"]').prop("checked", true);
        } else {
            $('input:checkbox[name="ItemGuide2workguide_unnecessary_yn"]').prop("checked", false);
        }

        $('input[name="ItemGuide2decimal_cnt"]').val(data.decimal_cnt);

        //isEditing 상태 시 컬럼 확인 하여 팝업 호출
        if (!UtilView.isEmpty(info.row.isEditing)) {
            if (info.columnIndex == 5) {
                _cellClickEvent = info;

                var equipPopup = $("#ItemGuide2EquipmentPopup").dxPopup("instance");
                equipPopup.show();
            }

            if (info.columnIndex == 7) {
                _cellClickEvent = info;

                var materialPopup = $("#ItemGuide2ItemGuideMaterialPopup").dxPopup("instance");
                materialPopup.show();
            }
        }
    }

    // 작업방법 원료 팝업 더블클릭
    function ItemGuide2ItemGuideMaterialRowDblClick(selectedItems) {
        var data = selectedItems.data;

        var dataGrid = $("#ItemGuide2itemWorkGuideDataGrid").dxDataGrid("instance");

        dataGrid.cellValue(_cellClickEvent.rowIndex, "workguide_sub_item", data.item_cd);
        dataGrid.cellValue(_cellClickEvent.rowIndex, "workguide_sub_item_nm", data.item_nm);

        var materialPopup = $("#ItemGuide2ItemGuideMaterialPopup").dxPopup("instance");
        materialPopup.hide();
    }

    // 작업방법 설비 팝업 더블클릭
    function ItemGuide2EquipmentRowDblClick(selectedItems) {
        var data = selectedItems.data;

        var dataGrid = $("#ItemGuide2itemWorkGuideDataGrid").dxDataGrid("instance");

        dataGrid.cellValue(_cellClickEvent.rowIndex, "equip_cd", data.equip_cd);
        dataGrid.cellValue(_cellClickEvent.rowIndex, "equip_nm", data.equip_nm);

        var materialPopup = $("#ItemGuide2EquipmentPopup").dxPopup("instance");
        materialPopup.hide();
    }

    // 작업방법 하단 변경 시 그리드 히든 필드값 변경
    function ItemGuide2changeGridVal() {
        var grid = $("#ItemGuide2itemWorkGuideDataGrid").dxDataGrid("instance");
        var rows = grid.getVisibleRows();
        var rowIndex = $("#ItemGuide2itemWorkGuideDataGrid").dxDataGrid("option", "focusedRowIndex");

        if (rowIndex < 0) {
            $('input:checkbox[name="ItemGuide2workguide_es_yn"]').prop("checked", false);
            $('input:checkbox[name="ItemGuide2workguide_unnecessary_yn"]').prop("checked", false);
            $('input[name="ItemGuide2decimal_cnt"]').val("");
            return;
        }

        var GuideGridisEditing = rows[rowIndex].isEditing;

        if (GuideGridisEditing) {
            if ($('input:checkbox[name="ItemGuide2workguide_es_yn"]').is(":checked")) {
                grid.cellValue(rowIndex, 'workguide_es_yn', "Y");
            } else {
                grid.cellValue(rowIndex, 'workguide_es_yn', "N");
            }

            if ($('input:checkbox[name="ItemGuide2workguide_unnecessary_yn"]').is(":checked")) {
                grid.cellValue(rowIndex, 'workguide_unnecessary_yn', "Y");
            } else {
                grid.cellValue(rowIndex, 'workguide_unnecessary_yn', "N");
            }

            grid.cellValue(rowIndex, 'decimal_cnt', $('input[name="ItemGuide2decimal_cnt"]').val());
        }

        ItemGuide2ItemWorkGuideInfo(rows[rowIndex]);
    }

    // 원료투입 자동 줄추가
    function ItemGuide2ItemBOMWorkGuideAdd() {

        var Procgrid = $("#ItemGuide2ProcessTreeList").dxTreeList("instance");
        var data = Procgrid.getVisibleRows();
        var dataIndex = $("#ItemGuide2ProcessTreeList").dxTreeList("option", "focusedRowIndex");

        var rowIndex;

        //수정 상태가 아니면 실행 안함
        if (!_itemGuide2IsEditing) {
            return;
        }

        //세부공정이 선택된 상태가 아니면 실행 안함
        if (UtilView.isEmpty(data) || dataIndex == -1 || data[dataIndex].data.level != 2) {
            return;
        }

        DevExpress.ui.notify({ message: "제품 원료조회 및 작업방법 생성 중 입니다. 잠시 기다려주세요.", height: "120", position: "top center" }, "info", 600);

        //공정BOM 정보 조회
        $.ajax({
            type: 'POST',
            url: '/ProductionMaster/GetItemBomData',
            data: {
                pSpName: "SP_StandardItemGuide2",
                pGubun: "S8",
                pItemCd: $("#ItemGuide2SearchForm input[name=item_cd]").val(),
                pBatchSize: "",
                pRevisionNo: $("#ItemGuide2SearchForm select[name=revision_no]").val()
            },
            success: function (result) {

                var jsonResult = JSON.parse(result);
                //debugger;
                if (jsonResult != null) {
                    //원 화면의 기능은 조회된 BOM 정보를 팝업으로 띄워서 선택된 것만 작업방법으로 등록해야 함. 추후 기능 수정 필요
                    //현재는 등록된 원료를 전부 작업방법으로 등록하는 형태로 되어 있음.

                    var grid = $("#ItemGuide2itemWorkGuideDataGrid").dxDataGrid("instance");

                    if (jsonResult.length > 0) {
                        for (var i = 0; i < jsonResult.length; i++) {
                            //                            if (jsonResult[i].chk == "Y") {
                            grid.addRow();
                            rowIndex = $("#ItemGuide2itemWorkGuideDataGrid").dxDataGrid("option", "focusedRowIndex");

                            grid.cellValue(0, 'workguide_sub_item', jsonResult[i].item_bom_child_cd); //원료코드
                            grid.cellValue(0, 'workguide_sub_item_nm', jsonResult[i].item_bom_child_nm); //원료명
                            grid.cellValue(0, 'workguide_method', jsonResult[i].item_bom_child_nm); //작업방법
                            grid.cellValue(0, 'workguide_min_manage', jsonResult[i].item_bom_standard_qty); //관리min
                            grid.cellValue(0, 'workguide_max_manage', jsonResult[i].item_bom_standard_qty); //관리max
                            grid.cellValue(0, 'workguide_min_permit', jsonResult[i].item_bom_standard_qty); //허가min
                            grid.cellValue(0, 'workguide_max_permit', jsonResult[i].item_bom_standard_qty); //허가max
                            grid.cellValue(0, 'workguide_data_type', "g(B)"); //작업방법

                            var rows = grid.getVisibleRows();
                            //신규데이터 저장
                            ItemGuide2ItemWorkGuideCRUD("I", rows[0]);
                            //                            }
                        }
                    }

                }
            }
        });

    }

    // 세부공정이 아닌 경우 작업방법 추가 취소 및 작업방법 추가 시 순서 자동 생성
    function ItemGuide2initItemWorkguideSeq(e) {

        var Procgrid = $("#ItemGuide2ProcessTreeList").dxTreeList("instance");
        var rowIndex = $("#ItemGuide2ProcessTreeList").dxTreeList("option", "focusedRowIndex");
        var rows = Procgrid.getVisibleRows();

        if (UtilView.isEmpty(rows) || rowIndex == -1 || rows[rowIndex].data.level != 2) //세부공정이 선택된 상태가 아니면 추가된 row삭제
        {
            DevExpress.ui.notify({ message: "세부공정을 선택해야 작업방법을 입력 할 수 있습니다.", height: "120", position: "top center" }, "info", 600);
            window.setTimeout(function () { e.component.cancelEditData(); }, 0)
        } else {
            var ds = $("#ItemGuide2itemWorkGuideDataGrid").dxDataGrid("option", "dataSource");
            e.data.workguide_seq = (ds.length + 1);
        }
    }


    // 작업방법 복사 팝업
    function ItemWorkGuide2CopyPopup() {
        if (!$("#ItemGuide2ItemCode").val()) {
            alert("제품을 선택해주세요.");

            return;
        }

        if (_itemGuide2SignCnt > 0) {
            alert("승인이 시작된 자료는 수정할 수 없습니다.");
            return;
        }

        var treeList = $("#ItemGuide2ProcessTreeList").dxTreeList("instance");
        if (treeList.option("focusedRowIndex") <= 0) {
            alert("작업 방법을 입력하고자 하는 공정을 선택해 주세요.");
            return;
        }

        var treeData = treeListGetFocusedRowData("ItemGuide2ProcessTreeList");


        var requestData = {
            mp_ck: "P",
            search_info: treeData.fieldname
        }

        $.ajax({
            type: "GET",
            url: '/ProductionMaster/ItemWorkGuidePopupView',
            data: requestData
        }).done(function (response) {
            var popup = $("#ItemWorkGuide2CopyPopup").dxPopup('instance');

            popup.option("contentTemplate", function (content) {
                content.append(response);
            });

            popup.show();

        }).fail(function (data) {
            alert("Failed: " + data.response);
        });
    }



    function ItemGuide2ParentNodeBackgroundColor(e) {

        if (e.rowType === "data" && e.level == 0) {
            e.rowElement[0].style.backgroundColor = '#e8e8e8';
        }
    }


    function ItemGudie2_ContentResize() {
        var ItemGudie2_topPoint = document.querySelector("div#" + PagePrefix + "ProcessDiv div.align-end-only").getBoundingClientRect().bottom;
        var ItemGudie2_content_max_height = window.innerHeight - ItemGudie2_topPoint - 20;


        // 공정 그리드
        document.getElementById(PagePrefix + "ProcessTreeList").style.height = ItemGudie2_content_max_height + "px";

        // 공정정보 대표공정 그리드
        document.getElementById(PagePrefix + "StandardProcessGrid").style.height = (ItemGudie2_content_max_height - 25) + "px";

        // 공정정보 작업공정 그리드
        document.getElementById(PagePrefix + "DetailProcessGrid").style.height = (ItemGudie2_content_max_height - 25) + "px";

        // 사용자재 정보 그리드
        document.getElementById(PagePrefix + "BomGrid").style.height = ItemGudie2_content_max_height + "px";

        // 공정검사 설정 그리드
        var div_align_end_only_height = $("#" + PagePrefix + " div.align-end-only").eq(1).height() + 2;
        document.getElementById(PagePrefix + "itemProcessExamDataGrid").style.height = ItemGudie2_content_max_height + div_align_end_only_height + "px";

        // 작업방법 정보 그리드
        document.getElementById(PagePrefix + "itemWorkGuideDataGrid").style.height = (ItemGudie2_content_max_height + div_align_end_only_height - 51) + "px";

        // 타품목에서 복사
        var div_mt = $("div#" + PagePrefix + "ProcessDetailCopyDiv div.menuDiv").css("margin-top").replace(/[^-\d\.]/g, '');
        var div_mb = $("div#" + PagePrefix + "ProcessDetailCopyDiv div.menuDiv").css("margin-bottom").replace(/[^-\d\.]/g, '');
        var conent_height = ItemGudie2_content_max_height + div_align_end_only_height - div_mt - div_mb - 27;

        document.querySelector("div#" + PagePrefix + "ProcessDetailCopyDiv div.menuDiv").style.height = conent_height + "px";

    }

    function ItemGuide2ResetInsertForm() {
        $("#ItemGuide2InputForm")[0].reset();
        $("#ItemGuide2InputForm textarea").text("");
    }




    // 공정 TreeList 저장 전 작업실 입력 여부 확인
    function ItemGuide2_WorkroomCheck() {
        var treeList = $("#ItemGuide2ProcessTreeList").dxTreeList("instance");
        var workroom_check = true;
        if (treeList.totalCount() > 0) {
            var data = treeList.getVisibleRows();
            for (var i in data) {
                if (data[i].data.level != "1") {
                    if (data[i].data.workroom_cd == null || data[i].data.workroom_cd == "") {
                        workroom_check = false;

                        return;
                    }
                }
            }

        }

        return workroom_check;
    }


    function ItemGuide2_TreeListTransferChagne() {

        if ('@Public_Function.process_transfer_yn' == "N") {
            var treeList = $("#ItemGuide2ProcessTreeList").dxTreeList("instance");
            treeList.columnOption("item_proc_transfer_ck", "visible", false);
        }
    }

    // 통합 제조기록서 미리보기(품목에 해당하는 개정번호를 기준으로 조회)
    // 20201.03.05 박가희 추가(아오스 요청으로 인한 작업)
    function ItemGuide2Print() {
        var btnType;
        btnType = $(event.target).closest('.dx-button').attr('id');

        var report = new ReportHelper();

        var item_cd = $("#ItemGuide2SearchForm #ItemGuide2ItemCode").val();
        var revision_no = $("#ItemGuide2SearchForm select[name=revision_no]").val();

        //품목과 그에 해당하는 개정번호가 있을때
        if ((item_cd != "" && item_cd != null) && (revision_no != "" && revision_no != null)) {

            //report.addParam({
            //    objFile: { path: "ProductionMaster", RptFileName: "ItemGuide2RPT" },
            //    objSp: { SpName: "SP_ItemGuide2RPT", gubun: "S", reportParam: "item_cd:" + item_cd + ";revision_no:" + revision_no },
            //    objEtcInfo: { subParam: "" },
            //    objTblNm: {
            //        tblName: "PackingOrderIssue_Header,PackingOrderIssue_PackingOrder,WorkSheet_OrderProc"
            //    },
            //    objSub: { subRptName: "PackingOrderIssue.rpt,PackingOrderIssue_sub.rpt,WorkSheetPack.rpt" }

            //});

            report.addParam({
                objFile: { path: "ProductionMaster", RptFileName: "ItemGuide2RPT" },
                objSp: { SpName: "SP_ItemGuideReport", gubun: "P", reportParam: "item_cd:" + item_cd + ";revision_no:" + revision_no },
                objEtcInfo: { subParam: "" },
                objTblNm: {
                    tblName: "WorkSheetHistory_Header,WorkSheetHistory_History,PackingOrderIssue_Header,PackingOrderIssue_PackingOrder"
                },
                objSub: { subRptName: "WorkSheetHistory.rpt,PackingOrderIssue_sub.rpt" }

            });

            report.addParam({
                objFile: { path: "ProductionMaster", RptFileName: "WorkSheet" },
                objSp: { SpName: "SP_ItemGuideReport", gubun: "WorkSheet", reportParam: "item_cd:" + item_cd + ";revision_no:" + revision_no + ";mp_ck:P" },
                objEtcInfo: { subParam: "" },
                objTblNm: {
                    tblName: "WorkSheet_Header,WorkSheet_OrderProc,WorkSheet_PrevCheck,WorkSheet_PrevCheck_Equip"
                },
                objSub: { subRptName: "PrevCheck,PrevCheck_Equip" }

            });

            if (btnType.indexOf('Preview') > -1) {
                report.preview();
            } else if (btnType.indexOf('Print') > -1) {
                report.print();
            }


        } else {
            alert("품목을 선택하시고, 개정데이터를 입력하세요");
        }

    }

    //개정에 대한 포장대장이 있는지 확인
    function ItemGuide2CheckWorkOrder() {
        var item_cd = $("#ItemGuide2SearchForm #ItemGuide2ItemCode").val();
        var revision_no = $("#ItemGuide2SearchForm select[name=revision_no]").val();

        var check = "N";

        $.ajax({
            type: 'POST',
            async: false,
            url: '/ProductionMaster/ItemGuide2CheckWorkOrder',
            data: {
                item_cd: item_cd,
                revision_no: revision_no
            },
            success: function (result) {
                check = result;
            }
        });

        if ("Y" == check) return true;
        else if ("N" == check) return false;
    }


</script>


<div id="@(pagePrefix)" page-ctrl-name="@(pageControllerNm)" autoresize="Y">

    <div id="@(pagePrefix)PackingItemPopup"></div>
    <div id="@(pagePrefix)PackingItem2Popup"></div>
    <div id="@(pagePrefix)PackingItem3Popup"></div>
    <div id="@(pagePrefix)PackingItem4Popup"></div>

    <div id="@(pagePrefix)EmpPopup"></div>
    <div id="@(pagePrefix)ProcessPopup"></div>

    <div id="@(pagePrefix)Workroom1Popup"></div>
    <div id="@(pagePrefix)Workroom2Popup"></div>

    <div id="@(pagePrefix)EquipmentPopup"></div>
    <div id="@(pagePrefix)CommonCodePopup"></div>
    <div id="@(pagePrefix)ProcessPopup"></div>

    <div id="@(pagePrefix)ItemGuideMaterialPopup"></div>

    <div id="@(pagePrefix)CcpPopup"></div>


    @* === 제조 공정도 팝업 === *@
    @(Html.DevExtreme().Popup()
        .ID("ItemGuide2_ProcessInfomationPopup")
        .Width(600)
        .Height(700)
        .ShowTitle(true)
        .Title("제조 공정도")
        .Visible(false)
        .DragEnabled(true)
        .CloseOnOutsideClick(true)
    )
    @using (Html.DevExtreme().NamedTemplate("ItemGuide2_ProcessInfomationPopupTemplate"))
    {
        <div id="@(pagePrefix)" page-ctrl-name="@(pageControllerNm)" autoresize="Y">
            <div>
                @(Html.DevExtreme().Diagram()
                    .ID("ItemGuide2_ProcInfoDiagram")
                    .ViewToolbar(vt => vt.Visible(false))
                    .Toolbox(tb => tb.Visibility(DiagramPanelVisibility.Disabled))
                    .HistoryToolbar(ht => ht.Visible(false))
                    .ReadOnly(true)
                    .SimpleView(true)
                    .ShowGrid(false)
                    .ContextMenu(cm => cm.Enabled(false))
                )
            </div>
        </div>
    }


    @*작업방법 복사 팝업*@
    @(Html.DevExtreme().Popup()
        .ID("ItemWorkGuide2CopyPopup")
        .Width(1200)
        .Height(720)
        .ShowTitle(true)
        .Title("작업방법 조회")
        .Visible(false)
        .DragEnabled(false)
        .CloseOnOutsideClick(true)
        //.OnHiding("ItemGuide2GetItemDetail")
    )
    @(Html.DevExtreme().Popup()
        .ID("ItemGuide2RevisionPopup")
        .Width(1200)
        .Height(720)
        .ShowTitle(true)
        .Title("개정 조회")
        .Visible(false)
        .DragEnabled(false)
        .CloseOnOutsideClick(true)
    )

    @using (Html.DevExtreme().NamedTemplate("ItemGuide2RevisionPopupTemplate"))
    {
        <form>
            <label>마지막 개정만 표시</label>
            <input type="checkbox" value="Y" id="latestRevisionCk2" onchange="SetItemGuide2RevisionDataSource()" />
            <label>승인여부</label>
            <input type="checkbox" value="Y" id="revisionSignEndCk2" onchange="SetItemGuide2RevisionDataSource()" />
            <label>사용여부</label>
            <input type="checkbox" value="Y" id="revisionCurrentCk2" onchange="SetItemGuide2RevisionDataSource()" />
        </form>

        @(Html.DevExtreme().ScrollView()
            .Width("100%")
            .Height("100%")
            .Content(@<text>
                @(Html.DevExtreme().DataGrid()
                    .ID("ItemGuide2RevisionGrid")
                    .ShowBorders(true)
                    .ShowColumnLines(true)
                    .ShowRowLines(true)
                    .SearchPanel(searchPanel => searchPanel.Visible(true))
                    .Scrolling(scrolling => scrolling.Mode(GridScrollingMode.Virtual))
                    .Sorting(s => s.Mode(GridSortingMode.None))
                    .Height(550)
                    .Columns(columns =>
                    {
                        columns.Add()
                            .DataField("item_cd")
                            .Caption("품목코드");
                        columns.Add()
                            .DataField("item_nm")
                            .Caption("품목명");
                        columns.Add()
                            .DataField("revision_num")
                            .Caption("개정번호");
                        columns.Add()
                            .DataField("revision_remark")
                            .Caption("개정사유");
                        //columns.Add()
                        //    .DataField("batchsize")
                        //    .Caption("수량");
                        //columns.Add()
                        //    .DataField("batchsize_unit_cd")
                        //    .Caption("단위");
                        columns.Add()
                            .DataField("accept_yn")
                            .Caption("최종승인여부");
                    })
                .Selection(s => s.Mode(SelectionMode.Single))
                .OnRowDblClick("ItemGuide2RevisionSelect")
                )
            </text>)
        )
    }

    @* === 전자 서명 팝업 === *@
    @(Html.DevExtreme().Popup()
        .ID("ItemGuide2SignPopup")
        .Width(500)
        .Height(420)
        .ShowTitle(true)
        .Title("작업자 인증")
        .OnHidden("clearSignInput")
        .Visible(false)
        .DragEnabled(true)
        .CloseOnOutsideClick(false)
    )

    @using (Html.DevExtreme().NamedTemplate("ItemGuide2SignPopupTemplate"))
    {
        <h6>전자서명은 수기서명과 동일한 효력을 갖습니다.</h6>

        <form id="ItemGuide2SignForm">

            <div class="input-wrapper">
                <label class="col-3">아이디</label>
                <input type="text" class="col-8 form-control" name="txt_ID">

                <label class="col-3">비밀번호</label>
                <input type="password" class="col-8 form-control" name="txt_Pass">
            </div>

        </form>
        <div class="align-content-end">
            <button class="btn btn-secondary" onclick="itemGuide2SignSubmit()">확인</button>
        </div>

        <br />
        <hr />

        <label class="col-3">부서</label>
        <input type="text" class="col-8 form-control" name="dept_nm" readonly="readonly" />
        <label class="col-3">성명</label>
        <input type="text" class="col-8 form-control" name="emp_nm" readonly="readonly" />
    }

    @* === 사용자재 팝업 === *@
    @(Html.DevExtreme().Popup()
        .ID("ItemGuide2BomPopup")
        .Width(1850)
        .Height(950)
        .ShowTitle(true)
        .Title("사용자재 조정")
        .Visible(false)
        .DragEnabled(false)
        .CloseOnOutsideClick(false)
        .OnHiding("ItemGuide2GetItemDetail")
    )
    @* === 제조기록서 정보 입력 팝업 === *@
    @(Html.DevExtreme().Popup()
        .ID("ItemGuide2AddPopup")
        .Width(650)
        .Height(320)
        .ShowTitle(true)
        .Title("입력")
        .Visible(false)
        .DragEnabled(true)
        .CloseOnOutsideClick(false)
        .OnHiding("ItemGuide2ResetInsertForm")
    )

    @using (Html.DevExtreme().NamedTemplate("itemguide2AddPopupTemplate"))
    {
        <form id="ItemGuide2InputForm">
            <div class="input-wrapper">

                <label class="col-2">품목코드</label>
                <div class="input-group col-3">
                    <input type="text" id="ItemGuide2ItemCode3" class="form-control" name="item_cd" readonly="readonly">
                    @*<div class="input-group-append">
                            <button class="btn btn-outline-secondary" type="button" id="searchItemBtn" onclick="SearchItem3()">
                                <i class="fa fa-search"></i>
                            </button>
                        </div>*@
                </div>

                <label class="col-2">품목명</label>
                <div class="input-group col-4">
                    <input type="text" id="ItemGuide2ItemName3" class="form-control" name="item_nm" readonly="readonly">
                </div>

            </div>


            <div class="input-wrapper">

                <label class="col-2">개정번호</label>
                <div class="input-group col-3">
                    <input type="text" id="revision_num" class="form-control required" name="revision_num">
                </div>

                <label class="col-2">시행일자</label>
                <div class="input-group col-4">
                    <input type="text" id="itemguide2DatePicker" class="form-control required datepicker" name="revision_use_date">
                </div>

            </div>

            <div class="input-wrapper">

                <label class="col-2">비고</label>
                <div class="input-group col-9">
                    <input type="text" class="form-control" name="revision_special_mention">
                </div>

            </div>

            <div class="input-wrapper">

                <label class="col-2">개정사유</label>
                <div class="input-group col-9">
                    <textarea class="form-control required" name="revision_remark" rows="5"></textarea>
                </div>
            </div>

        </form>
        @(Html.DevExtreme().Toolbar()
            .ID("ItemGuide2Toolbar")
            .Items(items =>
            {
                items.Add()
                    .Widget(w => w
                    .Button()
                    .Type(ButtonType.Default)
                    .StylingMode(ButtonStylingMode.Contained)
                    .ID("ItemGuide2Add")
                    .Icon("save")
                    .Text("저장")
                    .OnClick("ItemGuide2Add")
                    )
                    .Location(ToolbarItemLocation.After);
            })
            )
    }


    <div class="mainTop mb-1">

        <div class="row mb-1">

            <div class="col-9">

                <form id="@(pagePrefix)SearchForm">

                    <div class="input-wrapper">

                        <div class="input-group input-group-sm col-5">
                            <div class="input-group-prepend">
                                <span class="input-group-text">품목코드</span>
                            </div>
                            <input type="text" class="form-control col-3" id="ItemGuide2ItemCode" name="item_cd">
                            <div class="input-group-append">
                                <button class="btn btn-outline-secondary" type="button" onclick="ItemGuide2SearchPackingItem()">
                                    <i class="fa fa-search"></i>
                                </button>
                            </div>
                            <input type="text" class="form-control" id="ItemGuide2ItemName" name="item_nm">
                        </div>

                        @*<div class="input-group input-group-sm col-3">
                                <div class="input-group-prepend">
                                    <span class="input-group-text">제품코드</span>
                                </div>
                                <input type="text" class="form-control" name="item_cd" id="item_cd" />
                                <div class="input-group-append">
                                    <button type="button" class="btn btn-outline-secondary" onclick="ItemGuide2SearchPackingItem()"><i class="fa fa-search"></i></button>
                                </div>
                            </div>
                            <div class="input-group input-group-sm col-4">
                                <div class="input-group-prepend">
                                    <span class="input-group-text">제품명</span>
                                </div>
                                <input type="text" class="form-control" name="item_nm" id="item_nm" />
                            </div>*@

                        <div class="input-group input-group-sm col-3">
                            <div class="input-group-prepend">
                                <span class="input-group-text">개정번호</span>
                            </div>
                            <select class="form-control" name="revision_no" id="revision_no" onchange="@(pagePrefix)GetItemDetail()">
                            </select>
                        </div>
                    </div>

                </form>

            </div>

            <div class="CRUD-btn col-3">
                @* === CRUD 버튼 === *@
                @{Html.SetToolbar(0, true, "Search;Input;Edit;Delete;Save;Undo;Preview;");}
            </div>

        </div>

        <div class="row">

            <div class="col-12" style="display:inherit;" id="ItemGuide22Form2">

                <div class="col-8 display-flex">

                    <div class="custom-control custom-switch pr-1">
                        <input type="checkbox" class="custom-control-input" id="ItemGuide2RevisionInfoToggle" onclick="ItemGuide2RevisionInfoToggle()" checked="checked">
                        <label class="custom-control-label" for="ItemGuide2RevisionInfoToggle">제/개정 정보</label>
                    </div>

                    <div class="custom-control custom-switch pr-1">
                        <input type="checkbox" class="custom-control-input" id="ItemGuide2ProcessToggle" onclick="ItemGuide2ProcessToggle()">
                        <label class="custom-control-label" for="ItemGuide2ProcessToggle">공정 정보</label>
                    </div>


                    <div class="custom-control custom-switch pr-1">
                        <input type="checkbox" class="custom-control-input" id="ItemGuide2BomToggle" onclick="ItemGuide2BomToggle()">
                        <label class="custom-control-label" for="ItemGuide2BomToggle">사용자재 정보</label>
                    </div>


                    <div class="custom-control custom-switch pr-1">
                        <input type="checkbox" class="custom-control-input" id="ItemGuide2itemProcessExamToggle" onclick="ItemGuide2itemProcessExamToggle()">
                        <label class="custom-control-label" for="ItemGuide2itemProcessExamToggle">공정검사 설정</label>
                    </div>


                    <div class="custom-control custom-switch pr-1">
                        <input type="checkbox" class="custom-control-input" id="ItemGuide2itemWorkGuideToggle" onclick="ItemGuide2itemWorkGuideToggle()">
                        <label class="custom-control-label" for="ItemGuide2itemWorkGuideToggle">작업방법 정보</label>
                    </div>

                </div>

                <div class="col-4 align-end-only">

                    <button class="btn btn-secondary" onclick="ItemGuide2SelectWithCondition()">조건별 조회</button>

                    <div class="radioDiv">
                        <label>승인여부</label>
                        <input type="checkbox" name="revision_sign_end_ck" class="checkbox" onclick="return false;" />
                        <label>사용여부</label>
                        <input type="checkbox" name="revision_current_ck" class="checkbox" onclick="return false;" />
                    </div>

                    <button class="btn btn-secondary" onclick="ItemGuide2UseCheck()">사용확인</button>

                </div>

            </div>

        </div>

    </div>

    <div class="row mb-1" id="@(pagePrefix)RevisionInfoDiv">

        <div class="col-4 pr-1">

            <div class="box mb-0">

                <div class="divName">
                    <p>포장기록서 정보</p>
                </div>

                <div class="div-content-wrapper">

                    <form id="@(pagePrefix)WriteForm">

                        <div class="input-wrapper">
                            <label class="col-4">개정번호</label>
                            <div class="input-group col-7 required">
                                <input type="text" id="revision_num" class="form-control required" name="revision_num">
                            </div>
                        </div>

                        <div class="input-wrapper">
                            <label class="col-4">시행일자</label>
                            <div class="input-group col-7">
                                <input type="text" class="form-control datepicker required" name="revision_use_date">
                            </div>
                        </div>

                        <div class="input-wrapper">
                            <label class="col-4">비고</label>
                            <div class="input-group col-7">
                                <input type="text" class="form-control" name="revision_special_mention">
                            </div>
                        </div>


                        <div class="input-wrapper">
                            <label class="col-4">개정사유</label>
                            <div class="input-group col-7">
                                <textarea class="form-control required" rows="4" name="revision_remark"></textarea>
                            </div>
                        </div>

                    </form>

                </div>

            </div>

        </div>

        <div class="col-4 pl-0">

            <div class="box mb-0">

                <div class="divName mb-0">
                    <p>전자서명 정보 - 포장기록 원본 사용 승인</p>
                </div>

                @(Html.DevExtreme().DataGrid()
                .ID(pagePrefix+"SignTable")
                .ShowBorders(true)
                .ShowColumnLines(true)
                .ShowRowLines(true)
                .FocusedRowEnabled(true)
                .FocusedRowIndex(0)
                .OnCellClick(pagePrefix+"Sign")
                .KeyExpr("sign_set_dt_id")
                .Height(160)
                .Selection(s => s.Mode(SelectionMode.Single))
                .Sorting(s => s.Mode(GridSortingMode.None))
                .AllowColumnResizing(true)
                .Columns(columns =>
                {
                columns.Add()
                        .DataField("displayfield")
                        .Caption("구분");
                columns.Add()
                        .DataField("sign_emp_nm")
                        .Caption("서명자");
                columns.Add()
                        .DataField("sign_time")
                        .Width(185)
                        .Caption("서명일자");
                columns.Add()
                        .AllowFiltering(false)
                        .AllowSorting(false)
                        .DataField("sign_image")
                        .Name("sign_image")
                        .Caption("서명")
                        .Width(100)
                        .CellTemplate(@<text>
                                <div>
                                    <img src="<%- value %>" alt="" style="width:80px; height:25px;"/>
                                </div>
                            </text>);
                    })
                )
            </div>

        </div>

    </div>

    <div class="row">

        <div id="@(pagePrefix)ProcessDiv">

            <div class="box mb-0">
                <div class="divName ">
                    <p>공정</p>
                </div>

                <div class="display-flex display-flex-space-between">
                    <div class="align-start-only pl-2">
                        <button class="btn btn-secondary" onclick="ItemGuide2_ProcessInfomationPopup()">제조 공정도</button>
                    </div>

                    <div class="align-end-only pr-2">
                        <button class="btn btn-secondary" onclick="ItemGuide2DeleteProcess(0)">삭제</button>
                        <button class="btn btn-secondary" onclick="ItemGuide2DeleteProcess(1)">전체삭제</button>
                    </div>
                </div>

                <div>
                    @(Html.DevExtreme().TreeList()
                        .ID(pagePrefix+"ProcessTreeList")
                        .RootValue("")
                        .KeyExpr("mykey")
                        .ParentIdExpr("pkey")
                        .OnCellClick(pagePrefix+"GridPopup")
                        .OnEditorPreparing(pagePrefix+"HideCheckbox")
                        .OnEditorPrepared("ItemGuide2SelectBoxOnChanged")
                        .OnRowUpdated(pagePrefix+"ProcessUpdate")
                        .OnCellPrepared(pagePrefix + "ProcessEditableColumn")
                        .OnRowPrepared(pagePrefix + "ParentNodeBackgroundColor")
                        .OnToolbarPreparing(pagePrefix+"HideSaveButton")
                        .OnFocusedRowChanged("ItemGuide2GetItemProcess")
                        .Height(574)
                        .Paging(p => p.PageSize(100000))
                        .AllowColumnResizing(true)
                        .Scrolling(scrolling => scrolling.Mode(TreeListScrollingMode.Virtual)
                            .ShowScrollbar(ShowScrollbarMode.Always))
                        .Columns(columns => {

                            columns.Add()
                                .DataField("ord1")
                                .Caption("순서");

                            columns.Add()
                                .DataField("fieldname")
                                .DataType(GridColumnDataType.String)
                                .Caption("공정");

                            columns.Add()
                                .DataField("next_process_cd")
                                .DataType(GridColumnDataType.String)
                                .Visible(false);

                            columns.Add()
                                .DataField("next_process_nm")
                                .DataType(GridColumnDataType.String)
                                .CellTemplate(new JS("ItemGuide2CellWithButton"))
                                .Caption("다음공정");

                            columns.Add()
                                .DataField("item_proc_qc_ck")
                                .DataType(GridColumnDataType.Boolean)
                                .CalculateCellValue(@"function(rowData) { return (rowData.item_proc_qc_ck == ""Y"" || rowData.item_proc_qc_ck == true); }")
                                .Caption("시험유무").Width("4%");

                            columns.Add()
                                .DataField("item_proc_transfer_ck")
                                .DataType(GridColumnDataType.Boolean)
                                .CalculateCellValue(@"function(rowData) { return (rowData.item_proc_transfer_ck == ""Y"" || rowData.item_proc_transfer_ck == true); }")
                                .Caption("인수인계").Width("4%");

                            columns.Add()
                                .DataField("workroom_cd")
                                .DataType(GridColumnDataType.String)
                                .Visible(false);

                            columns.Add()
                                .DataField("workroom_nm")
                                .DataType(GridColumnDataType.String)
                                .Caption("작업실")
                                .CellTemplate(new JS("ItemGuide2CellWithButton"));

                            columns.Add()
                                .DataField("standard_proc_time")
                                .DataType(GridColumnDataType.String)
                                .Caption("작업시간").Width("5%");

                            columns.Add()
                                .DataField("item_proc_warehouse")
                                .DataType(GridColumnDataType.String)
                                .Caption("보관소코드");

                            columns.Add()
                                .DataField("item_proc_warehouse_nm")
                                .DataType(GridColumnDataType.String)
                                .Caption("보관소")
                                .CellTemplate(new JS("ItemGuide2CellWithButton"));

                            columns.Add()
                                .DataField("item_proc_standard_weight_qty")
                                .DataType(GridColumnDataType.Number)
                                .Caption("이론생산량");

                            columns.Add()
                                .Lookup(lookup => lookup
                                .DataSource(d => d.WebApi()
                                .RouteName("Comm")
                                .LoadAction("GetCommon")
                                .LoadMethod("GET")
                                .LoadParams(new
                                {
                                    pGubun = "공통코드",
                                    pDiv = "D",
                                    pStrWhere = "CM012",
                                    pTableName = "2"
                                }).Key("keyfield"))
                                .ValueExpr("keyfield")
                                .DisplayExpr("displayfield")
                                ).DataField("item_proc_standard_weight_unit")
                                .Caption("이론단위").Width("5%");

                            columns.Add()
                                .DataField("item_proc_content")
                                .DataType(GridColumnDataType.Number)
                                .Caption("단위중량(개별질량) (g)").Width("7%");

                            columns.Add()
                                .DataField("item_proc_manage_rate_min")
                                .DataType(GridColumnDataType.Number)
                                .Caption("수율(하한)").Width("5%");

                            columns.Add()
                                .DataField("item_proc_manage_rate_max")
                                .DataType(GridColumnDataType.Number)
                                .Caption("수율(상한)");

                            columns.Add()
                                .DataField("ccp_nm")
                                .DataType(GridColumnDataType.String)
                                .CellTemplate(new JS("ItemGuide2CellWithButton"))
                                .Caption("CCP 코드");

                            columns.Add()
                                .DataField("grouping_cd")
                                .DataType(GridColumnDataType.String)
                                .Caption("그룹코드");

                            columns.Add()
                                .DataField("ccp_cd")
                                .DataType(GridColumnDataType.String)
                                .Visible(false);

                            //columns.Add()
                            //    .Lookup(lookup => lookup
                            //    .DataSource(d => d.WebApi()
                            //    .RouteName("Comm")
                            //    .LoadAction("GetCommon")
                            //    .LoadMethod("GET")
                            //    .LoadParams(new
                            //    {
                            //        pGubun = "CCPCODE",
                            //        pDiv = "D",
                            //        pStrWhere = "",
                            //        pTableName = "CCPCODE"
                            //    }).Key("keyfield"))
                            //    .ValueExpr("keyfield")
                            //    .DisplayExpr("displayfield")
                            //    ).DataField("ccp_cd")
                            //    .Caption("CCP 코드");

                            columns.Add()
                                .DataField("ccpChanged")
                                .DataType(GridColumnDataType.Boolean)
                                .Visible(false);

                        })
                        .ShowRowLines(true)
                        .ShowBorders(true)
                        .ShowColumnLines(true)
                        .Selection(s => s.Mode(SelectionMode.Single))
                        .FocusedRowEnabled(true)
                        .AutoExpandAll(true)
                        .ColumnAutoWidth(true)
                    )
                </div>

            </div>

        </div>

        <div id="@(pagePrefix)ProcessDetailDiv" class="col-9 row display-none pl-1 pr-0">

            <div class="display-contents">

                <div class="custom-control custom-switch pr-1 col-12" style="margin-left:20px; height: 25px;">
                    <input type="checkbox" class="custom-control-input" id="ItemGuide2ProcessDetailCopyToggle" onclick="ItemGuide2ProcessDetailCopyToggle()">
                    <label class="custom-control-label" for="ItemGuide2ProcessDetailCopyToggle">타품목에서 복사</label>
                </div>

                <div class="col-4 pr-1" id="@(pagePrefix)StandardProcessDiv">
                    <div class="box mb-0">
                        <div class="divName">
                            <p>대표공정</p>
                        </div>

                        <div class="align-end-only pr-2">
                            <button class="btn btn-secondary" onclick="ItemGuide2AddProcess('Standard')">추가</button>
                            <button class="btn btn-secondary" onclick="ItemGuide2MoveProcess('Standard','UP')">위</button>
                            <button class="btn btn-secondary" onclick="ItemGuide2MoveProcess('Standard','DOWN')">아래</button>
                        </div>

                        <div>
                            @(Html.DevExtreme().DataGrid()
                                .ID(pagePrefix+"StandardProcessGrid")
                                .ShowBorders(true)
                                .KeyExpr("process_cd")
                                .FocusedRowEnabled(true)
                                .FocusedRowIndex(0)
                                .Selection(s => s.Mode(SelectionMode.Single))
                                .Scrolling(scrolling => scrolling.Mode(GridScrollingMode.Virtual))
                                .Sorting(s => s.Mode(GridSortingMode.None))
                                .Height(550)
                                .ShowColumnLines(true)
                                .AllowColumnResizing(true)
                                .Columns(columns =>
                                {
                                    columns.Add()
                                        .DataField("process_cd")
                                        .Caption("공정코드")
                                        .Width("100");
                                    columns.Add()
                                        .DataField("process_nm")
                                        .Caption("공정명");
                                })
                                .OnRowDblClick("ItemGuide2_DbClickProcessInsert")
                            )
                        </div>
                    </div>
                </div>

                <div class="col-8 pl-0 pr-0" id="@(pagePrefix)DetailProcessDiv">

                    <div class="box mb-0">
                        <div class="divName">
                            <p>작업공정</p>
                        </div>
                        <div class="align-end-only pr-2">
                            <button class="btn btn-secondary" onclick="ItemGuide2AddProcess('Detail')">추가</button>
                            <button class="btn btn-secondary" onclick="ItemGuide2MoveProcess('Detail','UP')">위</button>
                            <button class="btn btn-secondary" onclick="ItemGuide2MoveProcess('Detail','DOWN')">아래</button>
                        </div>

                        <div>
                            @(Html.DevExtreme().DataGrid()
                                .ID(pagePrefix+"DetailProcessGrid")
                                .ShowBorders(true)
                                .ShowColumnLines(true)
                                .Height(550)
                                .KeyExpr("process_cd")
                                .FocusedRowEnabled(true)
                                .AllowColumnResizing(true)
                                .FocusedRowIndex(0)
                                .Selection(s => s.Mode(SelectionMode.Single))
                                .Scrolling(scrolling => scrolling.Mode(GridScrollingMode.Virtual))
                                .Sorting(s => s.Mode(GridSortingMode.None))
                                .Columns(columns =>
                                {
                                    columns.Add()
                                        .DataField("process_cd").Alignment(HorizontalAlignment.Center)
                                        .Caption("공정코드").Width("10%");
                                    columns.Add()
                                        .DataField("process_nm")
                                        .Caption("공정명").Width("20%");
                                    columns.Add()
                                        .DataField("process_type_nm")
                                        .Caption("공정타입").Width("10%");
                                    columns.Add()
                                        .DataField("process_qc_ck")
                                        .Caption("시험의뢰").DataType(GridColumnDataType.Boolean).Width("10%")
                               .CalculateCellValue(@"function(rowData) { return (rowData.process_qc_ck == ""1"" || rowData.process_qc_ck == true); }");
                                    columns.Add()
                                        .DataField("process_transfer_ck")
                                        .Caption("인수인계").Width("10%")
                               .CalculateCellValue(@"function(rowData) { return (rowData.process_transfer_ck == ""1"" || rowData.process_transfer_ck == true); }");
                                    columns.Add()
                                        .DataField("process_worker1_nm")
                                        .Caption("작업자");
                                    columns.Add()
                                        .DataField("workroom_nm")
                                        .Caption("작업실");
                                })
                                .OnRowDblClick("ItemGuide2_DbClickProcessInsert")
                            )

                        </div>
                    </div>
                </div>

                <div class="col-12 display-none pr-0" id="@(pagePrefix)ProcessDetailCopyDiv">
                    <div class="box mb-0">

                        <div class="divName">
                            <p>타품목에서 복사</p>
                        </div>

                        <div class="menuDiv">

                            <div class="input-wrapper">
                                <label class="col-1">제품코드</label>
                                <div class="input-group col-2">
                                    <input type="text" class="form-control" name="item_cd">
                                    <div class="input-group-append">
                                        <button class="btn btn-outline-secondary" type="button" onclick="ItemGuide2SearchItem4()">
                                            <i class="fa fa-search"></i>
                                        </button>
                                    </div>
                                </div>

                                <label class="col-1">제품명</label>
                                <input type="text" class="col-2 form-control" name="item_nm">

                                <label class="col-1">개정번호</label>
                                <select class="col-2 form-control" name="Revision_no">
                                </select>

                                <div class="align-end-only margin-10">
                                    <button type="button" class="btn btn-secondary" onclick="ItemGuide2CopyProcess()">복사</button>
                                </div>

                            </div>

                        </div>

                    </div>
                </div>

            </div>

        </div>

        <div id="@(pagePrefix)BomDiv" class="col-9 pl-1 display-none">

            <div class="box mb-0">

                <div class="divName">
                    <p>사용자재 정보</p>
                </div>

                <div class="align-end-only pr-2">
                    <button class="btn btn-secondary" onclick="ItemGuide2BomSearch()">사용자재 조정</button>
                </div>

                <div>
                    @(Html.DevExtreme().DataGrid()
                        .ID(pagePrefix+ "BomGrid")
                        .ShowBorders(true)
                        .Scrolling(scrolling => scrolling.Mode(GridScrollingMode.Virtual))
                        .Height(574)
                        .ShowColumnLines(true)
                        .AllowColumnResizing(true)
                        .Sorting(s => s.Mode(GridSortingMode.None))
                        .Columns(columns =>
                        {
                            columns.Add()
                                .DataField("item_bom_seq")
                                .Caption("순서");
                            columns.Add()
                                .DataField("process_nm")
                                .Caption("공정");
                            columns.Add()
                                .DataField("item_bom_child_cd")
                                .Caption("자재코드");
                            columns.Add()
                                .Width(250)
                                .DataField("item_bom_child_nm")
                                .Caption("자재명");
                            columns.Add()
                                .DataField("item_bom_standard_qty_nm")
                                .Caption("사용량");
                            columns.Add()
                                .DataField("item_bom_batch_unit")
                                .Caption("단위");
                            columns.Add()
                                .DataField("remark")
                                .Caption("계산식");

                            columns.Add()
                              .DataField("")
                              .Caption("규격")
                              .Visible(false);
                            columns.Add()
                                .DataField("item_bom_manufacture_qty_nm")
                                .Caption("허가량")
                                .Visible(false);
                            columns.Add()
                                .DataField("item_bom_tea_qty_nm")
                                .Caption("제조량")
                                .Visible(false);
                            columns.Add()
                                .DataField("item_bom_tea_unit")
                                .Caption("단위")
                                .Visible(false);
                            columns.Add()
                                .DataField("item_bom_standard_qty")
                                .Caption("표준량")
                                .Visible(false);
                        })
                    )
                </div>

            </div>

        </div>

        <div id="@(pagePrefix)itemProcExamDiv" class="col-9 display-none pl-1">

            <div class="box mb-0">

                <div class="divName mb-0">
                    <p>공정검사 설정</p>
                </div>

                <div>
                    @(Html.DevExtreme().DataGrid()
                        .ID(pagePrefix + "itemProcessExamDataGrid")
                        .ShowBorders(true)
                        .OnRowUpdated(pagePrefix + "ProcExamUpdate")
                        .Height(597)
                        .ShowColumnLines(true)
                        .AllowColumnResizing(true)
                        .Sorting(s => s.Mode(GridSortingMode.None))
                        .Columns(columns =>
                        {
                            columns.Add()
                                .Width(250)
                                .AllowEditing(false)
                                .DataField("exam_nm")
                                .Caption("공정검사");
                            columns.Add()
                                .Width(60)
                                .DataType(GridColumnDataType.Boolean)
                                .DataField("application_ck")
                                .CalculateCellValue(@"function(rowData) { return (rowData.application_ck == ""Y"" || rowData.application_ck == true); }")
                                .Caption("설정");
                            columns.Add().DataField("ccp_yn").Caption("CCP여부").Alignment(HorizontalAlignment.Center).DataType(GridColumnDataType.Boolean)
                                   .CalculateCellValue(@"function(rowData) { return (rowData.ccp_yn == ""Y"" || rowData.ccp_yn == true); }");
                            columns.Add()
                                .AllowEditing(false)
                                .DataField("item_process_exam_start_nm")
                                .Caption("검사시기");
                            columns.Add()
                                .DataType(GridColumnDataType.Number)
                                .DataField("process_exam_period")
                                .Caption("주기(분)");
                            columns.Add()
                                .DataType(GridColumnDataType.Number)
                                .DataField("process_exam_qty")
                                .Caption("1회검체수량");
                            columns.Add()
                                .DataType(GridColumnDataType.Number)
                                .DataField("process_exam_standard")
                                .Caption("기준값");
                            columns.Add()
                                .DataType(GridColumnDataType.Number)
                                .DataField("process_exam_min")
                                .Caption("하한");
                            columns.Add()
                                .DataType(GridColumnDataType.Number)
                                .DataField("process_exam_max")
                                .Caption("상한");
                            columns.Add()
                                .AllowEditing(false)
                                .DataField("item_process_exam_unit_nm")
                                .Caption("결과유형");
                            columns.Add()
                                .Width(250)
                                .DataField("exam_remark")
                                .Caption("검사기준");
                        })
                        .OnToolbarPreparing("HideToolbarButton")
                    )
                </div>

            </div>

        </div>

        <div id="@(pagePrefix)itemWorkGuideDiv" class="col-9 display-none pl-1">

            <div class="display-contents">
                <div class="custom-control custom-switch p-0 ml-1 col-12" style="margin-left:20px; height: 25px;">
                    <button class="btn btn-secondary" onclick="ItemWorkGuide2CopyPopup()">타공정에서 복사</button>
                </div>

                <div>
                    <div class="box mb-0">
                        <div class="divName mb-0">
                            <p>작업방법 정보</p>
                        </div>
                        <div>
                            @(Html.DevExtreme().DataGrid()
                                    .ID(pagePrefix + "itemWorkGuideDataGrid")
                                    .KeyExpr("workguide_id")
                                    .ShowBorders(true)
                                    .ShowColumnLines(true)
                                    .FocusedRowEnabled(true)
                                    .AllowColumnResizing(true)
                                    .Height(570)
                                    .Editing(editing => {
                                        editing.Mode(GridEditMode.Batch);
                                        editing.AllowAdding(false);
                                        editing.AllowDeleting(false);
                                        editing.AllowUpdating(false);
                                    })
                                    .Sorting(s => s.Mode(GridSortingMode.None))
                                    .Columns(columns =>
                                    {
                                        columns.Add()
                                        .Width(50)
                                        .DataField("workguide_seq")
                                        .Caption("순서");

                                        columns.Add()
                                            .Width("450")
                                            .DataField("workguide_method")
                                            .Caption("작업방법");
                                        columns.Add()
                                            .Lookup(lookup => lookup
                                                        .DataSource(d => d.WebApi()
                                                            .RouteName("Comm")
                                                            .LoadAction("GetCommon")
                                                            .LoadMethod("GET")
                                                            .LoadParams(new
                                                            {
                                                                pGubun = "공통코드",
                                                                pDiv = "D",
                                                                pStrWhere = "RT001",
                                                                pTableName = "2"
                                                            }).Key("keyfield"))
                                                        .ValueExpr("keyfield")
                                                        .DisplayExpr("displayfield")
                                                    )
                                            .DataField("workguide_data_type")
                                            .Caption("자료종류");

                                        columns.Add()
                                            .Caption("관리")
                                            .IsBand(true);
                                        columns.Add()
                                            .DataType(GridColumnDataType.Number)
                                            .DataField("workguide_min_manage")
                                            .Caption("관리min")
                                            .OwnerBand(3);
                                        columns.Add()
                                            .DataType(GridColumnDataType.Number)
                                            .DataField("workguide_max_manage")
                                            .Caption("관리max")
                                            .OwnerBand(3);

                                        //columns.Add()
                                        //    .Caption("허가")
                                        //    .IsBand(true);
                                        //columns.Add()
                                        //    .DataType(GridColumnDataType.Number)
                                        //    .DataField("workguide_min_permit")
                                        //    .Caption("허가min")
                                        //    .OwnerBand(6);
                                        //columns.Add()
                                        //    .DataType(GridColumnDataType.Number)
                                        //    .DataField("workguide_max_permit")
                                        //    .Caption("허가max")
                                        //    .OwnerBand(6);

                                        columns.Add()
                                            .Caption("기계(설비)")
                                            .IsBand(true);
                                        columns.Add()
                                            .DataField("equip_cd")
                                            .Caption("기계코드")
                                            .OwnerBand(6);
                                        //                                    .CellTemplate(new JS("BomCellWithButton"));
                                        columns.Add()
                                            .AllowEditing(false)
                                            .DataField("equip_nm")
                                            .Caption("기계명")
                                            .OwnerBand(6);

                                        columns.Add()
                                            .Caption("원자재")
                                            .IsBand(true);
                                        columns.Add()
                                            .DataField("workguide_sub_item")
                                            .Caption("원자재코드")
                                            .OwnerBand(9);
                                        //                                    .CellTemplate(new JS("BomCellWithButton"));
                                        columns.Add()
                                            .AllowEditing(false)
                                            .DataField("workguide_sub_item_nm")
                                            .Caption("원자재명")
                                            .OwnerBand(9);

                                        columns.Add()
                                            .Caption("점검항목")
                                            .DataField("check_proc")
                                            .DataType(GridColumnDataType.Boolean)
                                            //.CalculateCellValue(@"function(rowData) { return (rowData.proc_rep_yn == ""Y"" || rowData.proc_rep_yn == true); }");
                                            .CalculateCellValue(@"function(rowData) {
                                                var check = false;
                                                if(rowData.check_proc == ""Y"" || rowData.check_proc == true) {
                                                    check = true;
                                                }else {
                                                    check = false;
                                                }

                                                return check;
                                            }");

                                        columns.Add()
                                            .Visible(false)
                                            .DataField("workguide_es_yn")
                                            .Caption("전자서명필요");
                                        columns.Add()
                                            .Visible(false)
                                            .DataField("workguide_unnecessary_yn")
                                            .Caption("N/A처리가능");
                                        columns.Add()
                                            .Visible(false)
                                            .DataField("decimal_cnt")
                                            .Caption("소수점자리수");
                                        columns.Add()
                                            .Visible(false)
                                            .DataField("workguide_id")
                                            .Caption("작업방법id");
                                    })
                                    .OnInitNewRow(pagePrefix + "initItemWorkguideSeq")
                                    .OnRowInserted(pagePrefix + "ItemWorkGuideInsert")
                                    .OnRowUpdated(pagePrefix + "ItemWorkGuideUpdate")
                                    .OnRowRemoved(pagePrefix + "ItemWorkGuideDelete")
                                    .OnCellClick(pagePrefix + "ItemWorkGuideInfo")
                                    .OnToolbarPreparing("HideToolbarButton")
                                )
                        </div>
                        <div class="pl-2">
                            <button class="btn btn-secondary" onclick="@(pagePrefix)ItemBOMWorkGuideAdd()">원료투입</button>
                            @*<label class="mr-2"></label>
                                <input type="checkbox" name="@(pagePrefix)workguide_es_yn" class="checkbox" onchange="@(pagePrefix)changeGridVal()" />
                                <label>전자서명 필요</label>
                                <label class="mr-2"></label>
                                <input type="checkbox" name="@(pagePrefix)workguide_unnecessary_yn" class="checkbox" onchange="@(pagePrefix)changeGridVal()" />
                                <label>N/A처리 가능</label>
                                <label class="mr-2"></label>
                                <label>소수점자리수</label>
                                <input type="number" name="@(pagePrefix)decimal_cnt" min="0" size="2" style="width:35px" onchange="@(pagePrefix)changeGridVal()" />*@
                        </div>

                    </div>
                </div>

            </div>

        </div>

    </div>

</div>